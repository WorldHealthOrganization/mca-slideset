---
title: "MCA slides"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
  word_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE, eval=TRUE}

## run the set up chunk first, then run the relevant chunk
## each slide in the slideset (that comes from this code), has the figure name in the slide notes so you can search it to find the relevant chunk

knitr::opts_chunk$set(echo = F, warning = F, message = F)

#renv::restore()
source("requirements.R")
library(lubridate)

# country/area list from xmart: https://extranet.who.int/xmart4/REFMART/data/REF_COUNTRY
xmart_refCountry <- fromJSON("https://xmart-api-public.who.int/REFMART/REF_COUNTRY")
# INDICATOR_FK,YEAR_FK,ValueNumeric,COUNTRY_FK ValueLow ValueHigh ValueStdDev ValueStdErr Comments COUNTRY_FK__CODE DatasourceLong RESIDENCEAREA_FK__CODE SEX_FK WEALTHQUINTILE_FK

ref_country <- as.data.frame(xmart_refCountry$value)
ref_country_members <- ref_country %>% filter(WHO_LEGAL_STATUS == "M")

# saveRDS(ref_country, "data/ref_country.rds")
# ref_country <- read_rds("data/ref_country.rds")

ref_country$region <- case_when(
  ref_country$GRP_WHO_REGION == "AFR" ~ "African Region",
  ref_country$GRP_WHO_REGION == "AMR" ~ "Region of the Americas",
  ref_country$GRP_WHO_REGION == "SEAR" ~ "South-East Asian Region",
  ref_country$GRP_WHO_REGION == "EUR" ~ "European Region",
  ref_country$GRP_WHO_REGION == "EMR" ~ "Eastern Mediterranean Region",
  ref_country$GRP_WHO_REGION == "WPR" ~ "Western Pacific Region"
)

```

```{r newborn-mort-2021}
# unigme estimates from 2022 for 2021
# files from : https://childmortality.org/#datasets (need to concatenate the age group and estimate tame (lower,med,upper) in excel before importing e.g. U5MR_lower, =CONCAT(C15,"_lower"))

mort_rates_2023 <- read_excel("data/external/UNIGME-2023-SDGRegion-Rates-Deaths-Under-five.xlsx", skip = 15) %>%
  pivot_longer(cols = c(3:26)) %>%
  separate(name, c("age", "measure"), sep = "_") %>%
  pivot_wider(names_from = measure) %>%
  mutate(statistic = case_when(str_detect(age, "MR") ~ "rate", str_detect(age, "Deaths") ~ "deaths"))

# # for arcgis
# arcgis_mort_rates_2021 <- read.csv("data/external/UNIGME-2021-Country-Rates-Deaths-Under-five_reshape.csv") %>%
#   filter(year == 2020) %>%
#   dplyr::select(ISO.Code, year, age, Median_rate) %>%
#   filter(age == "neonatal" | age == "under_five") %>%
#   pivot_wider(names_from = age, values_from = Median_rate)
# 
# # write.csv(arcgis_mort_rates_2021, "ArcGIS/unigme_2021_mortrates.csv", row.names = F)

years <- c(1990, 1995, 2000, 2005, 2010, 2015, 2020,2022)
years_labs <- c("1990", "1995", "2000", "2005", "2010", "2015", "'20","'22")

# plot parts
rate_line <- geom_line(aes(y = median, colour = age), size = 1.5)
deaths_line <- geom_line(aes(y = median / 1000000, colour = age), size = 1.5)
ribbon <- geom_ribbon(aes(ymin = lower, ymax = upper, fill = age), alpha = 0.4)
xscale <- scale_x_continuous(breaks = years)
yscale_rate <- scale_y_continuous(breaks = seq(from = 0, to = 100, by = 25), limits = c(0, 100), expand = c(0, 0))
yscale_deaths <- scale_y_continuous(breaks = seq(from = 0, to = 15, by = 5), limits = c(0, 15), expand = c(0, 0))
colour_rate <- scale_colour_manual(breaks = c("NMR", "IMR", "CMR", "U5MR"), labels = c("Neonatal mortality rate\n(first 28 days)", "Infant mortality rate\n(0-11 months)", "Child mortality rate\n(age 1-4)", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#93aacd", "#5074b1"))
fill_rate <- scale_fill_manual(breaks = c("NMR", "IMR", "CMR", "U5MR"), labels = c("Neonatal mortality rate\n(first 28 days)", "Infant mortality rate\n(0-11 months)", "Child mortality rate\n(age 1-4)", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#93aacd", "#5074b1"))
theme <- theme(legend.position = "bottom", text = element_text(size = 16), legend.text = element_text(size = 11.5))
labs_rate <- labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL)
labs_deaths <- labs(x = NULL, y = "Deaths (in millions)", fill = NULL, colour = NULL)
colour_deaths <- scale_colour_manual(breaks = c("Neonatal Deaths", "Infant Deaths", "Child Deaths aged 1 to 4", "Under-five Deaths"), labels = c("Neonatal deaths\n(first 28 days)", "Infant deaths\n(0-11 months)", "Child deaths\n(age 1-4)", "Under-five deaths"), values = c("#a06265", "#cf9e9e", "#93aacd", "#5074b1"))
fill_deaths <- scale_fill_manual(breaks = c("Neonatal Deaths", "Infant Deaths", "Child Deaths aged 1 to 4", "Under-five Deaths"), labels = c("Neonatal deaths\n(first 28 days)", "Infant deaths\n(0-11 months)", "Child deaths\n(age 1-4)", "Under-five deaths"), values = c("#a06265", "#cf9e9e", "#93aacd", "#5074b1"))
# values =  c('#66c2a5','#fc8d62','#8da0cb','#e78ac3'))+
dim2 <- guides(fill = guide_legend(nrow = 2, byrow = TRUE), colour = guide_legend(nrow = 2, byrow = TRUE))
size_deaths <- scale_size_continuous(range = c(9, 15), guide = F, limits = c(1.0 * 1000000, 13.0 * 1000000))

##
## all rates

dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate"), aes(x = Year, y = median, fill = age)) +
  theme_classic() +
  rate_line +
  ribbon +
  xscale +
  yscale_rate +
  fill_rate +
  colour_rate +
  theme +
  labs_rate +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(Year %in% years), aes(label = sprintf("%1.0f", median), vjust = -.2, colour = age, y = upper), show.legend = F, fontface = "bold", size = 4.5) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL)
dim1

# ggsave("figures/2023unigme_rates_nmr_imr_cmr_u5mr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2 + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_rates_nmr_imr_cmr_u5mr_dim2.png", width=5, height=5, units="in")


## all deaths

dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths"), aes(x = Year, y = median / 1000000, fill = age)) +
  theme_classic() +
  deaths_line +
  xscale +
  scale_y_continuous(breaks = seq(from = 0, to = 15, by = 5), limits = c(0, 16), expand = c(0, 0))+
  fill_deaths +
  colour_deaths +
  theme +
  labs_deaths +
  size_deaths +
  geom_point(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(Year %in% years), aes(colour = age, size = median), shape = 21) +
  geom_point(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths" & median>12831684) %>% filter(Year %in% years), aes(colour = age, size = median-232000), shape = 21) +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(Year %in% years), aes(label = sprintf("%1.1f", median / 1000000)), colour = "white", show.legend = "none", fontface = "bold", shape = 21, size = 4.5) +
  labs(x = NULL, y = "Deaths (in millions)", fill = NULL, colour = NULL)
dim1

# ggsave("figures/2023unigme_deaths_nmr_imr_cmr_u5mr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2 + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_deaths_nmr_imr_cmr_u5mr_dim2.png", width=5, height=5, units="in")


## neonatal only ##
# rates

dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(age == "NMR"), aes(x = Year, y = median, fill = age)) +
  theme_classic() +
  rate_line +
  ribbon +
  xscale +
  yscale_rate +
  fill_rate +
  colour_rate +
  theme +
  labs_rate +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(age == "NMR") %>% filter(Year %in% years), aes(label = sprintf("%1.0f", median), vjust = -.2, colour = age, y = upper), show.legend = F, fontface = "bold", size = 4.5) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL)
dim1

# ggsave("figures/2023unigme_rates_nmr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2  + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_rates_nmr_dim2.png", width=5, height=5, units="in")


# deaths

dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths"), aes(x = Year, y = median / 1000000, fill = age)) +
  theme_classic() +
  deaths_line +
  xscale +
  yscale_deaths +
  fill_deaths +
  colour_deaths +
  theme +
  labs_deaths +
  size_deaths +
  geom_point(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths") %>% filter(Year %in% years), aes(colour = age, size = median), shape = 21) +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths") %>% filter(Year %in% years), aes(label = sprintf("%1.1f", median / 1000000)), colour = "white", show.legend = F, fontface = "bold", shape = 21, size = 4.5) +
  labs(x = NULL, y = "Deaths (in millions)", fill = NULL, colour = NULL)
dim1

# ggsave("figures/2023unigme_deaths_nmr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2 + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_deaths_nmr_dim2.png", width=5, height=5, units="in")


## nmr plus infant ##
# rates

dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(age == "NMR" | age == "IMR"), aes(x = Year, y = median, fill = age)) +
  theme_classic() +
  rate_line +
  ribbon +
  xscale +
  yscale_rate +
  fill_rate +
  colour_rate +
  theme +
  labs_rate +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(age == "NMR" | age == "IMR") %>% filter(Year %in% years), aes(label = sprintf("%1.0f", median), vjust = -.2, colour = age, y = upper), show.legend = F, fontface = "bold", size = 4.5) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL)
dim1

# ggsave("figures/2023unigme_rates_nmr_imr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2 + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_rates_nmr_imr_dim2.png", width=5, height=5, units="in")


# deaths

dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths" | age == "Infant Deaths"), aes(x = Year, y = median / 1000000, fill = age)) +
  theme_classic() +
  deaths_line +
  xscale +
  yscale_deaths +
  fill_deaths +
  colour_deaths +
  theme +
  labs_deaths +
  size_deaths +
  geom_point(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths" | age == "Infant Deaths") %>% filter(Year %in% years), aes(colour = age, size = median), shape = 21) +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths" | age == "Infant Deaths") %>% filter(Year %in% years), aes(label = sprintf("%1.1f", median / 1000000)), colour = "white", show.legend = F, fontface = "bold", shape = 21, size = 4.5) +
  labs(x = NULL, y = "Deaths (in millions)", fill = NULL, colour = NULL)
dim1

# ggsave("figures/2023unigme_deaths_nmr_imr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2  + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_deaths_nmr_imr_dim2.png", width=5, height=5, units="in")


## neonatal, infant, child
# rates

dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(age == "NMR" | age == "IMR" | age == "CMR"), aes(x = Year, y = median, fill = age)) +
  theme_classic() +
  rate_line +
  ribbon +
  xscale +
  yscale_rate +
  fill_rate +
  colour_rate +
  theme +
  labs_rate +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(age == "NMR" | age == "IMR" | age == "CMR") %>% filter(Year %in% years), aes(label = sprintf("%1.0f", median), vjust = -.2, colour = age, y = upper), show.legend = F, fontface = "bold", size = 4.5)
dim1

# ggsave("figures/2023unigme_rates_nmr_imr_cmr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2 + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_rates_nmr_imr_cmr_dim2.png", width=5, height=5, units="in")




## neonatal, infant, child, u5
# rates

dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(age == "NMR" | age == "IMR" | age == "CMR" | age == "U5MR"), aes(x = Year, y = median, fill = age)) +
  theme_classic() +
  rate_line +
  ribbon +
  xscale +
  yscale_rate +
  fill_rate +
  colour_rate +
  theme +
  labs_rate +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(age == "NMR" | age == "IMR" | age == "CMR" | age == "U5MR") %>% filter(Year %in% years), aes(label = sprintf("%1.0f", median), vjust = -.2, colour = age, y = upper), show.legend = F, fontface = "bold", size = 4.5)
dim1

# ggsave("figures/2023unigme_rates_nmr_imr_cmr_u5mr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2 + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_rates_nmr_imr_cmr_u5mr_dim2.png", width=5, height=5, units="in")





# deaths

dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths" | age == "Infant Deaths" | age == "Child Deaths aged 1 to 4"), aes(x = Year, y = median / 1000000, fill = age)) +
  theme_classic() +
  deaths_line +
  xscale +
  yscale_deaths +
  fill_deaths +
  colour_deaths +
  theme +
  labs_deaths +
  size_deaths +
  geom_point(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths" | age == "Infant Deaths" | age == "Child Deaths aged 1 to 4") %>% filter(Year %in% years), aes(colour = age, size = median), shape = 21) +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths" | age == "Infant Deaths" | age == "Child Deaths aged 1 to 4") %>% filter(Year %in% years), aes(label = sprintf("%1.1f", median / 1000000)), colour = "white", show.legend = F, fontface = "bold", shape = 21, size = 4.5) +
  labs(x = NULL, y = "Deaths (in millions)", fill = NULL, colour = NULL)
dim1

# ggsave("figures/2023unigme_deaths_nmr_imr_cmr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2  + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_deaths_nmr_imr_cmr_dim2.png", width=5, height=5, units="in")



dim1 <- ggplot(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths" | age == "Infant Deaths" | age == "Child Deaths aged 1 to 4" | age == "Under-five Deaths"), aes(x = Year, y = median / 1000000, fill = age)) +
  theme_classic() +
  deaths_line +
  xscale +
  yscale_deaths +
  fill_deaths +
  colour_deaths +
  theme +
  labs_deaths +
  size_deaths +
  geom_point(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths" | age == "Infant Deaths" | age == "Child Deaths aged 1 to 4" | age == "Under-five Deaths") %>% filter(Year %in% years), aes(colour = age, size = median), shape = 21) +
  geom_text(data = mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "deaths") %>% filter(age == "Neonatal Deaths" | age == "Infant Deaths" | age == "Child Deaths aged 1 to 4" | age == "Under-five Deaths") %>% filter(Year %in% years), aes(label = sprintf("%1.1f", median / 1000000)), colour = "white", show.legend = F, fontface = "bold", shape = 21, size = 4.5) +
  labs(x = NULL, y = "Deaths (in millions)", fill = NULL, colour = NULL)
dim1

# ggsave("figures/2023unigme_deaths_nmr_imr_cmr_u5mr_dim1.png", width=9, height=5, units="in")

dim1 +
  dim2  + scale_x_continuous(breaks = years, labels = years_labs)

# ggsave("figures/2023unigme_deaths_nmr_imr_cmr_u5mr_dim2.png", width=5, height=5, units="in")








```

```{r stillbirth_nmr}

# data from unicef data warehouse

stillbirth_rates <- read_excel("data/external/Stillbirth-rate-and-deaths_2023.xlsx", 
    sheet = "SBR Regional estimates", skip = 15, n_max = 36) %>% pivot_longer(cols = c(3:24), names_to = "Year", values_to = "rate") %>% pivot_wider(id_cols = c("Region.Name", "Year"), names_from = "Uncertainty.Bounds*", values_from = rate) %>% rename(Region="Region.Name", lower=Lower, upper=Upper, median=Median) %>% mutate(age="Stillbirth rate\nDeaths per 1,000 total births") %>% mutate(Year=as.numeric(substr(Year, start=1, stop=4)))

nmr <-  mort_rates_2023 %>% filter(Region == "World") %>% filter(statistic == "rate") %>% filter(age == "NMR") %>% select("Region", "Year", "lower", "median", "upper", "age") %>% mutate(age="Neonatal mortality rate\nDeaths per 1,000 live births")

stillbirth_nmr <- rbind(stillbirth_rates %>% filter(Region=="World"), nmr)


  ggplot(data = stillbirth_nmr %>% filter(Year>=2000), aes(x = Year, y = median, fill = age)) +
  theme_classic() +
  geom_line(aes(y = median, colour = age), size = 1.5) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = age), alpha = 0.4) +
  scale_x_continuous(breaks = c(2000,2005,2010,2015,2020,2022), limits = c(2000,2023), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(from = 0, to = 40, by = 10), limits = c(0, 35), expand = c(0, 0)) +
  #fill_rate +
 # scale_colour_manual(breaks = c("NMR", "Stillbirth"), labels = c("Neonatal mortality rate\nDeaths per 1,000 live births", "Stillbirth rate\nDeaths per 1,000 total births"), values = c("#F8766D", "#00BFC4")) +
  theme(legend.position = "bottom", text = element_text(size = 16), legend.text = element_text(size = 11.5)) +
  labs(x = NULL, y = NULL, fill = NULL, colour = NULL) +
  geom_text(data = stillbirth_nmr %>% filter(Year %in% c(2005,2010,2015,2020,2022)), aes(label = sprintf("%1.0f", median), vjust = -.2, colour = age, y = upper), show.legend = F, fontface = "bold", size = 4.5) +
  geom_text(data = stillbirth_nmr %>% filter(Year %in% c(2000)), aes(label = sprintf("%1.0f", median), vjust = -.2, hjust=-.001, colour = age, y = upper), show.legend = F, fontface = "bold", size = 4.5)+
    geom_hline(yintercept = 12, linetype="dashed")+
    geom_text(label="Target", x=2001.5, y=13)

  
# ggsave("figures/nmr_stillbirth.png", width=6, height=5, units="in")
# ggsave("figures/nmr_stillbirth.png", width=9, height=5, units="in")

  ggplot(data = stillbirth_nmr %>% filter(Year>=2000), aes(x = Year, y = median, fill = age)) +
  theme_classic() +
  geom_line(aes(y = median, colour = age), size = 1.5) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = age), alpha = 0.4) +
  scale_x_continuous(breaks = c(2000,2005,2010,2015,2020,2022), limits = c(2000,2023), expand = c(0,0)) +
  scale_y_continuous(breaks = seq(from = 0, to = 40, by = 10), limits = c(0, 35), expand = c(0, 0)) +
  #fill_rate +
 # scale_colour_manual(breaks = c("NMR", "Stillbirth"), labels = c("Neonatal mortality rate\nDeaths per 1,000 live births", "Stillbirth rate\nDeaths per 1,000 total births"), values = c("#F8766D", "#00BFC4")) +
  theme(legend.position = "bottom", text = element_text(size = 16), legend.text = element_text(size = 11.5)) +
  labs(x = NULL, y = NULL, fill = NULL, colour = NULL) +
    geom_hline(yintercept = 12, linetype="dashed")+
    geom_text(label="Target", x=2001.5, y=13)

  # ggsave("figures/nmr_stillbirth_nolab.png", width=6, height=5, units="in")

## annual rate reduction
  
arrs <- read_excel("data/external/arr_estimates.xlsx")%>% mutate(x=paste0(Observed, "\n", time)) %>% mutate(group=factor(group, levels=c("Maternal", "Stillbirth", "Neonatal"), labels=c("Maternal mortality ratio", "Stillbirth rate", "Neonatal mortality rate")))

install.packages("remotes")
remotes::install_github("coolbutuseless/ggpattern")
library(ggpattern)

ggplot(data=arrs , aes(x=x, y=value, pattern_fill=Observed, fill=group)) +
  theme_classic()+
  geom_bar(stat = "identity", width = .7)+
  geom_errorbar(aes(x=x, ymin=lower, ymax=upper), width=0.2, alpha=.5, size=.4)+
  geom_col_pattern(data=arrs %>% filter(Observed=="Required"), pattern= "circle",  pattern_fill="grey40", pattern_colour="grey40", width = .7)+
  facet_grid(~group, scales="free")+
  geom_text(aes(label=value, vjust=-.5, hjust=-0), fontface="bold")+
  guides(fill="none")+
  scale_fill_manual(values=c("#FEC45C", "#BF6CAC", "#59ACA7"))+
  scale_y_continuous(limits=c(0,13), expand = c(0,0), breaks = c(0,2,5,8,12) )+
  labs(x=NULL, y="Annual rate of reduction (per cent)")+
  theme(strip.background =  element_rect(color = "white"), strip.text=element_text(face="bold"),  text = element_text(size = 16))

 #  ggsave("figures/reductions_obs_req.png", width=9, height=5, units="in")



```

```{r newborn-mort-igme21-regional}

# data from mca portal 

# mort_reg <- read_excel("data/external/Data 2023-05-28 14-22.xlsx", sheet="Data") %>% rename("ValueNumeric"=`Value Numeric`, "lower"=`Value low`, "upper"=`Value high`) %>% filter(`WHO region` != "Global")

# data not on gho yet, advance copy from gerard 

mort_reg <- read_csv("data/UNIGME2023.GHO.2024-04-29.KIM.csv") %>% rename("ValueNumeric"=`Numeric`, "lower"=`Low`, "upper"=`High`) %>% filter(REGION != "GLOBAL") %>% filter(Indicator %in% c("Neonatal mortality rate", "Infant mortality rate", "Under-five mortality rate")) %>% filter(SEX=="BTSX") %>% mutate(REGION=case_when(
  REGION == "AFR" ~ "African Region",
  REGION == "AMR" ~ "Region of the Americas",
  REGION == "SEAR" ~ "South-East Asian Region",
  REGION == "EUR" ~ "European Region",
  REGION == "EMR" ~ "Eastern Mediterranean Region",
  REGION == "WPR" ~ "Western Pacific Region"
)) %>% 
  filter(is.na(COUNTRY))


ggplot(data = mort_reg, aes(x = as.numeric(YEAR), y = ValueNumeric, fill = Indicator)) +
  theme_classic() +
  geom_line(aes(y = ValueNumeric, colour = Indicator), size = .5) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = Indicator), alpha = 0.4) +
  scale_y_continuous(breaks = seq(from = 0, to = 200, by = 25), limits = c(0, 200), expand = c(0, 0)) +
  scale_colour_manual(breaks = c("Neonatal mortality rate", "Infant mortality rate", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#5074b1"))+
 scale_fill_manual(breaks = c("Neonatal mortality rate", "Infant mortality rate", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#5074b1"))+
 theme(legend.position = "bottom", text = element_text(size = 12), legend.text = element_text(size = 10)) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  facet_wrap(~REGION)+
    geom_text(data = mort_reg %>% filter(YEAR == 1990) , aes(label = sprintf("%1.0f", ValueNumeric), hjust = .6, colour = Indicator, y = ValueNumeric, x = 1989), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_reg %>% filter(((REGION == "Africa" | REGION == "Eastern Mediterranean" | REGION == "South-East Asia") | Indicator == "Neonatal mortality rate" | Indicator == "Under-five mortality rate")) %>% filter(YEAR == 2022), aes(label = sprintf("%1.0f", ValueNumeric), colour = Indicator, y = ValueNumeric, x = 2023), show.legend = F, fontface = "bold", size = 2.5) +
  guides(fill = guide_legend(ncol = 1), colour = guide_legend(ncol = 1)) 

# ggsave("figures/nmr_imr_u5mr_trendsTo2022.png", width=9, height=5, units="in")


ggplot(data = mort_reg %>% filter(Indicator=="Neonatal mortality rate"), aes(x = as.numeric(YEAR), y = ValueNumeric, fill = Indicator)) +
  theme_classic() +
  geom_line(aes(y = ValueNumeric, colour = Indicator), size = .5) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = Indicator), alpha = 0.4) +
 # scale_x_continuous(breaks = Year) +
  scale_y_continuous(breaks = seq(from = 0, to = 200, by = 25), limits = c(0, 200), expand = c(0, 0)) +
  scale_colour_manual(breaks = c("Neonatal mortality rate", "Infant mortality rate", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#5074b1"))+
 scale_fill_manual(breaks = c("Neonatal mortality rate", "Infant mortality rate", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#5074b1"))+
 theme(legend.position = "bottom", text = element_text(size = 12), legend.text = element_text(size = 10)) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  facet_wrap(~REGION)+
    geom_text(data = mort_reg %>% filter(YEAR == 1990 & Indicator == "Neonatal mortality rate") , aes(label = sprintf("%1.0f", ValueNumeric), hjust = .6, colour = Indicator, y = ValueNumeric, x = 1989), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_reg %>% filter(YEAR == 2022 & Indicator == "Neonatal mortality rate"), aes(label = sprintf("%1.0f", ValueNumeric), colour = Indicator, y = ValueNumeric, x = 2023), show.legend = F, fontface = "bold", size = 2.5) 

# ggsave("figures/nmr_trendsTo2022.png", width=9, height=5, units="in")

ggplot(data = mort_reg %>% filter(Indicator=="Infant mortality rate"), aes(x = as.numeric(YEAR), y = ValueNumeric, fill = Indicator)) +
  theme_classic() +
  geom_line(aes(y = ValueNumeric, colour = Indicator), size = .5) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = Indicator), alpha = 0.4) +
 # scale_x_continuous(breaks = Year) +
  scale_y_continuous(breaks = seq(from = 0, to = 200, by = 25), limits = c(0, 200), expand = c(0, 0)) +
  scale_colour_manual(breaks = c("Neonatal mortality rate", "Infant mortality rate", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#5074b1"))+
 scale_fill_manual(breaks = c("Neonatal mortality rate", "Infant mortality rate", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#5074b1"))+
 theme(legend.position = "bottom", text = element_text(size = 12), legend.text = element_text(size = 10)) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  facet_wrap(~REGION)+
    geom_text(data = mort_reg %>% filter(YEAR == 1990 & Indicator == "Infant mortality rate") , aes(label = sprintf("%1.0f", ValueNumeric), hjust = .6, colour = Indicator, y = ValueNumeric, x = 1989), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_reg %>% filter(YEAR == 2022 & Indicator == "Infant mortality rate"), aes(label = sprintf("%1.0f", ValueNumeric), colour = Indicator, y = ValueNumeric, x = 2023), show.legend = F, fontface = "bold", size = 2.5) 

# ggsave("figures/imr_trendsTo2022.png", width=9, height=5, units="in")

ggplot(data = mort_reg %>% filter(Indicator=="Under-five mortality rate"), aes(x = as.numeric(YEAR), y = ValueNumeric, fill = Indicator)) +
  theme_classic() +
  geom_line(aes(y = ValueNumeric, colour = Indicator), size = .5) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = Indicator), alpha = 0.4) +
 # scale_x_continuous(breaks = Year) +
  scale_y_continuous(breaks = seq(from = 0, to = 200, by = 25), limits = c(0, 200), expand = c(0, 0)) +
  scale_colour_manual(breaks = c("Neonatal mortality rate", "Infant mortality rate", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#5074b1"))+
 scale_fill_manual(breaks = c("Neonatal mortality rate", "Infant mortality rate", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#5074b1"))+
 theme(legend.position = "bottom", text = element_text(size = 12), legend.text = element_text(size = 10)) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  facet_wrap(~REGION)+
    geom_text(data = mort_reg %>% filter(YEAR == 1990 & Indicator == "Under-five mortality rate") , aes(label = sprintf("%1.0f", ValueNumeric), hjust = .6, colour = Indicator, y = ValueNumeric, x = 1989), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_reg %>% filter(YEAR == 2022 & Indicator == "Under-five mortality rate"), aes(label = sprintf("%1.0f", ValueNumeric), colour = Indicator, y = ValueNumeric, x = 2023), show.legend = F, fontface = "bold", size = 2.5) 

# ggsave("figures/iu5r_trendsTo2022.png", width=9, height=5, units="in")



# unigme estimates from 2021 with WHO regions (from Gerard email 18 jan 2022)

mort_rates_2021_region <- read_excel("data/external/UNIGME_data_for_WHO_2021.xlsx", sheet = "UNIGME_WHOregion", skip = 7) %>%
  mutate(year_round = floor(as.numeric(Year))) %>%
  rename_all(tolower) %>%
  mutate(statistic = case_when(str_detect(indicator, "rate") ~ "rate", str_detect(indicator, "deaths") ~ "deaths", str_detect(indicator, "Deaths") ~ "deaths")) %>%
  filter(sex == "Total" & region != "World") %>%
  filter(shortind %in% c("NMR", "IMR", "CMR", "U5MR", "Neonatal.deaths", "Infant.deaths", "Child.deaths.age1to4", "Under.five.deaths"))

years <- c(1990, 1995, 2000, 2005, 2010, 2015, 2020)

# plot parts
rate_line <- geom_line(aes(y = median, colour = shortind), size = .5)
deaths_line <- geom_line(aes(y = median / 1000000, colour = shortind), size = 1.5)
ribbon <- geom_ribbon(aes(ymin = lower, ymax = upper, fill = shortind), alpha = 0.4)
xscale <- scale_x_continuous(breaks = years)
yscale_rate <- scale_y_continuous(breaks = seq(from = 0, to = 200, by = 25), limits = c(0, 200), expand = c(0, 0))
yscale_deaths <- scale_y_continuous(breaks = seq(from = 0, to = 5, by = 5), limits = c(0, 5), expand = c(0, 0))
colour_rate <- scale_colour_manual(breaks = c("NMR", "IMR", "CMR", "U5MR"), labels = c("Neonatal mortality rate\n(first 28 days)", "Infant mortality rate\n(0-11 months)", "Child mortality rate\n(age 1-4)", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#93aacd", "#5074b1"))
fill_rate <- scale_fill_manual(breaks = c("NMR", "IMR", "CMR", "U5MR"), labels = c("Neonatal mortality rate\n(first 28 days)", "Infant mortality rate\n(0-11 months)", "Child mortality rate\n(age 1-4)", "Under-five mortality rate"), values = c("#a06265", "#cf9e9e", "#93aacd", "#5074b1"))
theme <- theme(legend.position = "bottom", text = element_text(size = 12), legend.text = element_text(size = 10))
labs_rate <- labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL)
labs_deaths <- labs(x = NULL, y = "Deaths (in millions)", fill = NULL, colour = NULL)
colour_deaths <- scale_colour_manual(breaks = c("Neonatal.deaths", "Infant.deaths", "Child.deaths.age1to4", "Under.five.deaths"), labels = c("Neonatal deaths\n(first 28 days)", "Infant deaths\n(0-11 months)", "Child deaths\n(age 1-4)", "Under-five deaths"), values = c("#a06265", "#cf9e9e", "#93aacd", "#5074b1"))
fill_deaths <- scale_fill_manual(breaks = c("Neonatal.deaths", "Infant.deaths", "Child.deaths.age1to4", "Under.five.deaths"), labels = c("Neonatal deaths\n(first 28 days)", "Infant deaths\n(0-11 months)", "Child deaths\n(age 1-4)", "Under-five deaths"), values = c("#a06265", "#cf9e9e", "#93aacd", "#5074b1"))
# values =  c('#66c2a5','#fc8d62','#8da0cb','#e78ac3'))+
dim2 <- guides(fill = guide_legend(nrow = 2, byrow = TRUE), colour = guide_legend(nrow = 2, byrow = TRUE))

reg_labs <- c(
  "Africa" = "African Region",
  "Americas" = "Region of the Americas",
  "South-East Asia" = "South-East Asian Region",
  "Europe" = "European Region",
  "Eastern Mediterranean" = "Eastern Mediterranean Region",
  "Western Pacific" = "Western Pacific Region"
)

##

## all rates

ggplot(data = mort_rates_2021_region %>% filter(statistic == "rate"), aes(x = year_round, y = median, fill = shortind)) +
  theme_classic() +
  rate_line +
  ribbon +
  xscale +
  yscale_rate +
  fill_rate +
  colour_rate +
  theme +
  labs_rate +
  geom_text(data = mort_rates_2021_region %>% filter((region == "Europe" & shortind != "U5MR") | region != "Europe") %>% filter(year_round == 1990) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), hjust = .6, colour = shortind, y = median, x = 1989), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(region == "Europe" & shortind == "U5MR") %>% filter(year_round == 1990) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), hjust = .6, colour = shortind, y = median + 3, x = 1989), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(region == "Eastern Mediterranean" | (region == "South-East Asia" & shortind != "IMR")) %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter((region == "Americas" | region == "Western Pacific") & (shortind == "NMR")) %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter((region == "Americas" | region == "Western Pacific") & (shortind == "U5MR")) %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median + 4, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(region == "Europe" & shortind == "U5MR") %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(region == "Africa" & shortind != "CMR") %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median + 2, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(region == "Africa" & shortind == "CMR") %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = lower - 1, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = as_labeller(reg_labs))

# ggsave("figures/2021unigme_rates_Regions_nmr_imr_cmr_u5mr.png", width=9, height=5, units="in")


# nmr

ggplot(data = mort_rates_2021_region %>% filter(shortind == "NMR"), aes(x = year_round, y = median, fill = shortind)) +
  theme_classic() +
  rate_line +
  ribbon +
  xscale +
  yscale_rate +
  fill_rate +
  colour_rate +
  theme +
  labs_rate +
  geom_text(data = mort_rates_2021_region %>% filter(shortind == "NMR") %>% filter(year_round == 1990) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median, x = 1989), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(shortind == "NMR" & region != "Europe") %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  geom_text(data = mort_rates_2021_region %>% filter(shortind == "NMR" & region == "Europe") %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median + 2, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = as_labeller(reg_labs))

# ggsave("figures/2021unigme_rates_Regions_nmr.png", width=9, height=5, units="in")

# nmr + imr


ggplot(data = mort_rates_2021_region %>% filter(shortind == "NMR" | shortind == "IMR"), aes(x = year_round, y = median, fill = shortind)) +
  theme_classic() +
  rate_line +
  ribbon +
  xscale +
  yscale_rate +
  fill_rate +
  colour_rate +
  theme +
  labs_rate +
  geom_text(data = mort_rates_2021_region %>% filter(shortind == "NMR" | shortind == "IMR") %>% filter(year_round == 1990) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), hjust = .6, colour = shortind, y = median, x = 1989), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(region == "Europe" & shortind == "NMR") %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), hjust = .6, colour = shortind, y = median + 2, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(shortind == "NMR" | shortind == "IMR") %>% filter(region == "Eastern Mediterranean" | (region == "South-East Asia" & shortind != "IMR")) %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(shortind == "NMR" | shortind == "IMR") %>% filter((region == "Americas" | region == "Western Pacific") & (shortind == "NMR")) %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(region == "Africa" & (shortind == "NMR" | shortind == "IMR")) %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median + 2, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  facet_wrap(~region, labeller = as_labeller(reg_labs))

# ggsave("figures/2021unigme_rates_Regions_nmr_imr.png", width=9, height=5, units="in")

# nmr + imr + cmr

ggplot(data = mort_rates_2021_region %>% filter(shortind == "NMR" | shortind == "IMR" | shortind == "CMR"), aes(x = year_round, y = median, fill = shortind)) +
  theme_classic() +
  rate_line +
  ribbon +
  xscale +
  yscale_rate +
  fill_rate +
  colour_rate +
  theme +
  labs_rate +
  geom_text(data = mort_rates_2021_region %>% filter(shortind != "U5MR") %>% filter((region == "Europe" & shortind != "U5MR") | region != "Europe") %>% filter(year_round == 1990) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), hjust = .6, colour = shortind, y = median, x = 1989), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(shortind != "U5MR") %>% filter(region == "Eastern Mediterranean" | (region == "South-East Asia" & shortind != "IMR")) %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(shortind != "U5MR") %>% filter((region == "Americas" | region == "Western Pacific") & (shortind == "NMR")) %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(shortind != "U5MR") %>% filter(region == "Africa" & shortind != "CMR") %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = median + 2, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(shortind != "U5MR") %>% filter(region == "Africa" & shortind == "CMR") %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), colour = shortind, y = lower - 1, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  geom_text(data = mort_rates_2021_region %>% filter(region == "Europe" & shortind == "NMR") %>% filter(year_round == 2020) %>% filter(statistic == "rate") %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", median), hjust = .6, colour = shortind, y = median + 2, x = 2021), show.legend = F, fontface = "bold", size = 2.5) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = as_labeller(reg_labs))

# ggsave("figures/2021unigme_rates_Regions_nmr_imr_cmr.png", width=9, height=5, units="in")



## all deaths

ggplot(data = mort_rates_2021_region %>% filter(statistic == "deaths"), aes(x = year_round, y = median / 1000000, fill = shortind)) +
  theme_classic() +
  deaths_line +
  xscale +
  yscale_deaths +
  fill_deaths +
  colour_deaths +
  theme +
  labs_deaths +
  scale_size_continuous(range = c(0, 15), guide = F, limits = c(0, 5)) +
  geom_point(data = mort_rates_2021_region %>% filter(statistic == "deaths") %>% filter(year_round %in% years), aes(colour = shortind, size = median / 1000000), shape = 21) +
  geom_text(data = mort_rates_2021_region %>% filter(statistic == "deaths") %>% filter(year_round %in% years), aes(label = sprintf("%1.1f", median / 1000000)), colour = "white", show.legend = F, fontface = "bold", shape = 21, size = 4.5) +
  labs(x = NULL, y = "Deaths (in millions)", fill = NULL, colour = NULL) +
  facet_wrap(~region)

##

ggplot(data = mort_rates_2021_region %>% filter(statistic == "rate"), aes(x = year_round, y = median, fill = region)) +
  facet_wrap(~ factor(shortind, levels = c("NMR", "IMR", "CMR", "U5MR"), labels = c("Neonatal mortality rate", "Infant mortality rate", "Child mortality rate", "Under-five mortality rate"))) +
  theme_classic() +
  geom_line(aes(y = median, colour = region), size = .5) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = region), alpha = 0.4) +
  xscale +
  yscale_rate +
  theme +
  labs_rate

```

```{r neo-cod-mcee19}


mcee <- read_csv("data/raw/child_cod_2000_2019_reshape.csv") %>% filter(age=="neonatal" & year==2019 & level=="global" & cause_name!="All cause" & fraction>0) 

mcee$cause_name2 <- mcee$cause_name
mcee$cause_name2[mcee$cause_name=="Measles"|mcee$cause_name=="Meningitis/encephalitis"|mcee$cause_name=="Other group 1 and other noncommunicable"|mcee$cause_name=="Tuberculosis"|mcee$cause_name=="HIV/AIDS"|mcee$cause_name=="Malaria"] <- "Other neonatal causes"  
mcee$cause_name2[mcee$cause_name=="Sepsis and other infectious conditions of the newborn"] <- "Neonatal sepsis/infections"
#mcee$cause_name2[mcee$cause_name=="Congenital anomalies"] <- "Congenital"
mcee$cause_name2[mcee$cause_name=="Diarrhoeal diseases"] <- "Diarrhoea"
mcee$cause_name2[mcee$cause_name=="Birth asphyxia and birth trauma"] <- "Intrapartum related"


mcee_Pie <- mcee %>%
 # filter(!is.na(fraction) & cause_name!="HIV/AIDS" & cause_name!="Malaria" & fraction!=0) %>% 
  group_by(cause_name2) %>% 
  summarise(Percent = sum(fraction)*100, deaths=sum(deaths)) %>%
  mutate(cause_name2 = forcats::fct_reorder(cause_name2, Percent)) %>%
  arrange(-Percent) %>%
  mutate(
    end = 2 * pi * cumsum(Percent) / sum(Percent),
    start = lag(end, default = 0),
    middle = 0.5 * (start + end),
    hjust = ifelse(middle > pi, 1, 0),
    vjust = ifelse(middle < pi / 2 | middle > 3 * pi / 2, 0, 1)
  )

# ggplot(mcee_Pie) +
#   geom_arc_bar(aes(x0 = 0, y0 = 0, r0 = 0, r = 1, start = start, end = end, fill = cause_name2), colour = "white") +
#   geom_text(data=mcee_Pie %>% filter(Percent>5), aes(x = .7 *sin(middle), y =   .7 *cos(middle), label = str_wrap(paste0(cause_name2, ": ", round(Percent,0), "%"), width = 20)), size = 3, lineheight=.7, hjust = 0.5, vjust = 0.5) +
#   geom_text_repel(data=mcee_Pie %>% filter(Percent<5), aes(x =sin(middle), y =  cos(middle), label = str_wrap(paste0(cause_name2, ": ", round(Percent,1), "%"), width = 20)), size =3, lineheight=.7,  nudge_y = 2) +
#   coord_fixed() +
#   scale_x_continuous(limits = c(-1.7, 1.5), name = "", breaks = NULL, labels = NULL) +
#   scale_y_continuous(limits = c(-1, 1.1), name = "", breaks = NULL, labels = NULL) +
#   scale_fill_brewer(palette = "Set3", direction = -1) +
#   theme_void() +
#   guides(fill = F)
# 
# ggsave("figures/Neonatal_CauseDeath_pie_MCEE19.png", width = 6, height = 6)

ggplot(mcee_Pie) +
  geom_arc_bar(aes(x0 = 0, y0 = 0, r0 = 0, r = 1, start = start, end = end, fill = cause_name2), colour = "white") +
  #geom_text(data=mcee_Pie %>% filter(Percent>5), aes(x = .7 *sin(middle), y =   .7 *cos(middle), label = str_wrap(paste0(cause_name2, ": ", round(Percent,0), "%"), width = 20), hjust = hjust, vjust =vjust), size = 3, lineheight=.7) +
  #geom_text_repel(data=mcee_Pie %>% filter(Percent<5), aes(x =sin(middle), y =  cos(middle), label = str_wrap(paste0(cause_name2, ": ", round(Percent,1), "%"), width = 20)), size =3, lineheight=.7, nudge_x = 1) +
  coord_fixed() +
  scale_x_continuous(limits = c(-1.7, 1.5), name = "", breaks = NULL, labels = NULL) +
  scale_y_continuous(limits = c(-1, 1.1), name = "", breaks = NULL, labels = NULL) +
  scale_fill_brewer(palette = "Set3", direction = -1) +
  theme_void() +
  guides(fill = F)

# ggsave("figures/Neonatal_CauseDeath_pie_MCEE19_nolab.png", width = 6, height = 6)

 
 ggplot(
  mcee %>% group_by(cause_name2) %>% summarise(Percent = sum(fraction)*100) %>% mutate(cause_name2 = forcats::fct_reorder(cause_name2, Percent)) %>% mutate(ypos = cumsum(Percent) - 0.5 * Percent, csum = rev(cumsum(rev(Percent))),
         pos = Percent/2 + lead(csum, 1),
         pos = if_else(is.na(pos), Percent/2, pos)),
  aes(x = "", y = Percent, fill = cause_name2)
) +
  # scale_fill_viridis_d(direction = -1)+
  scale_fill_brewer(palette = "Set3", direction=-1) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  theme_void() +
  guides(fill = F) +
  geom_text_repel(aes(label = cause_name2, y=pos),  nudge_x = 1)
 
pie(mcee_Pie$Percent, labels = paste0(mcee_Pie$cause_name2, ", ", ifelse(mcee_Pie$Percent>5, round(mcee_Pie$Percent,0), round(mcee_Pie$Percent,1)),"%"), col = brewer.pal(9, "Set3"))
 
 
ggplot(
  mcee_Pie %>% arrange(-Percent) %>% mutate(ypos = cumsum(Percent) - 0.5 * Percent),
  aes(x = 1, y = Percent, fill = cause_name2)
) +
  scale_fill_brewer(palette = "Set3", direction = -1) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  theme_classic() +
  theme(axis.ticks = element_blank(), text = element_text(size = 14), axis.text.x = element_blank()) +
  guides(fill = F, colour = F) +
  geom_text(data= mcee_Pie %>% arrange(-Percent) %>% mutate(ypos = cumsum(Percent) - 0.5 * Percent) %>% filter(Percent>1), aes(label = paste0(str_wrap(cause_name2,35), ", ", round(Percent,0), "% (", scales::comma(round(deaths,0)), ")"), y = ypos), fontface = "bold",  size = 4.5) +
  geom_text(data= mcee_Pie %>% filter(cause_name2=="Injuries"), aes(label = paste0(cause_name2, ", ", round(Percent,1), "% (", scales::comma(round(deaths,0)), ")"), y = 99.5, x=1.51), fontface = "bold", size = 3.5, hjust=0) +  
  geom_text(data= mcee_Pie %>% filter(cause_name2=="Tetanus"), aes(label = paste0(cause_name2, ", ", round(Percent,1), "% (", scales::comma(round(deaths,0)), ")"), y = 101, x=1.51), fontface = "bold", size = 3.5, hjust=0) +  
  scale_y_continuous(labels = scales::percent_format(scale = 1), limits = c(0, 102), expand = c(0,0)) +
  labs(x = NULL)+
  scale_x_continuous(limits = c(.5,2))

# ggsave("figures/Neonatal_CauseDeath_stackBar_MCEE19.png", width=7, height=7, units="in")


```

```{r neo-cod-cacode}

# xmart <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22COD_NOD_D028NEO%22)")
# 
# neocod <- as.data.frame(xmart$value)
# 
# neocod$causegroup <- neocod$CauseGHEChild_FK
# neocod$causegroup[neocod$CauseGHEChild_FK=="Measles"|neocod$CauseGHEChild_FK=="Meningitis/encephalitis"|neocod$CauseGHEChild_FK=="Other Group 1 and Other noncommunicable (neonatal and under-5 only)" |neocod$CauseGHEChild_FK=="Tuberculosis"|neocod$CauseGHEChild_FK=="HIV/AIDS"|neocod$CauseGHEChild_FK=="Malaria"] <- "Other neonatal causes"  
# neocod$causegroup[neocod$CauseGHEChild_FK=="Sepsis and other infectious conditions of the newborn"] <- "Neonatal sepsis/infections"
# #neocod$CauseGHEChild_FK2[neocod$CauseGHEChild_FK=="Congenital anomalies"] <- "Congenital"
# neocod$causegroup[neocod$CauseGHEChild_FK=="Diarrhoeal diseases"] <- "Diarrhoea"
# neocod$causegroup[neocod$CauseGHEChild_FK=="Birth asphyxia and birth trauma"] <- "Intrapartum related"
# 
# neocod <- neocod %>% filter(YEAR_FK==2021)
# 
# neocod_pie <- neocod %>%
#  # filter(!is.na(fraction) & cause_name!="HIV/AIDS" & cause_name!="Malaria" & fraction!=0) %>% 
#   group_by(causegroup) %>% 
#   summarise(Percent = sum(fraction)*100, deaths=sum(deaths)) %>%
#   mutate(cause_name2 = forcats::fct_reorder(cause_name2, Percent)) %>%
#   arrange(-Percent) %>%
#   mutate(
#     end = 2 * pi * cumsum(Percent) / sum(Percent),
#     start = lag(end, default = 0),
#     middle = 0.5 * (start + end),
#     hjust = ifelse(middle > pi, 1, 0),
#     vjust = ifelse(middle < pi / 2 | middle > 3 * pi / 2, 0, 1)
#   )
# ggplot(mcee_Pie) +
#   geom_arc_bar(aes(x0 = 0, y0 = 0, r0 = 0, r = 1, start = start, end = end, fill = cause_name2), colour = "white") +
#   #geom_text(data=mcee_Pie %>% filter(Percent>5), aes(x = .7 *sin(middle), y =   .7 *cos(middle), label = str_wrap(paste0(cause_name2, ": ", round(Percent,0), "%"), width = 20), hjust = hjust, vjust =vjust), size = 3, lineheight=.7) +
#   #geom_text_repel(data=mcee_Pie %>% filter(Percent<5), aes(x =sin(middle), y =  cos(middle), label = str_wrap(paste0(cause_name2, ": ", round(Percent,1), "%"), width = 20)), size =3, lineheight=.7, nudge_x = 1) +
#   coord_fixed() +
#   scale_x_continuous(limits = c(-1.7, 1.5), name = "", breaks = NULL, labels = NULL) +
#   scale_y_continuous(limits = c(-1, 1.1), name = "", breaks = NULL, labels = NULL) +
#   scale_fill_brewer(palette = "Set3", direction = -1) +
#   theme_void() +
#   guides(fill = F)

# data from email from kate strong may 23 2024 

causeofdeath <- read_excel("data/Copy of cause of death for under 5 age groups_2021_23052024.xlsx")  %>% filter(Age=="DAYS0-27") %>% group_by(Cause2) %>% summarise(Deaths=sum(Deaths), Percent=sum(Percent))

 ggplot(
  causeofdeath%>%  mutate(Cause2 = forcats::fct_reorder(Cause2, Percent)) %>% mutate(ypos = cumsum(Percent) - 0.5 * Percent, csum = rev(cumsum(rev(Percent))),
         pos = Percent/2 + lead(csum, 1),
         pos = if_else(is.na(pos), Percent/2, pos)),
  aes(x = "", y = Percent, fill = Cause2)
) +
  # scale_fill_viridis_d(direction = -1)+
  scale_fill_brewer(palette = "Set3", direction=-1) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  theme_void() +
  guides(fill = F) +
  geom_text_repel(aes(label = Cause2, y=pos),  nudge_x = 1)


 
 ggplot(
  causeofdeath %>% arrange(Percent) %>% mutate(ypos = cumsum(Percent) - 0.5 * Percent) %>% mutate(Cause2 = forcats::fct_reorder(Cause2, Percent)),
  aes(x = 1, y = Percent, fill = Cause2)
) +
  scale_fill_manual(values=c("#fdb462",	"#fb8072",	"#C4A484",	"grey60",	"#8dd3c7",	"#bebada",	"#80b1d3",	"#d9d9d9",	"#fccde5"))+
  geom_bar(stat = "identity", width = 1, color = "white") +
  theme_classic() +
  theme(axis.ticks = element_blank(), text = element_text(size = 14), axis.text.x = element_blank()) +
  guides(fill = F, colour = F) +
  geom_text(data= causeofdeath %>% arrange(-Percent) %>% mutate(ypos = cumsum(Percent) - 0.5 * Percent) %>% filter(Percent>1), aes(label = paste0(str_wrap(Cause2,35), ", ", round(Percent,0), "% (", scales::comma(round(Deaths,0)), ")"), y = ypos), fontface = "bold",  size = 4.5) +
  geom_text(data= causeofdeath %>% filter(Cause2=="Injuries"), aes(label = paste0(Cause2, ", ", round(Percent,1), "% (", scales::comma(round(Deaths,0)), ")"), y = 99.5, x=1.51), fontface = "bold", size = 3.5, hjust=0) +  
  geom_text(data= causeofdeath %>% filter(Cause2=="Tetanus"), aes(label = paste0(Cause2, ", ", round(Percent,1), "% (", scales::comma(round(Deaths,0)), ")"), y = 101, x=1.51), fontface = "bold", size = 3.5, hjust=0) +  
  scale_y_continuous(labels = scales::percent_format(scale = 1), limits = c(0, 102), expand = c(0,0)) +
  labs(x = NULL)+
  scale_x_continuous(limits = c(.5,2))
 
 # ggsave("figures/Neonatal_CauseDeath_stackBar_cacode.png", width=7, height=7, units="in")

# Works but need to round 
# NeoNatCoD_Pie <- causeofdeath %>%
#   group_by(Cause2) %>%
#   summarise(Percent = sum(Percent)) %>%
#   mutate(Cause2 = forcats::fct_reorder(Cause2, Percent)) %>%
#   arrange(-Percent) %>%
#   mutate(
#     end = 2 * pi * cumsum(Percent) / sum(Percent),
#     start = lag(end, default = 0),
#     middle = 0.5 * (start + end),
#     hjust = ifelse(middle > pi, 1, 0),
#     vjust = ifelse(middle < pi / 2 | middle > 3 * pi / 2, 0, 1)
#   )

 
causeofdeath <- read_excel("data/Copy of cause of death for under 5 age groups_2021_23052024.xlsx")  %>% filter(Age=="DAYS0-27") %>% group_by(Cause2) %>% summarise(Deaths=sum(Deaths), Percent=sum(Percent))

 
NeoNatCoD_Pie <- causeofdeath %>%
  group_by(Cause2) %>%
  filter(!(Cause2=="") ) %>%
  summarise(Percent = sum(Percent)) %>%
  mutate(Percent = round(Percent, digits = 1)) %>%
  mutate(Cause2 = forcats::fct_reorder(Cause2, Percent)) %>%
  mutate(legend_labs = paste0(Cause2, " (", Percent, "%)")) %>%
  arrange(-Percent) %>%
  mutate(
    end = 2 * pi * cumsum(Percent) / sum(Percent),
    start = lag(end, default = 0),
    middle = 0.5 * (start + end),
    hjust = ifelse(middle > pi, 1, 0),
    vjust = ifelse(middle < pi / 2 | middle > 3 * pi / 2, 0, 1)
  )

# using arc bar for better looking plot

ggplot(NeoNatCoD_Pie) +
  geom_arc_bar(aes(x0 = 0, y0 = 0, r0 = 0, r = 1, start = start, end = end, fill = legend_labs), colour = "white") +
  # geom_text(aes(x = 1.10 * sin(middle), y = 1.10 * cos(middle), label = str_wrap(paste0(Percent, "%"), width = 40), hjust = hjust, vjust = vjust), size = 4) +
  coord_fixed() +
  scale_fill_manual(values=c("#fdb462",	"#fb8072",	"#C4A484",	"grey60",	"#8dd3c7",	"#bebada",	"#80b1d3",	"#d9d9d9",	"#fccde5")) + 
  scale_x_continuous(limits = c(-1, 1), name = "", breaks = NULL, labels = NULL) +
  scale_y_continuous(limits = c(-1, 1), name = "", breaks = NULL, labels = NULL) +
  # scale_fill_brewer(palette = "RdPu") +
  theme_void() +
  guides(fill=guide_legend(title="Causes of neonatal deaths "))


# ggsave("figures/Neonatal_CauseDeath_pie_cacode.png")
 

## New code - testing labels outside pie chart
install.packages("ggrepel")
library(ggrepel)

ggplot(NeoNatCoD_Pie) +
  geom_arc_bar(aes(x0 = 0, y0 = 0, r0 = 0, r = 1, start = start, end = end, fill = legend_labs), colour = "white") +
  
  # Add connecting lines
  geom_segment(aes(
    x = 1 * sin(middle), 
    y = 1 * cos(middle), 
    xend = 1.3 * sin(middle),  # Extend the line outward slightly
    yend = 1.3 * cos(middle)
  ), colour = "black", size = 0.5) +
  
  # Add labels with repelling to prevent overlaps
  geom_text_repel(aes(
    x = 1.4 * sin(middle),  # Adjust label position to match the end of the line
    y = 1.4 * cos(middle),
    label = str_wrap(paste0(Percent), width = 30)
  ), size = 3, nudge_x = 0.1, nudge_y = 0.1, box.padding = 0.3, point.padding = 0.2, max.overlaps = 100) +
  
  coord_fixed() +
  scale_fill_manual(values = c("#fdb462", "#fb8072", "#C4A484", "grey60", "#8dd3c7", "#bebada", "#80b1d3", "#d9d9d9", "#fccde5")) + 
  scale_x_continuous(limits = c(-1.9, 1.9), name = "", breaks = NULL, labels = NULL) +
  scale_y_continuous(limits = c(-1.9, 1.9), name = "", breaks = NULL, labels = NULL) +
  theme_void() +
  guides(fill = guide_legend(title = "Causes of neonatal deaths"))


# ggsave("figures/Neonatal_CauseDeath_pie_cacode_labels.png")


```

```{r maternal-mort}


# data from https://mmr2020.srhr.org/data#download

mmr_world <- read_csv("data/external/estimates_World.csv") %>% filter(parameter=="mmr" | parameter=="maternal_deaths_summation_of_country_estimates")

years <- c(2000, 2005, 2010, 2015, 2020)

ggplot(data = mmr_world %>% filter(parameter=="mmr"), aes(x = year_mid, y = X0.5)) +
  geom_line(aes(y = X0.5), size = 1, colour = "#7a0177") +
  geom_ribbon(aes(ymin = X0.1, ymax = X0.9), alpha = 0.4, fill = "#7a0177") +
  scale_x_continuous(breaks = years) +
  scale_y_continuous(breaks = seq(from = 0, to = 400, by = 50), limits = c(0, 400), expand = c(0, 0)) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  geom_text(data = mmr_world %>% filter(parameter=="mmr") %>% mutate(year_round = floor(year_mid)) %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", X0.5), vjust = -.8, y = X0.9), show.legend = F, fontface = "bold") +
  labs(x = NULL, y = "Deaths per 100,000 live births", fill = NULL, colour = NULL)

# ggsave("figures/Maternal_MMR_trends2000-2020_dim2.png", width=5, height=4, units="in")
# ggsave("figures/Maternal_MMR_trends2000-2020_dim1.png", width=9, height=5, units="in")


ggplot(data =  mmr_world %>% filter(parameter=="maternal_deaths_summation_of_country_estimates"), aes(x = year_mid, y = X0.5 / 1000)) +
  geom_line(aes(y = X0.5 / 1000), size = 1, colour = "#7a0177") +
  scale_x_continuous(breaks = years, limits = c(1999, 2020)) +
  scale_y_continuous(breaks = seq(from = 0, to = 450, by = 50), limits = c(0, 500), expand = c(0, 0)) +
  # scale_colour_manual(values =  c("#8EC542", "#4D9ED8"))+
  # scale_fill_manual(values = c("#8EC542", "#4D9ED8"))+
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  geom_point(data = mmr_world %>% filter(parameter=="maternal_deaths_summation_of_country_estimates") %>% mutate(year_round = floor(year_mid)) %>% filter(year_round %in% years), aes(size = X0.5), shape = 21, fill = "#7a0177", colour = "#7a0177") +
  scale_size_continuous(range = c(9, 15), guide = F, limits = c(287237, 446508)) +
  geom_text(data = mmr_world %>% filter(parameter=="maternal_deaths_summation_of_country_estimates")  %>% mutate(year_round = floor(year_mid)) %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", X0.5 / 1000)), colour = "white", show.legend = F, fontface = "bold", shape = 21) +
  labs(x = NULL, y = "Deaths (in thousands)", fill = NULL, colour = NULL)

# ggsave("figures/Maternal_numDeaths_trends2000-2020_dim2.png", width=5, height=4, units="in")
# ggsave("figures/Maternal_numDeaths_trends2000-2020_dim1.png", width=9, height=5, units="in")

mmr_region <- read_csv("data/external/estimates_WHO_region.csv") %>% filter(parameter=="mmr")

reg_labs <- c(
  "AFR" = "African Region",
  "AMR" = "Region of the Americas",
  "SEAR" = "South-East Asian Region",
  "EUR" = "European Region",
  "EMR" = "Eastern Mediterranean Region",
  "WPR" = "Western Pacific Region"
)

ggplot(data = mmr_region, aes(x = year_mid, y = X0.5)) +
  theme_classic() +
  geom_line(aes(y = X0.5), size = .5, colour = "#7a0177") +
  geom_ribbon(aes(ymin = X0.1, ymax = X0.9), alpha = 0.4, fill = "#7a0177") +
  scale_x_continuous(breaks = years) +
  scale_y_continuous(breaks = seq(from = 0, to = 900, by = 100), limits = c(0, 900), expand = c(0, 0)) +
  theme(legend.position = "bottom", text = element_text(size = 12), legend.text = element_text(size = 10)) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  labs(x = NULL, y = "Deaths per 100,000 live births", fill = NULL, colour = NULL) +
  labs(x = NULL, y = "Deaths per 100,000 live births", fill = NULL, colour = NULL) +
  facet_wrap(~group, labeller = as_labeller(reg_labs))

# ggsave("figures/Maternal_MMR_trends_WHOreg_2000-2020_dim1.png", width=9, height=5, units="in")

mmr_income <- read_csv("data/external/estimates_World_Bank_Income.csv") %>% filter(parameter=="mmr")

ggplot(data = mmr_income %>% filter(!is.na(group)), aes(x = year_mid, y = X0.5)) +
  theme_classic() +
  geom_line(aes(y = X0.5), size = .5, colour = "#7a0177") +
  geom_ribbon(aes(ymin = X0.1, ymax = X0.9), alpha = 0.4, fill = "#7a0177") +
  scale_x_continuous(breaks = years) +
  scale_y_continuous(breaks = seq(from = 0, to = 900, by = 100), limits = c(0, 900), expand = c(0, 0)) +
  theme(legend.position = "bottom", text = element_text(size = 12), legend.text = element_text(size = 10)) +
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL) +
  labs(x = NULL, y = "Deaths per 100,000 live births", fill = NULL, colour = NULL) +
  labs(x = NULL, y = "Deaths per 100,000 live births", fill = NULL, colour = NULL) +
  facet_wrap(~factor(group, levels=c("Low income", "Lower middle income", "Upper middle income", "High income")))

# ggsave("figures/Maternal_MMR_trends_income_2000-2020_dim1.png", width=9, height=5, units="in")


## old mmr data

Say2014_LGH_MatCauseDeath <- read_excel("data/external/Say2014_LGH_MatCauseDeath.xlsx")


# Maternal cause of death ####
# pie

ggplot(
  Say2014_LGH_MatCauseDeath %>% group_by(Cause_general) %>% summarise(Percent = sum(Percent)) %>% mutate(Cause_general = forcats::fct_reorder(Cause_general, Percent)) %>% mutate(ypos = cumsum(Percent) - 0.5 * Percent),
  aes(x = "", y = Percent, fill = Cause_general)
) +
  # scale_fill_viridis_d(direction = -1)+
  scale_fill_brewer(palette = "RdPu") +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  theme_void() +
  guides(fill = F) +
  geom_text_repel(aes(label = Cause_general), position = position_stack(vjust = 0.5))

Mat_CoD_Pie <- Say2014_LGH_MatCauseDeath %>%
  group_by(Cause_general) %>%
  summarise(Percent = sum(Percent)) %>%
  mutate(Cause_general = forcats::fct_reorder(Cause_general, Percent)) %>%
  arrange(-Percent) %>%
  mutate(
    end = 2 * pi * cumsum(Percent) / sum(Percent),
    start = lag(end, default = 0),
    middle = 0.5 * (start + end),
    hjust = ifelse(middle > pi, 1, 0),
    vjust = ifelse(middle < pi / 2 | middle > 3 * pi / 2, 0, 1)
  )

# using arc bar for better looking plot

ggplot(Mat_CoD_Pie) +
  geom_arc_bar(aes(x0 = 0, y0 = 0, r0 = 0, r = 1, start = start, end = end, fill = Cause_general), colour = "white") +
  geom_text(aes(x = 1.05 * sin(middle), y = 1.05 * cos(middle), label = str_wrap(paste0(Cause_general, ", ", Percent, "%"), width = 20), hjust = hjust, vjust = vjust), size = 5) +
  coord_fixed() +
  scale_x_continuous(limits = c(-1.7, 1.5), name = "", breaks = NULL, labels = NULL) +
  scale_y_continuous(limits = c(-1, 1.1), name = "", breaks = NULL, labels = NULL) +
  scale_fill_brewer(palette = "RdPu") +
  theme_void() +
  guides(fill = F)

# ggsave("figures/Maternal_CauseDeath_pie_Say_LGH_2014.png")

# bar plot for maternal cause of death

ggplot(
  Say2014_LGH_MatCauseDeath %>% group_by(Cause_general) %>% summarise(Percent = sum(Percent)) %>% mutate(Cause_general = forcats::fct_reorder(Cause_general, -Percent)) %>% arrange(Percent) %>% mutate(ypos = cumsum(Percent) - 0.5 * Percent),
  aes(x = "", y = Percent, fill = Cause_general)
) +
  scale_fill_brewer(palette = "RdPu", direction = -1) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  theme_classic() +
  theme(axis.ticks = element_blank(), text = element_text(size = 14)) +
  guides(fill = F, colour = F) +
  geom_text(aes(label = paste0(Cause_general, ", ", Percent, "%"), y = ypos, colour = Cause_general), fontface = "bold", size = 5) +
  scale_colour_manual(values = c(rep("white", 2), rep("black", 4))) +
  scale_y_continuous(labels = scales::percent_format(scale = 1), expand = c(0, 0)) +
  labs(x = NULL)

# ggsave("figures/Maternal_CauseDeath_stackBar_Say_LGH_2014.png", width=5, height=5.73, units="in")

# trends in maternal death ####

GHO_maternalMMR_2000_2017_regGlob <- read_csv("data/raw/GHO_maternalMMR_2000_2017_regionalGlobal.csv")

years <- c(2000, 2005, 2010, 2015, 2017)

ggplot(data = GHO_maternalMMR_2000_2017_regGlob %>% filter(SpatialDimValueCode == "GLOBAL") %>% filter(Indicator == "Maternal mortality ratio (per 100 000 live births)"), aes(x = as.numeric(Period), y = FactValueNumeric)) +
  geom_line(aes(y = FactValueNumeric), size = 1, colour = "#7a0177") +
  geom_ribbon(aes(ymin = FactValueNumericLow, ymax = FactValueNumericHigh), alpha = 0.4, fill = "#7a0177") +
  scale_x_continuous(breaks = years) +
  scale_y_continuous(breaks = seq(from = 0, to = 400, by = 50), limits = c(0, 400), expand = c(0, 0)) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  geom_text(data = GHO_maternalMMR_2000_2017_regGlob %>% filter(SpatialDimValueCode == "GLOBAL") %>% mutate(year_round = floor(as.numeric(Period))) %>% filter(year_round %in% years) %>% filter(Indicator == "Maternal mortality ratio (per 100 000 live births)"), aes(label = sprintf("%1.0f", FactValueNumeric), vjust = -.8, y = FactValueNumericHigh), show.legend = F, fontface = "bold") +
  labs(x = NULL, y = "Deaths per 100,000 live births", fill = NULL, colour = NULL)

# ggsave("figures/Maternal_MMR_trends2000-2017_dim2.png", width=5, height=4, units="in")
# ggsave("figures/Maternal_MMR_trends2000-2017_dim1.png", width=9, height=5, units="in")

#

ggplot(data = GHO_maternalMMR_2000_2017_regGlob %>% filter(SpatialDimValueCode == "GLOBAL") %>% filter(Indicator == "Number of maternal deaths"), aes(x = as.numeric(Period), y = FactValueNumeric / 1000)) +
  geom_line(aes(y = FactValueNumeric / 1000), size = 1, colour = "#7a0177") +
  scale_x_continuous(breaks = years, limits = c(1999, 2017)) +
  scale_y_continuous(breaks = seq(from = 0, to = 450, by = 50), limits = c(0, 500), expand = c(0, 0)) +
  # scale_colour_manual(values =  c("#8EC542", "#4D9ED8"))+
  # scale_fill_manual(values = c("#8EC542", "#4D9ED8"))+
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  geom_point(data = GHO_maternalMMR_2000_2017_regGlob %>% filter(SpatialDimValueCode == "GLOBAL") %>% filter(Indicator == "Number of maternal deaths") %>% mutate(year_round = floor(as.numeric(Period))) %>% filter(year_round %in% years), aes(size = FactValueNumeric), shape = 21, fill = "#7a0177", colour = "#7a0177") +
  scale_size_continuous(range = c(9, 15), guide = F, limits = c(295000, 451000)) +
  geom_text(data = GHO_maternalMMR_2000_2017_regGlob %>% filter(SpatialDimValueCode == "GLOBAL") %>% filter(Indicator == "Number of maternal deaths") %>% mutate(year_round = floor(as.numeric(Period))) %>% filter(year_round %in% years), aes(label = sprintf("%1.0f", FactValueNumeric / 1000)), colour = "white", show.legend = F, fontface = "bold", shape = 21) +
  labs(x = NULL, y = "Deaths (in thousands)", fill = NULL, colour = NULL)

# ggsave("figures/Maternal_numDeaths_trends2000-2017_dim2.png", width=5, height=4, units="in")
# ggsave("figures/Maternal_numDeaths_trends2000-2017_dim1.png", width=9, height=5, units="in")

# projection to sdg target

# 2010 = 248, 2017 = 211 ...gives 142 for 2030?

projection2030 <- data.frame(
  line = c("trend", "trend", "sdg", "sdg"),
  Period = c(2017, 2030, 2017, 2030),
  FactValueNumeric = c(211, 142, 211, 69)
)

ggplot(data = GHO_maternalMMR_2000_2017_regGlob %>% filter(SpatialDimValueCode == "GLOBAL") %>% filter(Indicator == "Maternal mortality ratio (per 100 000 live births)"), aes(x = as.numeric(Period), y = FactValueNumeric)) +
  geom_line(aes(y = FactValueNumeric), size = 1, colour = "#7a0177") +
  geom_line(projection2030, mapping = aes(x = Period, y = FactValueNumeric, colour = line), size = 1, linetype = "dashed") +
  geom_ribbon(aes(ymin = FactValueNumericLow, ymax = FactValueNumericHigh), alpha = 0.4, fill = "#7a0177") +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2017, 2030), limits = c(2000, 2030)) +
  scale_y_continuous(breaks = seq(from = 0, to = 400, by = 50), limits = c(0, 400), expand = c(0, 0)) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  geom_text(data = GHO_maternalMMR_2000_2017_regGlob %>% filter(SpatialDimValueCode == "GLOBAL") %>% mutate(year_round = floor(as.numeric(Period))) %>% filter(year_round %in% c(2000, 2005, 2010, 2017, 2030)) %>% filter(Indicator == "Maternal mortality ratio (per 100 000 live births)"), aes(label = sprintf("%1.0f", FactValueNumeric), vjust = -.8, y = FactValueNumericHigh), show.legend = F, fontface = "bold") +
  geom_text(data = projection2030 %>% filter(Period == 2030), aes(label = sprintf("%1.0f", FactValueNumeric), vjust = -.8, y = FactValueNumeric), show.legend = F, fontface = "bold") +
  scale_colour_manual(labels = c("Achieving global SDG target", "Continuing current trends"), values = c("#0571b0", "#d6604d")) +
  labs(x = NULL, y = "Deaths per 100,000 live births", fill = NULL, colour = NULL)

# ggsave("figures/Maternal_ratio_trends2000-2030_sdgtargets.png", width=9, height=5, units="in")

```

```{r adol-yll-yld-allCause}


# all cause - data files from Regina

All_cause_All_years <- read_dta("data/raw/All cause_All years.dta")
All_cause_All_years$sex[All_cause_All_years$sex == 1] <- "Males"
All_cause_All_years$sex[All_cause_All_years$sex == 2] <- "Females"
All_cause_All_years$age[All_cause_All_years$age == 10] <- "10-14 years"
All_cause_All_years$age[All_cause_All_years$age == 15] <- "15-19 years"

# reshape - calculate overall ylls and ylds

all_cause_10to19 <- All_cause_All_years %>%
  pivot_longer(cols = c("yll", "yld"), names_to = "yll.yld") %>%
  filter(year == 2000 | year == 2019) %>%
  filter(age == "10-14 years" | age == "15-19 years") %>%
  filter(sex != 3) %>%
  group_by(year, age, sex, yll.yld, global, whoreg6) %>%
  summarise(sum_pop = sum(population), sum_value = sum(value))

# global yll yld

yllyld_male_global <- ggplot(all_cause_10to19 %>% filter(global == 1) %>% filter(sex == "Males"), aes(y = as.character(year), x = sum_value / sum_pop * 100000, fill = yll.yld)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_discrete(limits = c("2000", "2019"), breaks = c("2000", "2019")) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 14)) +
  scale_fill_manual(values = c("#B4C7E7", "#2F5597"), labels = c("YLD rate", "YLL rate")) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 10500), breaks = seq(from = 0, to = 10500, by = 1000)) +
  facet_nested(sex + age ~ .) +
  labs(x = "YLL/YLD rate per 100,000 population", y = NULL, fill = NULL)

yllyld_female_global <- ggplot(all_cause_10to19 %>% filter(global == 1) %>% filter(sex == "Females"), aes(y = as.character(year), x = sum_value / sum_pop * 100000, fill = yll.yld)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_discrete(limits = c("2000", "2019"), breaks = c("2000", "2019")) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 14)) +
  scale_fill_manual(values = c("#F4B183", "#BD0000"), labels = c("YLD rate", "YLL rate")) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 10500), breaks = seq(from = 0, to = 10500, by = 1000)) +
  facet_nested(sex + age ~ .) +
  labs(x = "YLL/YLD rate per 100,000 population", y = NULL, fill = NULL)

yllyld_female_global / yllyld_male_global

# ggsave("figures/YLL-YLD-10-19_global.png", width=8, height=6, unit="in")

# regional yll yld

yllyld_lables <- c(
  "1_Afr" = "African Region",
  "2_Amr" = "Region of the Americas",
  "3_Sear" = "South-East Asian Region",
  "4_Eur" = "European Region",
  "5_Emr" = "Eastern Mediterranean Region",
  "6_Wpr" = "Western Pacific Region",
  "Males" = "Males",
  "Females" = "Females",
  "10-14 years" = "10-14 years",
  "15-19 years" = "15-19 years"
)

yllyld_male_reg1 <- ggplot(all_cause_10to19 %>% filter(whoreg6 != "") %>% filter(sex == "Males") %>% filter(whoreg6 %in% c("1_Afr", "2_Amr", "3_Sear")), aes(y = as.character(year), x = sum_value / sum_pop * 100000, fill = yll.yld)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_discrete(limits = c("2000", "2019"), breaks = c("2000", "2019")) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 14)) +
  scale_fill_manual(values = c("#B4C7E7", "#2F5597"), labels = c("YLD rate", "YLL rate"), guide = F) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 10500), breaks = seq(from = 2000, to = 10500, by = 2000)) +
  facet_nested(sex + age ~ whoreg6, labeller = as_labeller(yllyld_lables)) +
  labs(x = NULL, y = NULL, fill = NULL)

yllyld_male_reg2 <- ggplot(all_cause_10to19 %>% filter(whoreg6 != "") %>% filter(sex == "Males") %>% filter(whoreg6 %in% c("4_Eur", "5_Emr", "6_Wpr")), aes(y = as.character(year), x = sum_value / sum_pop * 100000, fill = yll.yld)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_discrete(limits = c("2000", "2019"), breaks = c("2000", "2019")) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 14)) +
  scale_fill_manual(values = c("#B4C7E7", "#2F5597"), labels = c("YLD rate", "YLL rate")) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 10500), breaks = seq(from = 2000, to = 10500, by = 2000)) +
  facet_nested(sex + age ~ whoreg6, labeller = as_labeller(yllyld_lables)) +
  labs(x = "YLL/YLD rate per 100,000 population", y = NULL, fill = NULL)

yllyld_male_reg1 / yllyld_male_reg2

# ggsave("figures/YLL-YLD-10-19_region_males.png", width=10, height=6, unit="in")

yllyld_female_reg1 <- ggplot(all_cause_10to19 %>% filter(whoreg6 != "") %>% filter(sex == "Females") %>% filter(whoreg6 %in% c("1_Afr", "2_Amr", "3_Sear")), aes(y = as.character(year), x = sum_value / sum_pop * 100000, fill = yll.yld)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_discrete(limits = c("2000", "2019"), breaks = c("2000", "2019")) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 14)) +
  scale_fill_manual(values = c("#F4B183", "#BD0000"), labels = c("YLD rate", "YLL rate"), guide = F) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 10500), breaks = seq(from = 2000, to = 10500, by = 2000)) +
  facet_nested(sex + age ~ whoreg6, labeller = as_labeller(yllyld_lables)) +
  labs(x = NULL, y = NULL, fill = NULL)

yllyld_female_reg2 <- ggplot(all_cause_10to19 %>% filter(whoreg6 != "") %>% filter(sex == "Females") %>% filter(whoreg6 %in% c("4_Eur", "5_Emr", "6_Wpr")), aes(y = as.character(year), x = sum_value / sum_pop * 100000, fill = yll.yld)) +
  geom_bar(position = "dodge", stat = "identity") +
  scale_y_discrete(limits = c("2000", "2019"), breaks = c("2000", "2019")) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 14)) +
  scale_fill_manual(values = c("#F4B183", "#BD0000"), labels = c("YLD rate", "YLL rate")) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 10500), breaks = seq(from = 2000, to = 10500, by = 2000)) +
  facet_nested(sex + age ~ whoreg6, labeller = as_labeller(yllyld_lables)) +
  labs(x = "YLL/YLD rate per 100,000 population", y = NULL, fill = NULL)

yllyld_female_reg1 / yllyld_female_reg2

# ggsave("figures/YLL-YLD-10-19_region_females.png", width=10, height=6, unit="in")

# rates

ggplot(All_cause_All_years %>% filter(global == 1) %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex != 3) %>% mutate(sex.age = reorder_within(sex, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(sex.age), NA_character_)), aes(x = year, y = death_rate, fill = sex.age)) +
  geom_line(aes(y = death_rate, colour = sex.age), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2024)) +
  scale_y_continuous(breaks = seq(from = 0, to = 150, by = 25), limits = c(0, 150), expand = c(0, 0)) +
  scale_colour_manual(values = c("#fdae61", "#d7191c", "#abd9e9", "#2c7bb6")) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  labs(x = NULL, y = "Deaths per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 3, size = 5.5)

# ggsave("figures/mortRates_10-19_global.png", width=10, height=6, unit="in")

# trends in all cause yld rates by sex age

all_cause_trends_10to19 <- All_cause_All_years %>%
  filter(age == "10-14 years" | age == "15-19 years") %>%
  filter(sex != 3)

ggplot(all_cause_trends_10to19 %>% filter(global == 1) %>% mutate(sex.age = reorder_within(sex, yld_rate, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(sex.age), NA_character_)), aes(x = as.numeric(year), y = yld_rate)) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = sex.age, colour = sex.age), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_colour_manual(values = c("#fdae61", "#d7191c", "#abd9e9", "#2c7bb6"), breaks = c("Females, 10-14 years", "Females, 15-19 years", "Males, 10-14 years", "Males, 15-19 years")) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2026)) +
  scale_y_continuous(limits = c(0, 7200), expand = c(0, 0)) +
  geom_text_repel(aes(label = label), nudge_x = 3, size = 5.5) +
  labs(y = "YLDs per 100,000 population", x = NULL, colour = NULL)

# ggsave("figures/yldrates_trends_10-19_global.png", width=10, height=6, unit="in")

# Regional ####

# all cause rates ##

All_cause_All_years$region <- case_when(
  All_cause_All_years$whoreg6 == "1_Afr" ~ "African Region",
  All_cause_All_years$whoreg6 == "2_Amr" ~ "Region of the Americas",
  All_cause_All_years$whoreg6 == "3_Sear" ~ "South-East Asian Region",
  All_cause_All_years$whoreg6 == "4_Eur" ~ "European Region",
  All_cause_All_years$whoreg6 == "5_Emr" ~ "Eastern Mediterranean Region",
  All_cause_All_years$whoreg6 == "6_Wpr" ~ "Western Pacific Region",
)

ggplot(All_cause_All_years %>% filter(whoreg6 != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex == "Females") %>% mutate(age.region = reorder_within(region, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(region), NA_character_)), aes(x = year, y = death_rate, fill = age.region)) +
  geom_line(aes(y = death_rate, colour = age), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2028)) +
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25), limits = c(0, 250), expand = c(0, 0)) +
  scale_colour_manual(values = c("#fdae61", "#d7191c")) +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "Deaths per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 1, direction = "y", hjust = "left", size = 5.5) +
  facet_nested(rows = vars(sex, age), labeller = as_labeller(yllyld_lables))

# ggsave("figures/mortrate_trends_female_regional.png", width=12, height=7, unit="in")

ggplot(All_cause_All_years %>% filter(whoreg6 != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex == "Males") %>% mutate(age.region = reorder_within(region, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(region), NA_character_)), aes(x = year, y = death_rate, fill = age.region)) +
  geom_line(aes(y = death_rate, colour = age), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2028)) +
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25), limits = c(0, 250), expand = c(0, 0)) +
  scale_colour_manual(values = c("#abd9e9", "#2c7bb6")) +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "Deaths per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 1, direction = "y", hjust = "left", size = 5.5) +
  facet_nested(rows = vars(sex, age), labeller = as_labeller(yllyld_lables))

# ggsave("figures/mortrate_trends_male_regional.png", width=12, height=7, unit="in")

# region as colour

ggplot(All_cause_All_years %>% filter(whoreg6 != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex != 3) %>% mutate(age.region = reorder_within(region, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(region), NA_character_)), aes(x = year, y = death_rate, fill = age.region)) +
  geom_line(aes(y = death_rate, colour = region), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2028)) +
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25), limits = c(0, 250), expand = c(0, 0)) +
  scale_color_viridis_d() +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "Deaths per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 2, direction = "y", hjust = "left", size = 5.5) +
  facet_nested(rows = vars(age), cols = vars(sex), labeller = as_labeller(yllyld_lables))

# ggsave("figures/mortrate_trends_regional.png", width=19, height=8, unit="in")

ggplot(All_cause_All_years %>% filter(whoreg6 != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex != 3) %>% mutate(age.region = reorder_within(region, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(region), NA_character_)), aes(x = year, y = death_rate, fill = age.region)) +
  geom_line(aes(y = death_rate, colour = region), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2019)) +
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25), limits = c(0, 250), expand = c(0, 0)) +
  scale_color_viridis_d() +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  labs(x = NULL, y = "Deaths per 100,000 population", fill = NULL, colour = NULL) +
  facet_nested(rows = vars(age), cols = vars(sex), labeller = as_labeller(yllyld_lables))

# ggsave("figures/mortrate_trends_regional_legend.png", width=19, height=8, unit="in")

# yld ##
# all cause rates ##


ggplot(All_cause_All_years %>% filter(whoreg6 != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex == "Females") %>% mutate(age.region = reorder_within(region, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(region), NA_character_)), aes(x = year, y = yld_rate, fill = age.region)) +
  geom_line(aes(y = yld_rate, colour = age), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2028)) +
  scale_y_continuous(breaks = seq(from = 0, to = 8200, by = 2000), limits = c(0, 8200), expand = c(0, 0)) +
  scale_colour_manual(values = c("#fdae61", "#d7191c")) +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "YLD rate per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 1, direction = "y", hjust = "left", size = 5.5) +
  facet_nested(rows = vars(sex, age), labeller = as_labeller(yllyld_lables))

# ggsave("figures/yld_trends_female_regional.png", width=12, height=7, unit="in")

ggplot(All_cause_All_years %>% filter(whoreg6 != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex == "Males") %>% mutate(age.region = reorder_within(region, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(region), NA_character_)), aes(x = year, y = yld_rate, fill = age.region)) +
  geom_line(aes(y = yld_rate, colour = age), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2028)) +
  scale_y_continuous(breaks = seq(from = 0, to = 8200, by = 2000), limits = c(0, 8200), expand = c(0, 0)) +
  scale_colour_manual(values = c("#abd9e9", "#2c7bb6")) +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "YLD rate per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 1, direction = "y", hjust = "left", size = 5.5) +
  facet_nested(rows = vars(sex, age), labeller = as_labeller(yllyld_lables))

# ggsave("figures/yld_trends_male_regional.png", width=12, height=7, unit="in")

# region as colour

ggplot(All_cause_All_years %>% filter(whoreg6 != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex != 3) %>% mutate(age.region = reorder_within(region, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(region), NA_character_)), aes(x = year, y = yld_rate, fill = age.region)) +
  geom_line(aes(y = yld_rate, colour = region), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2030)) +
  scale_y_continuous(breaks = seq(from = 0, to = 8200, by = 2000), limits = c(0, 8200), expand = c(0, 0)) +
  scale_color_viridis_d() +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "YLD rate per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 2, direction = "y", hjust = "left", size = 5.5) +
  facet_nested(rows = vars(age), cols = vars(sex), labeller = as_labeller(yllyld_lables))

# ggsave("figures/yld_trends_regional.png", width=19, height=8, unit="in")

ggplot(All_cause_All_years %>% filter(whoreg6 != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex != 3) %>% mutate(age.region = reorder_within(region, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(region), NA_character_)), aes(x = year, y = yld_rate, fill = age.region)) +
  geom_line(aes(y = yld_rate, colour = region), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2019)) +
  scale_y_continuous(breaks = seq(from = 0, to = 8200, by = 2000), limits = c(0, 8200), expand = c(0, 0)) +
  scale_color_viridis_d() +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  labs(x = NULL, y = "YLD rate per 100,000 population", fill = NULL, colour = NULL) +
  facet_nested(rows = vars(age), cols = vars(sex), labeller = as_labeller(yllyld_lables))

# ggsave("figures/yld_trends_regional_legend.png", width=19, height=8, unit="in")

# income ####

# all cause rates ##

All_cause_All_years$income[All_cause_All_years$wbinc19 == "1_LO"] <- "Low income"
All_cause_All_years$income[All_cause_All_years$wbinc19 == "2_LMI"] <- "Lower middle income"
All_cause_All_years$income[All_cause_All_years$wbinc19 == "3_UMI"] <- "Upper middle income"
All_cause_All_years$income[All_cause_All_years$wbinc19 == "4_HI"] <- "High income"

All_cause_All_years$income <- factor(All_cause_All_years$income, levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))

# income as colour

ggplot(All_cause_All_years %>% filter(income != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex != 3) %>% mutate(age.income = reorder_within(income, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(income), NA_character_)), aes(x = year, y = death_rate, fill = age.income)) +
  geom_line(aes(y = death_rate, colour = income), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2028)) +
  scale_y_continuous(breaks = seq(from = 0, to = 250, by = 25), limits = c(0, 250), expand = c(0, 0)) +
  scale_color_viridis_d(option = "cividis") +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "Deaths per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 2, direction = "y", hjust = "left", size = 5.5) +
  facet_nested(rows = vars(age), cols = vars(sex), labeller = as_labeller(yllyld_lables))

# ggsave("figures/mortrate_trends_income.png", width=19, height=8, unit="in")


# yld ##
# all cause rates ##

# income as colour

ggplot(All_cause_All_years %>% filter(income != "") %>% filter(age == "10-14 years" | age == "15-19 years") %>% filter(sex != 3) %>% mutate(age.income = reorder_within(income, year, age, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(income), NA_character_)), aes(x = year, y = yld_rate, fill = age.income)) +
  geom_line(aes(y = yld_rate, colour = income), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2019), limits = c(2000, 2030)) +
  scale_y_continuous(breaks = seq(from = 0, to = 8300, by = 2000), limits = c(0, 8300), expand = c(0, 0)) +
  scale_color_viridis_d(option = "cividis") +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "YLD rate per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 2, direction = "y", hjust = "left", size = 5.5) +
  facet_nested(rows = vars(age), cols = vars(sex), labeller = as_labeller(yllyld_lables))

# ggsave("figures/yld_trends_income.png", width=19, height=8, unit="in")

```

```{r adol-yll-yld-causeSpecific}

# cause specific data from regina, dta file was huge so converted to csv in stata and then to parquet in this script: cause_specific_convert.R

pqCause_specific_ranking_AllYears <- open_dataset("data/raw/Cause_specific_ranking_AllYears.parquet")

Cause_specific_2019_10.19 <- pqCause_specific_ranking_AllYears %>%
  filter(year == 2019) %>%
  filter(age == 10 | age == 15) %>%
  collect()

Cause_specific_2019_10.19$sex[Cause_specific_2019_10.19$sex == 1] <- "Males"
Cause_specific_2019_10.19$sex[Cause_specific_2019_10.19$sex == 2] <- "Females"
Cause_specific_2019_10.19$age[Cause_specific_2019_10.19$age == 10] <- "10-14 years"
Cause_specific_2019_10.19$age[Cause_specific_2019_10.19$age == 15] <- "15-19 years"

Cause_specific_2019_10.19$region <- case_when(
  Cause_specific_2019_10.19$whoreg6 == "1_Afr" ~ "African Region",
  Cause_specific_2019_10.19$whoreg6 == "2_Amr" ~ "Region of the Americas",
  Cause_specific_2019_10.19$whoreg6 == "3_Sear" ~ "South-East Asian Region",
  Cause_specific_2019_10.19$whoreg6 == "4_Eur" ~ "European Region",
  Cause_specific_2019_10.19$whoreg6 == "5_Emr" ~ "Eastern Mediterranean Region",
  Cause_specific_2019_10.19$whoreg6 == "6_Wpr" ~ "Western Pacific Region",
)

Cause_specific_2019_10.19$income[Cause_specific_2019_10.19$wbinc19 == "1_LO"] <- "Low income"
Cause_specific_2019_10.19$income[Cause_specific_2019_10.19$wbinc19 == "2_LMI"] <- "Lower middle income"
Cause_specific_2019_10.19$income[Cause_specific_2019_10.19$wbinc19 == "3_UMI"] <- "Upper middle income"
Cause_specific_2019_10.19$income[Cause_specific_2019_10.19$wbinc19 == "4_HI"] <- "High income"

Cause_specific_2019_10.19$income <- factor(Cause_specific_2019_10.19$income, levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))

# yll for top 5 causes by sex and age, 2019

causeSpec_yll_global_males <- ggplot(Cause_specific_2019_10.19 %>% filter(global == 1) %>% filter(sex == "Males") %>% group_by(age) %>% slice_max(order_by = (yll_rate), n = 5), aes(y = reorder_within(causename, yll_rate, age), x = yll_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutrition conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1500), breaks = seq(from = 0, to = 1500, by = 300)) +
  scale_y_reordered() +
  facet_grid(age ~ sex, scales = "free") +
  labs(x = "Number of YLLs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yll_global_females <- ggplot(Cause_specific_2019_10.19 %>% filter(global == 1) %>% filter(sex == "Females") %>% group_by(age) %>% slice_max(order_by = (yll_rate), n = 5), aes(y = reorder_within(causename, yll_rate, age), x = yll_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1500), breaks = seq(from = 0, to = 1500, by = 300)) +
  scale_y_reordered() +
  facet_grid(age ~ sex, scales = "free") +
  labs(x = "Number of YLLs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yll_global_males + causeSpec_yll_global_females + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causeYLL-10-19_global2019.png", width=10, height=6, unit="in")

# regional

causeSpec_deaths_region_males10.14 <- ggplot(Cause_specific_2019_10.19 %>% filter(whoreg6 != "") %>% filter(sex == "Males") %>% filter(age == "10-14 years") %>% group_by(age, region) %>% slice_max(order_by = (death_rate), n = 5), aes(y = reorder_within(causename, death_rate, region), x = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 50), breaks = seq(from = 0, to = 50, by = 5)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_region_males15.19 <- ggplot(Cause_specific_2019_10.19 %>% filter(whoreg6 != "") %>% filter(sex == "Males") %>% filter(age == "15-19 years") %>% group_by(age, region) %>% slice_max(order_by = (death_rate), n = 5), aes(y = reorder_within(causename, death_rate, region), x = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 50), breaks = seq(from = 0, to = 50, by = 5)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_region_males10.14 + causeSpec_deaths_region_males15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causedeaths_males-10-19_regional2019.png", width=15, height=10, unit="in")

causeSpec_deaths_region_females10.14 <- ggplot(Cause_specific_2019_10.19 %>% filter(whoreg6 != "") %>% filter(sex == "Females") %>% filter(age == "10-14 years") %>% group_by(age, region) %>% slice_max(order_by = (death_rate), n = 5), aes(y = reorder_within(causename, death_rate, region), x = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 50), breaks = seq(from = 0, to = 50, by = 5)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_region_females15.19 <- ggplot(Cause_specific_2019_10.19 %>% filter(whoreg6 != "") %>% filter(sex == "Females") %>% filter(age == "15-19 years") %>% group_by(age, region) %>% slice_max(order_by = (death_rate), n = 5), aes(y = reorder_within(causename, death_rate, region), x = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 50), breaks = seq(from = 0, to = 50, by = 5)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_region_females10.14 + causeSpec_deaths_region_females15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causedeaths_females-10-19_regional2019.png", width=15, height=10, unit="in")


# income ####

# income

causeSpec_deaths_income_males10.14 <- ggplot(Cause_specific_2019_10.19 %>% filter(income != "") %>% filter(sex == "Males") %>% filter(age == "10-14 years") %>% group_by(age, income) %>% slice_max(order_by = (death_rate), n = 5), aes(x = reorder_within(str_wrap(causename, 25), -death_rate, income), y = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 32), breaks = seq(from = 0, to = 32, by = 5)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_income_males15.19 <- ggplot(Cause_specific_2019_10.19 %>% filter(income != "") %>% filter(sex == "Males") %>% filter(age == "15-19 years") %>% group_by(age, income) %>% slice_max(order_by = (death_rate), n = 5), aes(x = reorder_within(str_wrap(causename, 25), -death_rate, income), y = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 32), breaks = seq(from = 0, to = 32, by = 5)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_income_males10.14 / causeSpec_deaths_income_males15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causedeaths_males-10-19_income2019.png", width=15, height=10, unit="in")

causeSpec_deaths_income_females10.14 <- ggplot(Cause_specific_2019_10.19 %>% filter(income != "") %>% filter(sex == "Females") %>% filter(age == "10-14 years") %>% group_by(age, income) %>% slice_max(order_by = (death_rate), n = 5), aes(x = reorder_within(str_wrap(causename, 18), -death_rate, income), y = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 32), breaks = seq(from = 0, to = 32, by = 5)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_income_females15.19 <- ggplot(Cause_specific_2019_10.19 %>% filter(income != "") %>% filter(sex == "Females") %>% filter(age == "15-19 years") %>% group_by(age, income) %>% slice_max(order_by = (death_rate), n = 5), aes(x = reorder_within(str_wrap(causename, 18), -death_rate, income), y = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 32), breaks = seq(from = 0, to = 32, by = 5)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_income_females10.14 / causeSpec_deaths_income_females15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causedeaths_females-10-19_income2019.png", width=15, height=10, unit="in")


# yld by sex and age for 2019 top 5 causes

causeSpec_yld_global_males <- ggplot(Cause_specific_2019_10.19 %>% filter(global == 1) %>% filter(sex == "Males") %>% group_by(age) %>% slice_max(order_by = (yld_rate), n = 5), aes(y = reorder_within(causename, yld_rate, age), x = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16), axis.text.x = element_text(15)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 800), breaks = seq(from = 0, to = 800, by = 200)) +
  scale_y_reordered() +
  facet_grid(age ~ sex, scales = "free") +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_global_females <- ggplot(Cause_specific_2019_10.19 %>% filter(global == 1) %>% filter(sex == "Females") %>% group_by(age) %>% slice_max(order_by = (yld_rate), n = 5), aes(y = reorder_within(causename, yld_rate, age), x = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16), axis.text.x = element_text(15)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 800), breaks = seq(from = 0, to = 800, by = 200)) +
  scale_y_reordered() +
  facet_grid(age ~ sex, scales = "free") +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_global_males + causeSpec_yld_global_females + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causeYLD-10-19_global2019.png", width=15, height=10, unit="in")

# regional

causeSpec_yld_regional_males10.14 <- ggplot(Cause_specific_2019_10.19 %>% filter(whoreg6 != "") %>% filter(sex == "Males") %>% filter(age == "10-14 years") %>% group_by(age, region) %>% slice_max(order_by = (yld_rate), n = 5), aes(y = reorder_within(causename, yld_rate, region), x = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(15)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1100), breaks = seq(from = 0, to = 1000, by = 200)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_regional_males15.19 <- ggplot(Cause_specific_2019_10.19 %>% filter(whoreg6 != "") %>% filter(sex == "Males") %>% filter(age == "15-19 years") %>% group_by(age, region) %>% slice_max(order_by = (yld_rate), n = 5), aes(y = reorder_within(causename, yld_rate, region), x = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(15)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1100), breaks = seq(from = 0, to = 1000, by = 200)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_regional_males10.14 + causeSpec_yld_regional_males15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causeYLD-10-19males_regional_2019.png", width=15, height=10, unit="in")

causeSpec_yld_regional_females10.14 <- ggplot(Cause_specific_2019_10.19 %>% filter(whoreg6 != "") %>% filter(sex == "Females") %>% filter(age == "10-14 years") %>% group_by(age, region) %>% slice_max(order_by = (yld_rate), n = 5), aes(y = reorder_within(causename, yld_rate, region), x = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16), axis.text.x = element_text(15)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1100), breaks = seq(from = 0, to = 1000, by = 200)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_regional_females15.19 <- ggplot(Cause_specific_2019_10.19 %>% filter(whoreg6 != "") %>% filter(sex == "Females") %>% filter(age == "15-19 years") %>% group_by(age, region) %>% slice_max(order_by = (yld_rate), n = 5), aes(y = reorder_within(causename, yld_rate, region), x = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16), axis.text.x = element_text(15)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 1100), breaks = seq(from = 0, to = 1000, by = 200)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_regional_females10.14 + causeSpec_yld_regional_females15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causeYLD-10-19females_regional_2019.png", width=15, height=10, unit="in")


# income #
# income

causeSpec_yld_income_males10.14 <- ggplot(Cause_specific_2019_10.19 %>% filter(income != "") %>% filter(sex == "Males") %>% filter(age == "10-14 years") %>% group_by(age, income) %>% slice_max(order_by = (yld_rate), n = 5), aes(x = reorder_within(str_wrap(causename, 18), -yld_rate, income), y = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 1200), breaks = seq(from = 0, to = 1200, by = 200)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_income_males15.19 <- ggplot(Cause_specific_2019_10.19 %>% filter(income != "") %>% filter(sex == "Males") %>% filter(age == "15-19 years") %>% group_by(age, income) %>% slice_max(order_by = (yld_rate), n = 5), aes(x = reorder_within(str_wrap(causename, 18), -yld_rate, income), y = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 1200), breaks = seq(from = 0, to = 1200, by = 200)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_income_males10.14 / causeSpec_yld_income_males15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causeYLD-10-19males_income_2019.png", width=15, height=10, unit="in")

causeSpec_yld_income_females10.14 <- ggplot(Cause_specific_2019_10.19 %>% filter(income != "") %>% filter(sex == "Females") %>% filter(age == "10-14 years") %>% group_by(age, income) %>% slice_max(order_by = (yld_rate), n = 5), aes(x = reorder_within(str_wrap(causename, 18), -yld_rate, income), y = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 1200), breaks = seq(from = 0, to = 1200, by = 200)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_income_females15.19 <- ggplot(Cause_specific_2019_10.19 %>% filter(income != "") %>% filter(sex == "Females") %>% filter(age == "15-19 years") %>% group_by(age, income) %>% slice_max(order_by = (yld_rate), n = 5), aes(x = reorder_within(str_wrap(causename, 18), -yld_rate, income), y = yld_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 1200), breaks = seq(from = 0, to = 1200, by = 200)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL)

causeSpec_yld_income_females10.14 / causeSpec_yld_income_females15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causeYLD-10-19females_income_2019.png", width=15, height=10, unit="in")

# rates

Cause_specific_2019_10.19_rates <- Cause_specific_2019_10.19 %>%
  filter(year == 2019) %>%
  filter(age == "10-14 years" | age == "15-19 years") %>%
  filter(sex != 3)

# top 5 cause for 2019 for age and sex, by rate per 100000 pop

causeSpec_rates_global_males <- ggplot(Cause_specific_2019_10.19_rates %>% filter(global == 1) %>% filter(sex == "Males") %>% group_by(age) %>% slice_max(order_by = death_rate, n = 5), aes(y = reorder_within(causename, death_rate, age), x = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 20), breaks = seq(from = 0, to = 20, by = 5)) +
  scale_y_reordered() +
  facet_grid(age ~ sex, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_rates_global_females <- ggplot(Cause_specific_2019_10.19_rates %>% filter(global == 1) %>% filter(sex == "Females") %>% group_by(age) %>% slice_max(order_by = death_rate, n = 5), aes(y = reorder_within(causename, death_rate, age), x = death_rate, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 20), breaks = seq(from = 0, to = 20, by = 5)) +
  scale_y_reordered() +
  facet_grid(age ~ sex, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_rates_global_males + causeSpec_rates_global_females + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causeSpec-rates-10-19_global.png", width=10, height=6, unit="in")

# trends in rates

Cause_specific_2000.2019_10.19 <- pqCause_specific_ranking_AllYears %>% # filter(year==2019 | year== 2000) %>%
  filter(age == 10 | age == 15) %>% collect()

Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 1] <- "Males"
Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 2] <- "Females"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 10] <- "10-14 years"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 15] <- "15-19 years"

# 10-14y males

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(global == 1) %>%
  filter(sex == "Males") %>%
  group_by(year) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0))

top5causes <- Cause_specific_2000.2019_10.14ym_top5$causename[Cause_specific_2000.2019_10.14ym_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14ym_top5$year == 2000 | Cause_specific_2000.2019_10.14ym_top5$year == 2019)]

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.14ym_top5 %>% filter(causename %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14ym_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2028), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 25)) +
  geom_text_repel(data = Cause_specific_2000.2019_10.14ym_top5 %>% filter(year == "2019"), aes(label = causename, y = death_rate), x = 2019, show.legend = F, fontface = "bold", nudge_x = 2.5, size = 4) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specific_2000.2019_10.14ym_top5.png", width=9, height=5, unit="in")


# 15-19y males

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(global == 1) %>%
  filter(sex == "Males") %>%
  group_by(year) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse(row_number() <= 5, "top5", 0))

top5causes <- Cause_specific_2000.2019_15.19ym_top5$causename[Cause_specific_2000.2019_15.19ym_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19ym_top5$year == 2000 | Cause_specific_2000.2019_15.19ym_top5$year == 2019)]

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_15.19ym_top5 %>% filter(causename %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19ym_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2028), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 25)) +
  geom_text(data = Cause_specific_2000.2019_15.19ym_top5 %>% filter(year == "2019"), aes(label = causename, y = death_rate), hjust = 0, vjust = .5, x = 2019, show.legend = F, fontface = "bold") +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specific_2000.2019_15.19ym_top5.png", width=9, height=5, unit="in")

# 10-14y females

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(global == 1) %>%
  filter(sex == "Females") %>%
  group_by(year) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse(row_number() <= 5, "top5", 0))

top5causes <- Cause_specific_2000.2019_10.14yf_top5$causename[Cause_specific_2000.2019_10.14yf_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14yf_top5$year == 2000 | Cause_specific_2000.2019_10.14yf_top5$year == 2019)]

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.14yf_top5 %>% filter(causename %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14yf_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2028), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 25)) +
  geom_text_repel(data = Cause_specific_2000.2019_10.14yf_top5 %>% filter(year == "2019"), aes(label = causename, y = death_rate), x = 2019, show.legend = F, fontface = "bold", nudge_x = 2.5, nudge_y = 1) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specific_2000.2019_10.14yf_top5.png", width=9, height=5, unit="in")


# 15-19y males

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(global == 1) %>%
  filter(sex == "Females") %>%
  group_by(year) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse(row_number() <= 5, "top5", 0))

top5causes <- Cause_specific_2000.2019_15.19yf_top5$causename[Cause_specific_2000.2019_15.19yf_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19yf_top5$year == 2000 | Cause_specific_2000.2019_15.19yf_top5$year == 2019)]

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_15.19yf_top5 %>% filter(causename %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19yf_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2028), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 25)) +
  geom_text_repel(data = Cause_specific_2000.2019_15.19yf_top5 %>% filter(year == "2019"), aes(label = causename, y = death_rate), hjust = 1, vjust = .5, x = 2019, show.legend = F, fontface = "bold", nudge_x = 4) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specific_2000.2019_15.19yf_top5.png", width=9, height=5, unit="in")


## YLD rate trends - top five causes



# 10-14y males

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(global == 1) %>%
  filter(sex == "Males") %>%
  group_by(year) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse(row_number() <= 5, "top5", 0))

top5causes <- Cause_specific_2000.2019_10.14ym_top5$causename[Cause_specific_2000.2019_10.14ym_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14ym_top5$year == 2000 | Cause_specific_2000.2019_10.14ym_top5$year == 2019)]

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.14ym_top5 %>% filter(causename %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14ym_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2025), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 650)) +
  geom_text_repel(data = Cause_specific_2000.2019_10.14ym_top5 %>% filter(year == "2019"), aes(label = str_wrap(causename, width = 25), y = yld_rate), x = 2019, show.legend = F, fontface = "bold", nudge_x = 2) +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specificYLD_2000.2019_10.14ym_top5.png", width=9, height=5, unit="in")


# 15-19y males

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(global == 1) %>%
  filter(sex == "Males") %>%
  group_by(year) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse(row_number() <= 5, "top5", 0))

top5causes <- Cause_specific_2000.2019_15.19ym_top5$causename[Cause_specific_2000.2019_15.19ym_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19ym_top5$year == 2000 | Cause_specific_2000.2019_15.19ym_top5$year == 2019)]

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_15.19ym_top5 %>% filter(causename %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19ym_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2025), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 650)) +
  geom_text_repel(data = Cause_specific_2000.2019_15.19ym_top5 %>% filter(year == "2019"), aes(label = str_wrap(causename, width = 25), y = yld_rate), x = 2019, show.legend = F, fontface = "bold", nudge_x = 3, nudge_y = 1) +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specificYLD_2000.2019_15.19ym_top5.png", width=9, height=5, unit="in")

# 10-14y females

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(global == 1) %>%
  filter(sex == "Females") %>%
  group_by(year) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse(row_number() <= 5, "top5", 0))

top5causes <- Cause_specific_2000.2019_10.14yf_top5$causename[Cause_specific_2000.2019_10.14yf_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14yf_top5$year == 2000 | Cause_specific_2000.2019_10.14yf_top5$year == 2019)]

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.14yf_top5 %>% filter(causename %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14yf_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutrition conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2025), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 650)) +
  geom_text_repel(data = Cause_specific_2000.2019_10.14yf_top5 %>% filter(year == "2019"), aes(label = str_wrap(causename, width = 25), y = yld_rate), x = 2019, show.legend = F, fontface = "bold", nudge_x = 1) +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specificYLD_2000.2019_10.14yf_top5.png", width=9, height=5, unit="in")


# 15-19y females

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(global == 1) %>%
  filter(sex == "Females") %>%
  group_by(year) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse(row_number() <= 5, "top5", 0))

top5causes <- Cause_specific_2000.2019_15.19yf_top5$causename[Cause_specific_2000.2019_15.19yf_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19yf_top5$year == 2000 | Cause_specific_2000.2019_15.19yf_top5$year == 2019)]

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_15.19yf_top5 %>% filter(causename %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19yf_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutrition conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2025), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 651)) +
  geom_text(data = Cause_specific_2000.2019_15.19yf_top5 %>% filter(year == "2019"), aes(label = causename, y = yld_rate), x = 2019, show.legend = F, fontface = "bold", hjust = 0) +
  labs(x = "YLDs per 100,000 population", y = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specificYLD_2000.2019_15.19yf_top5.png", width=9, height=5, unit="in")


## data for maps ##

# •	Two maps for mortality rate from road traffic injuries among boys aged 10-14 and 15-19 years
# •	Two maps for YLD rate from iron-deficiency anaemia among girls aged 10-14 and 15-19 years.

# road traffic boys 10-14

adol_cause_maps <- Cause_specific_2019_10.19 %>%
  filter(causename == "Road injury" | causename == "Iron-deficiency anaemia") %>% # causes requested by regina
  filter(year == 2019) %>% # latest year
  filter(!is.na(whoname) & whoname != "") %>% # remove global/regional estimates
  filter(sex != 3) %>% # remove combined sex estimates
  mutate(age_causename_sex = paste0(age, "_", causename, "_", sex)) %>%
  filter(age_causename_sex %in% c("10-14 years_Iron-deficiency anaemia_Females", "15-19 years_Iron-deficiency anaemia_Females", "10-14 years_Road injury_Males", "15-19 years_Road injury_Males")) %>% # keep relevant rows
  dplyr::select(whoname, age_causename_sex, death_rate, yld_rate) %>% # keep relevant columns
  pivot_wider(names_from = age_causename_sex, values_from = c(death_rate, yld_rate)) %>% #
  dplyr::select(-c("death_rate_10-14 years_Iron-deficiency anaemia_Females", "death_rate_15-19 years_Iron-deficiency anaemia_Females", "yld_rate_10-14 years_Road injury_Males", "yld_rate_15-19 years_Road injury_Males")) # remove road ylds and death iron deficiency

adol_cause_maps$iso3 <- countrycode(adol_cause_maps$whoname, origin = "country.name", destination = "iso3c")



# write.csv(adol_cause_maps, "ArcGIS/adol_cause_maps.csv")

# make sure only member states

# country/area list from xmart: https://extranet.who.int/xmart4/REFMART/data/REF_COUNTRY
xmart_refCountry <- fromJSON("https://xmart-api-public.who.int/REFMART/REF_COUNTRY")
# INDICATOR_FK,YEAR_FK,ValueNumeric,COUNTRY_FK ValueLow ValueHigh ValueStdDev ValueStdErr Comments COUNTRY_FK__CODE DatasourceLong RESIDENCEAREA_FK__CODE SEX_FK WEALTHQUINTILE_FK

ref_country <- as.data.frame(xmart_refCountry$value)


adol_cause_maps <- left_join(adol_cause_maps, ref_country[, c("CODE_ISO_3", "WHO_LEGAL_STATUS")], by = c("iso3" = "CODE_ISO_3"))
table(adol_cause_maps$WHO_LEGAL_STATUS, useNA = "ifany")

# all member states
```

```{r regional-trends-deaths}
#trends in rates

Cause_specific_2000.2019_10.19 <- pqCause_specific_ranking_AllYears %>% # filter(year==2019 | year== 2000) %>%
  filter(age == 10 | age == 15) %>% collect()

Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 1] <- "Males"
Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 2] <- "Females"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 10] <- "10-14 years"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 15] <- "15-19 years"

Cause_specific_2000.2019_10.19$region <- case_when(
  Cause_specific_2000.2019_10.19$whoreg6 == "1_Afr" ~ "African Region",
  Cause_specific_2000.2019_10.19$whoreg6 == "2_Amr" ~ "Region of the Americas",
  Cause_specific_2000.2019_10.19$whoreg6 == "3_Sear" ~ "South-East Asian Region",
  Cause_specific_2000.2019_10.19$whoreg6 == "4_Eur" ~ "European Region",
  Cause_specific_2000.2019_10.19$whoreg6 == "5_Emr" ~ "Eastern Mediterranean Region",
  Cause_specific_2000.2019_10.19$whoreg6 == "6_Wpr" ~ "Western Pacific Region",
)

# 10-14y males

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(whoreg6 != "") %>%
  filter(sex == "Males") %>%
  group_by(year, whoreg6) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(causename, whoreg6))

top5causes <- Cause_specific_2000.2019_10.14ym_top5$causeRegion[Cause_specific_2000.2019_10.14ym_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14ym_top5$year == 2000 | Cause_specific_2000.2019_10.14ym_top5$year == 2019)]

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.14ym_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14ym_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 55)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = death_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2000.2019_10.14ym_top5_regional.png", width=16, height=9, unit="in")


# 15-19y males

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(whoreg6 != "") %>%
  filter(sex == "Males") %>%
  group_by(year, whoreg6) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(causename, whoreg6))

top5causes <- Cause_specific_2000.2019_15.19ym_top5$causeRegion[Cause_specific_2000.2019_15.19ym_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19ym_top5$year == 2000 | Cause_specific_2000.2019_15.19ym_top5$year == 2019)]

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_15.19ym_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19ym_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 55)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = death_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2000.2019_15.19ym_top5_regional.png", width=16, height=9, unit="in")

# 10-14y females

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(whoreg6 != "") %>%
  filter(sex == "Females") %>%
  group_by(year, whoreg6) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(causename, whoreg6))

top5causes <- Cause_specific_2000.2019_10.14yf_top5$causeRegion[Cause_specific_2000.2019_10.14yf_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14yf_top5$year == 2000 | Cause_specific_2000.2019_10.14yf_top5$year == 2019)]

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.14yf_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14yf_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 55)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = death_rate, x = year), show.legend = F, nudge_x = 4, nudge_y = 1, direction = "y", hjust = "left", size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2000.2019_10.14yf_top5_region.png", width=16, height=9, unit="in")


# 15-19y females

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(whoreg6 != "") %>%
  filter(sex == "Females") %>%
  group_by(year, whoreg6) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(causename, whoreg6))

top5causes <- Cause_specific_2000.2019_15.19yf_top5$causeRegion[Cause_specific_2000.2019_15.19yf_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19yf_top5$year == 2000 | Cause_specific_2000.2019_15.19yf_top5$year == 2019)]

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_15.19yf_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19yf_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 55)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = death_rate, x = year), show.legend = F, nudge_x = 4, nudge_y = 1, direction = "y", hjust = "left", size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2000.2019_15.19yf_top5_region.png", width=16, height=9, unit="in")

```

```{r lmic-trends-deaths}

# trends in rates

Cause_specific_2000.2019_10.19 <- pqCause_specific_ranking_AllYears %>% # filter(year==2019 | year== 2000) %>%
  filter(age == 10 | age == 15) %>% collect()

Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 1] <- "Males"
Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 2] <- "Females"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 10] <- "10-14 years"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 15] <- "15-19 years"

Cause_specific_2000.2019_10.19$income[Cause_specific_2000.2019_10.19$wbinc19 == "1_LO"] <- "Low income"
Cause_specific_2000.2019_10.19$income[Cause_specific_2000.2019_10.19$wbinc19 == "2_LMI"] <- "Lower middle income"
Cause_specific_2000.2019_10.19$income[Cause_specific_2000.2019_10.19$wbinc19 == "3_UMI"] <- "Upper middle income"
Cause_specific_2000.2019_10.19$income[Cause_specific_2000.2019_10.19$wbinc19 == "4_HI"] <- "High income"

Cause_specific_2000.2019_10.19$income <- factor(Cause_specific_2000.2019_10.19$income, levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))


# 10-14y males

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(income != "") %>%
  filter(sex == "Males") %>%
  group_by(year, income) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(causename, income))

top5causes <- Cause_specific_2000.2019_10.14ym_top5$causeincome[Cause_specific_2000.2019_10.14ym_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14ym_top5$year == 2000 | Cause_specific_2000.2019_10.14ym_top5$year == 2019)]

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.14ym_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14ym_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 55)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = death_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2000.2019_10.14ym_top5_income.png", width=16, height=9, unit="in")


# 15-19y males

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(income != "") %>%
  filter(sex == "Males") %>%
  group_by(year, income) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(causename, income))

top5causes <- Cause_specific_2000.2019_15.19ym_top5$causeincome[Cause_specific_2000.2019_15.19ym_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19ym_top5$year == 2000 | Cause_specific_2000.2019_15.19ym_top5$year == 2019)]

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_15.19ym_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19ym_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 55)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = death_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2000.2019_15.19ym_top5_income.png", width=16, height=9, unit="in")

# 10-14y females

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(income != "") %>%
  filter(sex == "Females") %>%
  group_by(year, income) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(causename, income))

top5causes <- Cause_specific_2000.2019_10.14yf_top5$causeincome[Cause_specific_2000.2019_10.14yf_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14yf_top5$year == 2000 | Cause_specific_2000.2019_10.14yf_top5$year == 2019)]

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.14yf_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14yf_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 55)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = death_rate, x = year), show.legend = F, nudge_x = 4, nudge_y = 1, direction = "y", hjust = "left", size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2000.2019_10.14yf_top5_income.png", width=16, height=9, unit="in")


# 15-19y females

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(income != "") %>%
  filter(sex == "Females") %>%
  group_by(year, income) %>%
  arrange(-death_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(causename, income))

top5causes <- Cause_specific_2000.2019_15.19yf_top5$causeincome[Cause_specific_2000.2019_15.19yf_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19yf_top5$year == 2000 | Cause_specific_2000.2019_15.19yf_top5$year == 2019)]

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_15.19yf_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19yf_top5 %>% mutate(causename.group = reorder_within(causename, death_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = death_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  scale_y_continuous(limits = c(0, 55)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = death_rate, x = year), show.legend = F, nudge_x = 4, nudge_y = 1, direction = "y", hjust = "left", size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2000.2019_15.19yf_top5_income.png", width=16, height=9, unit="in")


```

```{r regional-trends-yld}

Cause_specific_2000.2019_10.19 <- pqCause_specific_ranking_AllYears %>% # filter(year==2019 | year== 2000) %>%
  filter(age == 10 | age == 15) %>% collect()

Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 1] <- "Males"
Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 2] <- "Females"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 10] <- "10-14 years"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 15] <- "15-19 years"

Cause_specific_2000.2019_10.19$region <- case_when(
  Cause_specific_2000.2019_10.19$whoreg6 == "1_Afr" ~ "African Region",
  Cause_specific_2000.2019_10.19$whoreg6 == "2_Amr" ~ "Region of the Americas",
  Cause_specific_2000.2019_10.19$whoreg6 == "3_Sear" ~ "South-East Asian Region",
  Cause_specific_2000.2019_10.19$whoreg6 == "4_Eur" ~ "European Region",
  Cause_specific_2000.2019_10.19$whoreg6 == "5_Emr" ~ "Eastern Mediterranean Region",
  Cause_specific_2000.2019_10.19$whoreg6 == "6_Wpr" ~ "Western Pacific Region",
)

# 10-14y males

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(whoreg6 != "") %>%
  filter(sex == "Males") %>%
  group_by(year, whoreg6) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(causename, whoreg6))

top5causes <- Cause_specific_2000.2019_10.14ym_top5$causeRegion[Cause_specific_2000.2019_10.14ym_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14ym_top5$year == 2000 | Cause_specific_2000.2019_10.14ym_top5$year == 2019)]

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.14ym_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14ym_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1100)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = yld_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "YLDs per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specificYLD_2000.2019_10.14ym_top5_regional.png", width=16, height=9, unit="in")



# 15-19y males

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(whoreg6 != "") %>%
  filter(sex == "Males") %>%
  group_by(year, whoreg6) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(causename, whoreg6))

top5causes <- Cause_specific_2000.2019_15.19ym_top5$causeRegion[Cause_specific_2000.2019_15.19ym_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19ym_top5$year == 2000 | Cause_specific_2000.2019_15.19ym_top5$year == 2019)]

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_15.19ym_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19ym_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1100)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = yld_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "YLDs per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specificYLD_2000.2019_15.19ym_top5_regional.png", width=16, height=9, unit="in")



# 10-14y females

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(whoreg6 != "") %>%
  filter(sex == "Females") %>%
  group_by(year, whoreg6) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(causename, whoreg6))

top5causes <- Cause_specific_2000.2019_10.14yf_top5$causeRegion[Cause_specific_2000.2019_10.14yf_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14yf_top5$year == 2000 | Cause_specific_2000.2019_10.14yf_top5$year == 2019)]

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.14yf_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14yf_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1100)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = yld_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "YLDs per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specificYLD_2000.2019_10.14yf_top5_regional.png", width=16, height=9, unit="in")



# 15-19y females

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(whoreg6 != "") %>%
  filter(sex == "Females") %>%
  group_by(year, whoreg6) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(causename, whoreg6))

top5causes <- Cause_specific_2000.2019_15.19yf_top5$causeRegion[Cause_specific_2000.2019_15.19yf_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19yf_top5$year == 2000 | Cause_specific_2000.2019_15.19yf_top5$year == 2019)]

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_15.19yf_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19yf_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1100)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = yld_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "YLDs per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specificYLD_2000.2019_15.19yf_top5_regional.png", width=16, height=9, unit="in")

```

```{r lmic-trends-yld}


Cause_specific_2000.2019_10.19 <- pqCause_specific_ranking_AllYears %>% # filter(year==2019 | year== 2000) %>%
  filter(age == 10 | age == 15) %>% collect()

Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 1] <- "Males"
Cause_specific_2000.2019_10.19$sex[Cause_specific_2000.2019_10.19$sex == 2] <- "Females"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 10] <- "10-14 years"
Cause_specific_2000.2019_10.19$age[Cause_specific_2000.2019_10.19$age == 15] <- "15-19 years"

Cause_specific_2000.2019_10.19$income[Cause_specific_2000.2019_10.19$wbinc19 == "1_LO"] <- "Low income"
Cause_specific_2000.2019_10.19$income[Cause_specific_2000.2019_10.19$wbinc19 == "2_LMI"] <- "Lower middle income"
Cause_specific_2000.2019_10.19$income[Cause_specific_2000.2019_10.19$wbinc19 == "3_UMI"] <- "Upper middle income"
Cause_specific_2000.2019_10.19$income[Cause_specific_2000.2019_10.19$wbinc19 == "4_HI"] <- "High income"

Cause_specific_2000.2019_10.19$income <- factor(Cause_specific_2000.2019_10.19$income, levels = c("Low income", "Lower middle income", "Upper middle income", "High income"))

# 10-14y males

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(income != "") %>%
  filter(sex == "Males") %>%
  group_by(year, income) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(causename, income))

top5causes <- Cause_specific_2000.2019_10.14ym_top5$causeincome[Cause_specific_2000.2019_10.14ym_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14ym_top5$year == 2000 | Cause_specific_2000.2019_10.14ym_top5$year == 2019)]

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.14ym_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14ym_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1200)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = yld_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "YLDs per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specificYLD_2000.2019_10.14ym_top5_income.png", width=16, height=9, unit="in")



# 15-19y males

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(income != "") %>%
  filter(sex == "Males") %>%
  group_by(year, income) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(causename, income))

top5causes <- Cause_specific_2000.2019_15.19ym_top5$causeincome[Cause_specific_2000.2019_15.19ym_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19ym_top5$year == 2000 | Cause_specific_2000.2019_15.19ym_top5$year == 2019)]

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_15.19ym_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19ym_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1200)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = yld_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "YLDs per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specificYLD_2000.2019_15.19ym_top5_income.png", width=16, height=9, unit="in")



# 10-14y females

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "10-14 years") %>%
  filter(sex != 3) %>%
  filter(income != "") %>%
  filter(sex == "Females") %>%
  group_by(year, income) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(causename, income))

top5causes <- Cause_specific_2000.2019_10.14yf_top5$causeincome[Cause_specific_2000.2019_10.14yf_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14yf_top5$year == 2000 | Cause_specific_2000.2019_10.14yf_top5$year == 2019)]

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.14yf_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14yf_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1200)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = yld_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "YLDs per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specificYLD_2000.2019_10.14yf_top5_income.png", width=16, height=9, unit="in")



# 15-19y females

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_10.19 %>%
  filter(age == "15-19 years") %>%
  filter(sex != 3) %>%
  filter(income != "") %>%
  filter(sex == "Females") %>%
  group_by(year, income) %>%
  arrange(-yld_rate) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(causename, income))

top5causes <- Cause_specific_2000.2019_15.19yf_top5$causeincome[Cause_specific_2000.2019_15.19yf_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19yf_top5$year == 2000 | Cause_specific_2000.2019_15.19yf_top5$year == 2019)]

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_15.19yf_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19yf_top5 %>% mutate(causename.group = reorder_within(causename, yld_rate, causegroup)) %>% mutate(label = if_else(year == 2019, as.character(causename), NA_character_))) +
  geom_line(aes(x = as.numeric(year), y = yld_rate, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2000, 2032), breaks = c(2000, 2005, 2010, 2015, 2019), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 1200)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = yld_rate, x = year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "YLDs per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specificYLD_2000.2019_15.19yf_top5_income.png", width=16, height=9, unit="in")



```

```{r child-cod}

# WHO MCEE estimates last updated Feb 2018

childcod_estimates_2000_2016 <- read_excel("data/raw/childcod_estimates_2000_2016.xls", sheet = "estimates")
childcod_estimates_2000_2016 <- childcod_estimates_2000_2016 %>%
  pivot_longer(cols = c(10:135), names_to = "cause") %>%
  mutate(stat = case_when(startsWith(cause, "r") ~ "rate", startsWith(cause, "f") ~ "fraction")) %>%
  mutate(cat_name = case_when(
    grepl("neo", cause) ~ "Neonatal period",
    grepl("post", cause) ~ "Postneonatal period",
    grepl("ufive", cause) ~ "Under five"
  )) %>%
  mutate(cause_name = case_when(
    grepl("17", cause) ~ "Injuries",
    grepl("16", cause) ~ "Other noncommunicable diseases",
    grepl("15", cause) ~ "Congenital anomalies",
    grepl("13", cause) ~ "Other group 1",
    grepl("12", cause) ~ "Sepsis and other infectious conditions",
    grepl("11", cause) ~ "Birth asphyxia and birth trauma",
    grepl("10", cause) ~ "Prematurity",
    grepl("9", cause) ~ "Acute respiratory infections",
    grepl("8", cause) ~ "Malaria",
    grepl("7", cause) ~ "Meningitis/encephalitis",
    grepl("6", cause) ~ "Measles",
    grepl("5", cause) ~ "Tetanus",
    grepl("3", cause) ~ "Diarrhoeal diseases",
    grepl("2", cause) ~ "HIV/AIDS"
  ))

```

```{r mpdsr}


# policy survey
policy_survey <- read_excel("data/raw/PolicySurvey_All.labels.xlsx")

## remove all non member states  ####
# Palestine, British Virgin Islands, French Polynesia, Guam, and Wallis & Futuna Islands
non_member_states <- c("PSE", "VGB", "PYF", "GUM", "WLF")

policy_survey <- policy_survey %>% filter((iso3 %in% non_member_states) == F)

# set "NA" to missing
policy_survey[policy_survey == "NA"] <- NA

# MN_79== Is there a national policy/guideline/law requiring all maternal deaths to be notified within 24 hours to a central authority?
# MN_80== Is there a national policy/guideline/law requiring all maternal deaths to be reviewed?
# MN_92== Is there a national policy/guideline/law that requires stillbirths (fresh or macerated) to be reviewed?
# MN_95. Is there a national policy/guideline/law that requires neonatal deaths (0-28 days) to be reviewed?
# CC_ 53. Is there a policy/law that requires routine audit and/or review of death certification for maternal, perinatal, neonatal, and/or child deaths?

mpdsr <- policy_survey %>%
  dplyr::select("iso3", "whoname", "who_region", "wb_income", "MN_79", "MN_80", "MN_92", "MN_95") %>%
  pivot_longer(c("MN_79", "MN_80", "MN_92", "MN_95")) %>%
  mutate(name2 = recode(name, "MN_79" = "Maternal death notification within 24 hours", "MN_80" = "Maternal death review", "MN_92" = "Stillbirth (fresh or macerated) review", "MN_95" = "Neonatal death (0-28 days) review"))



world_map <- map_data("world")
world_map$iso3 <- countrycode(world_map$region, origin = "country.name", destination = "iso3c")

mpdsrm <- left_join(mpdsr, world_map, by = "iso3")

ggplot() +
  geom_map(
    data = world_map, map = world_map,
    aes(x = long, y = lat, group = group, map_id = region),
    fill = "white", colour = "#bdbdbd", size = 0.2
  ) +
  geom_map(
    data = mpdsrm, map = world_map,
    aes(x = long, y = lat, group = group, map_id = region, fill = value),
    colour = "#969696", size = 0.2
  ) +
  scale_fill_manual(values = c("#4575b4", "#fee090", "#fdae61", "white"), na.value = "white", breaks = c("Yes", "Unknown", "No", NA), labels = c("Yes", "Unknown", "No", "No data"), limits = c("Yes", "Unknown", "No", NA)) +
  theme_classic() +
  theme(axis.line = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(), legend.position = "bottom") +
  facet_wrap(~name2) +
  labs(x = "", y = "", fill = "National policy, guideline, law", title = NULL) +
  coord_cartesian(ylim = c(-50, 90))

# ggsave("figures/mpdsr_policy.png", width=8, height=6, unit="in")

mpdsr_arcgis <- mpdsr %>%
  dplyr::select(-name) %>%
  pivot_wider(names_from = name2, values_from = value)

# write.csv(mpdsr_arcgis, "ArcGIS/mpdsr_arcgis.csv")

#### new who map package

library(devtools)
devtools::install_github("whocov/whomapper", 
                          force = TRUE, 
                          dependencies = TRUE)

library(whomapper)

# read shp files using prepackaged files
sfs <- pull_sfs()

ggplot() +
  geom_sf_who_poly(data = sfs$adm0, aes(fill = who_region)) +
  scale_fill_brewer(palette = "Set3", 
                    na.value = who_map_col("no_data"),
                    name = "WHO Region") +
  labs(title ="World map by WHO region", 
       subtitle = glue::glue("as of {format(Sys.Date(), '%d %b %y')}")) +
  who_map_pipeline() 

#who_map_save(glue::glue("who_region_map.png"), dpi = 700)


policysurv <- read_excel("C:/Users/kpeve/OneDrive - London School of Hygiene and Tropical Medicine/My OneDrive Documents/WHO/PolicySurvey2023/data/SRMNCAH_Policy_Survey_main.xlsx",
    sheet = "labels-English")

mpdsr_map <- left_join(
  sfs$adm0,
  policysurv %>% select(iso3,MN_54, MN_55, MN_56),
  by = c("iso_3_code" = "iso3")
)

# MN_54

ggplot() +
  geom_sf_who_poly(data = mpdsr_map, aes(fill = MN_54)) +
  scale_fill_manual(values = c("#4575b4", "#fccde5", "#8dd3c7", "#fee090", "#fdae61"),  breaks = c("YES, MATERNAL & PERINATAL", "YES, MATERNAL", "YES, PERINATAL", "UNKNOWN", "NO"), labels = c("Maternal and perinatal", "Maternal", "Perinatal", "Unknown", "No"), 
                    na.value = who_map_col("no_data"),
                    name = "") +
  labs(title ="National guideline/policy/law requiring audit/review of\nmaternal/perinatal death", subtitle = "2023 Policy Survey") +
  who_map_pipeline() 

# ggsave("figures/mpdsr_policy_MN_54.png", width=8, height=6, unit="in")

# MN_55

ggplot() +
  geom_sf_who_poly(data = mpdsr_map, aes(fill = MN_55)) +
  scale_fill_manual(values = c("#4575b4", "#fccde5", "#8dd3c7", "#fee090", "#fdae61"),  breaks = c("YES, MATERNAL & PERINATAL", "YES, MATERNAL", "YES, PERINATAL", "UNKNOWN", "NO"), labels = c("Maternal and perinatal", "Maternal", "Perinatal", "Unknown", "No"), 
                    na.value = who_map_col("no_data"),
                    name = "") +
  labs(title ="National guideline/policy/law requiring facility deaths\nto be notified within 24 hours", subtitle = "2023 Policy Survey") +
  who_map_pipeline() 

# ggsave("figures/mpdsr_policy_MN_55.png", width=8, height=6, unit="in")

# MN_56

ggplot() +
  geom_sf_who_poly(data = mpdsr_map, aes(fill = MN_56)) +
  scale_fill_manual(values = c("#4575b4", "#fccde5", "#8dd3c7", "#fee090", "#fdae61"),  breaks = c("YES, MATERNAL & PERINATAL", "YES, MATERNAL", "YES, PERINATAL", "UNKNOWN", "NO"), labels = c("Maternal and perinatal", "Maternal", "Perinatal", "Unknown", "No"), 
                    na.value = who_map_col("no_data"),
                    name = "") +
  labs(title ="National guideline/policy/law requiring non-facility\ndeaths to be notified within 24 hours", subtitle = "2023 Policy Survey") +
  who_map_pipeline() 

# ggsave("figures/mpdsr_policy_MN_56.png", width=8, height=6, unit="in")


```

```{r stillbirths}

stillbirthsUNICEF <- read_excel("data/external/GLOBAL_DATAFLOW_2009-2019_UNICEFdataWarehouseStillbirth210921.xlsx")


ggplot(data = stillbirthsUNICEF %>% filter(`Geographic area` == "World"), aes(x = as.numeric(TIME_PERIOD), y = as.numeric(OBS_VALUE))) +
  geom_line(aes(y = as.numeric(OBS_VALUE)), size = 1) +
  geom_ribbon(aes(ymin = as.numeric(LOWER_BOUND), ymax = as.numeric(UPPER_BOUND)), alpha = 0.6) +
  # scale_x_continuous(breaks = years)+
  # scale_y_continuous(breaks = seq(from = 0, to = 100, by = 25), limits = c(0,100), expand = c(0,0))+
  scale_colour_manual(values = c("#8EC542", "#4D9ED8")) +
  scale_fill_manual(values = c("#D2E7A6", "#DBEDF7")) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 14)) +
  # geom_text(data=U5_Neonatal_mortRate_2020_globalRegional %>% filter(Region.Name=="World") %>% mutate(year_round=floor(as.numeric(TIME_PERIOD))) %>%  filter(year_round %in% years), aes(label=sprintf("%1.0f", OBS_VALUE), vjust=-.4, colour=population, y=Upper), show.legend = F, fontface="bold")+
  labs(x = NULL, y = "Deaths per 1,000", fill = NULL, colour = NULL)

```

```{r mnh_riskfactors}

xmart <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AC_ANEMIAPW%22,%22AC_ANEMIAWRA%22,%22BC_LBW%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,AGEGROUP_FK,Answer_FK,CauseGHE_FK,CauseGHEChild_FK,CauseENVCAUSE_FK,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# INDICATOR_FK,YEAR_FK,ValueNumeric,COUNTRY_FK ValueLow ValueHigh ValueStdDev ValueStdErr Comments COUNTRY_FK__CODE DatasourceLong RESIDENCEAREA_FK__CODE SEX_FK WEALTHQUINTILE_FK

MNH_riskfact <- as.data.frame(xmart$value)

# saveRDS(MNH_riskfact, "data/MNH_riskfact.rds")
# MNH_riskfact <- read_rds("data/MNH_riskfact.rds")

# which cols are NA

sapply(MNH_riskfact, function(x) sum(is.na(x)))

MNH_riskfact <- MNH_riskfact %>% dplyr::select(where(~ !all(is.na(.x))))
table(MNH_riskfact$COUNTRY_FK, MNH_riskfact$INDICATOR_FK)
x <- MNH_riskfact %>%
  group_by(COUNTRY_FK, INDICATOR_FK, YEAR_FK) %>%
  summarise(n = n())

MNH_riskfact$period <- NA
MNH_riskfact$period[MNH_riskfact$YEAR_FK >= 2015 & MNH_riskfact$YEAR_FK <= 2020] <- "2015-2020"
MNH_riskfact$period[MNH_riskfact$YEAR_FK <= 2014 & MNH_riskfact$YEAR_FK >= 2010] <- "2010-2014"
table(MNH_riskfact$period)

# LMICs

MNH_riskfact <- MNH_riskfact %>% mutate(ind_country = paste0(INDICATOR_FK, COUNTRY_FK))

MNH_riskfact$indicator <- case_when(
  MNH_riskfact$INDICATOR_FK == "AC_ANEMIAPW" ~ "Anaemia in pregnant women 15-49 years",
  MNH_riskfact$INDICATOR_FK == "AC_ANEMIAWRA" ~ "Anaemia in non-pregnant women 15-49 years",
  MNH_riskfact$INDICATOR_FK == "BC_LBW" ~ "Low birthweight (% newborns who weigh <2.5kg)"
)

# Find countries with a data point in each time period
x <- MNH_riskfact %>%
  mutate(one = 1) %>%
  group_by(ind_country, period) %>%
  summarise(sumone = sum(one)) %>%
  pivot_wider(names_from = period, values_from = sumone) %>%
  filter(!is.na(`2015-2020`) & !is.na(`2010-2014`))

MNH_riskfact$bothPeriods[MNH_riskfact$ind_country %in% x$ind_country] <- "both"

# country/area list from xmart: https://extranet.who.int/xmart4/REFMART/data/REF_COUNTRY
xmart_refCountry <- fromJSON("https://xmart-api-public.who.int/REFMART/REF_COUNTRY")
# INDICATOR_FK,YEAR_FK,ValueNumeric,COUNTRY_FK ValueLow ValueHigh ValueStdDev ValueStdErr Comments COUNTRY_FK__CODE DatasourceLong RESIDENCEAREA_FK__CODE SEX_FK WEALTHQUINTILE_FK

ref_country <- as.data.frame(xmart_refCountry$value)

# saveRDS(ref_country, "data/ref_country.rds")
# ref_country <- read_rds("data/ref_country.rds")

ref_country$region <- case_when(
  ref_country$GRP_WHO_REGION == "AFR" ~ "African Region",
  ref_country$GRP_WHO_REGION == "AMR" ~ "Region of the Americas",
  ref_country$GRP_WHO_REGION == "EMR" ~ "Eastern Mediterranean Region",
  ref_country$GRP_WHO_REGION == "EUR" ~ "European Region",
  ref_country$GRP_WHO_REGION == "SEAR" ~ "South-East Asia Region",
  ref_country$GRP_WHO_REGION == "WPR" ~ "Western Pacific Region"
)

MNH_riskfact <- left_join(MNH_riskfact, ref_country, by = c("COUNTRY_FK__CODE" = "CODE_ISO_3"))

MNH_riskfact <- MNH_riskfact %>% filter(WHO_LEGAL_STATUS == "M")

# exclude pre 2010
MNH_riskfact <- MNH_riskfact %>% filter(YEAR_FK >= 2010)


# remove multiple estimates from the same country in the same period
# find estimate closest to 2012 for 2010-2014 or most recent (if two equally close to 2012, take larger number)
MNH_riskfact$diff <- NA
MNH_riskfact$diff[MNH_riskfact$period == "2010-2014"] <- abs(as.numeric(MNH_riskfact$YEAR_FK[MNH_riskfact$period == "2010-2014"]) - 2012)

mnc14 <- MNH_riskfact %>%
  filter(period == "2010-2014") %>%
  group_by(ind_country) %>%
  filter(diff == min(diff, na.rm = T)) %>%
  filter(ValueNumeric == max(ValueNumeric)) %>%
  filter(row_number() == 1)

mnc19 <- MNH_riskfact %>%
  filter(period == "2015-2020") %>%
  group_by(ind_country) %>%
  filter(YEAR_FK == max(YEAR_FK)) %>%
  filter(ValueNumeric == max(ValueNumeric)) %>%
  filter(row_number() == 1)

MNH_riskfact_1419 <- as.data.frame(rbind(mnc14, mnc19))
rm(mnc14, mnc19)



medians_trend <- MNH_riskfact_1419 %>%
  filter(bothPeriods == "both") %>%
  group_by(indicator, period) %>%
  summarise(medians = median(ValueNumeric, na.rm = T))

medians_recent <- MNH_riskfact_1419 %>%
  filter(period == "2015-2020") %>%
  group_by(indicator) %>%
  summarise(medians = median(ValueNumeric, na.rm = T))

# Median trend bar plot

ggplot(medians_trend, aes(x = indicator, y = medians, fill = period)) +
  geom_col(position = position_dodge(width = 0.5)) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  scale_fill_manual(values = c("#bdbdbd", "#009CDE")) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Prevalence (%)", fill = NULL)

# recent prevalence

ggplot(medians_recent, aes(x = indicator, y = medians)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(MNH_riskfact %>% filter(period == "2015-2019"), mapping = aes(x = indicator, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Prevalence (%)", fill = NULL)

# population data from WPP - to be used in means

wpp <- read_excel("data/external/WPP2019_POP_F01_1_TOTAL_POPULATION_BOTH_SEXES.xlsx", skip = 16) %>% filter(Type == "Country/Area")
wpp$iso3 <- countrycode(wpp$`Region, subregion, country or area *`, origin = "country.name", destination = "iso3c")
wpp$`Region, subregion, country or area *`[is.na(wpp$iso3)]

MNH_riskfact_1419 <- left_join(MNH_riskfact_1419, wpp[, c("iso3", "2012", "2019")], by = c("COUNTRY_FK__CODE" = "iso3"))

# calculate number of covered people in population
MNH_riskfact_1419$covered[MNH_riskfact_1419$period == "2010-2014"] <- MNH_riskfact_1419$ValueNumeric[MNH_riskfact_1419$period == "2010-2014"] * as.numeric(MNH_riskfact_1419$`2012`[MNH_riskfact_1419$period == "2010-2014"])
MNH_riskfact_1419$covered[MNH_riskfact_1419$period == "2015-2019"] <- MNH_riskfact_1419$ValueNumeric[MNH_riskfact_1419$period == "2015-2019"] * as.numeric(MNH_riskfact_1419$`2019`[MNH_riskfact_1419$period == "2015-2019"])

MNH_riskfact_1419$pop[MNH_riskfact_1419$period == "2010-2014"] <- as.numeric(MNH_riskfact_1419$`2012`[MNH_riskfact_1419$period == "2010-2014"])
MNH_riskfact_1419$pop[MNH_riskfact_1419$period == "2015-2019"] <- as.numeric(MNH_riskfact_1419$`2019`[MNH_riskfact_1419$period == "2015-2019"])

pop_means_trend <- MNH_riskfact_1419 %>%
  filter(bothPeriods == "both") %>%
  group_by(period, indicator) %>%
  summarise(pop_means = sum(covered) / sum(pop))

pop_means_recent <- MNH_riskfact_1419 %>%
  filter(period == "2015-2019") %>%
  group_by(indicator) %>%
  summarise(pop_means = sum(covered) / sum(pop))

# population weighted means

# trends
ggplot(pop_means_trend, aes(x = indicator, y = pop_means, fill = period)) +
  geom_col(position = position_dodge(width = 0.5)) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  scale_fill_manual(values = c("#bdbdbd", "#009CDE")) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Prevalence (%)", fill = NULL)

# recent

ggplot(pop_means_recent, aes(x = indicator, y = pop_means)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(MNH_riskfact %>% filter(period == "2015-2019"), mapping = aes(x = indicator, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 12)) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Prevalence (%)", fill = NULL)

## Regional # LBW

pop_means_region <- MNH_riskfact_1419 %>%
  filter(period == "2015-2019") %>%
  filter(INDICATOR_FK == "BC_LBW") %>%
  group_by(indicator, region) %>%
  summarise(pop_means = sum(covered) / sum(pop))

ggplot(pop_means_region, aes(x = region, y = pop_means)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(MNH_riskfact %>% filter(period == "2015-2019") %>% filter(INDICATOR_FK == "BC_LBW"), mapping = aes(x = region, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) +
  theme_classic() +
  theme(text = element_text(size = 14)) +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Population-weighted mean\nprevalence (%), 2015-2019", fill = NULL)

# ggsave("figures/LBW_region_popwtMean2015-2019.png", width=9, height=5, units="in")

medians_recent <- MNH_riskfact_1419 %>%
  filter(period == "2015-2020") %>%
  filter(INDICATOR_FK == "BC_LBW") %>%
  group_by(indicator, region) %>%
  summarise(medians = median(ValueNumeric, na.rm = T))

ggplot(medians_recent, aes(x = region, y = medians)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(MNH_riskfact %>% filter(period == "2015-2020") %>% filter(INDICATOR_FK == "BC_LBW"), mapping = aes(x = region, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) +
  theme_classic() +
  theme(text = element_text(size = 14)) +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Median prevalence (%), 2015-2020", fill = NULL)

# ggsave("figures/LBW_region_Medians2015-2020.png", width=9, height=5, units="in")

## Regional # AC_ANEMIAPW

pop_means_region <- MNH_riskfact_1419 %>%
  filter(period == "2015-2019") %>%
  filter(INDICATOR_FK == "AC_ANEMIAPW") %>%
  group_by(indicator, region) %>%
  summarise(pop_means = sum(covered) / sum(pop))

ggplot(pop_means_region, aes(x = region, y = pop_means)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(MNH_riskfact %>% filter(period == "2015-2019") %>% filter(INDICATOR_FK == "AC_ANEMIAPW"), mapping = aes(x = region, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) +
  theme_classic() +
  theme(text = element_text(size = 14)) +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Population-weighted mean\nprevalence (%), 2015-2019", fill = NULL)

# ggsave("figures/AnaemiaPW_region_popwtMean2015-2019.png", width=9, height=5, units="in")

medians_recent <- MNH_riskfact_1419 %>%
  filter(period == "2015-2020") %>%
  filter(INDICATOR_FK == "AC_ANEMIAPW") %>%
  group_by(indicator, region) %>%
  summarise(medians = median(ValueNumeric, na.rm = T))

ggplot(medians_recent, aes(x = region, y = medians)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(MNH_riskfact %>% filter(period == "2015-2020") %>% filter(INDICATOR_FK == "AC_ANEMIAPW"), mapping = aes(x = region, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 15)) +
  theme_classic() +
  theme(text = element_text(size = 14)) +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Median prevalence (%), 2015-2020", fill = NULL)

# ggsave("figures/AnaemiaPW_region_Medians2015-2020.png", width=9, height=5, units="in")


## risk factors preterm birth from gho ##

# WHS_PBR = Preterm birth rate (per 100 live births)


WHS_PBR <- fromJSON("https://ghoapi.azureedge.net/api/WHS_PBR")
WHS_PBR <- as.data.frame(WHS_PBR$value)

table(WHS_PBR$Dim1Type)


# join country info

WHS_PBR <- left_join(WHS_PBR, ref_country, by = c("SpatialDim" = "CODE_ISO_3"))

WHS_PBR <- WHS_PBR %>% filter(WHO_LEGAL_STATUS == "M")

# exclude pre 2010
WHS_PBR <- WHS_PBR %>% filter(TimeDim >= 2010)

WHS_PBR$period <- NA
WHS_PBR$period[WHS_PBR$TimeDim >= 2015 & WHS_PBR$TimeDim <= 2019] <- "2015-2019"
WHS_PBR$period[WHS_PBR$TimeDim <= 2014 & WHS_PBR$TimeDim >= 2010] <- "2010-2014"
table(WHS_PBR$period)

## only 2010 data ##

```

```{r mat-newb-coverage-xmart}

xmart <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AC_A4V%22,%22MN_IRTSYR%22,%22WCAH_ANCSYP%22,%22BC_FPSMM%22,%22BC_BASHP%22,%22CANUT_EBF%22,%22CANUT_EIBF%22,%22MN_ARV_PMTCT%22,%22TECI_ORS%22,%22TECI_ORSZINC%22,%22TECI_PNEUHCP%22,%22PNC_MOM%22,%22PNC_NB%22,%22AC_PAB%22,%22WCAH_DTP3%22,%22WCAH_MCV2%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,AGEGROUP_FK,Answer_FK,CauseGHE_FK,CauseGHEChild_FK,CauseENVCAUSE_FK,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# INDICATOR_FK,YEAR_FK,ValueNumeric,COUNTRY_FK ValueLow ValueHigh ValueStdDev ValueStdErr Comments COUNTRY_FK__CODE DatasourceLong RESIDENCEAREA_FK__CODE SEX_FK WEALTHQUINTILE_FK

MNH_coverage <- as.data.frame(xmart$value) 

# data last updated in 2022 - use this as a cut off july 2022, hiv is 2021 - may be updated again in july this year

# saveRDS(MNH_coverage, "data/MNH_coverage.rds")
# MNH_coverage <- read_rds("data/MNH_coverage.rds")

# which cols are NA

sapply(MNH_coverage, function(x) sum(is.na(x)))

MNH_coverage <- MNH_coverage %>% dplyr::select(where(~ !all(is.na(.x))))



# read in names from file to get actual indicators...

Indicators_MNHcoveragekp <- read_excel("data/data_export_MNCAH_DM_Indicators_MNHcoveragekp.xlsx") %>% filter(!is.na(INDICATOR_FK))

MNH_coverage <- left_join(MNH_coverage, Indicators_MNHcoveragekp[, c("INDICATOR_FK", "INDICATOR_TITLE (NOT A COLUMN IN DM_Indicators…just for reference)")], by = "INDICATOR_FK")

MNH_coverage$period <- NA
MNH_coverage$period[MNH_coverage$YEAR_FK >= 2020 & MNH_coverage$YEAR_FK <= 2024] <- "2020-2024"
MNH_coverage$period[MNH_coverage$YEAR_FK <= 2019 & MNH_coverage$YEAR_FK >= 2015] <- "2015-2019"
table(MNH_coverage$period)

# LMICs

MNH_coverage$indicator <- case_when(
  MNH_coverage$INDICATOR_FK == "AC_A4V" ~ "Antenatal care (4+)",
  MNH_coverage$INDICATOR_FK == "AC_PAB" ~ "Neonatal tetanus protection",
  MNH_coverage$INDICATOR_FK == "BC_BASHP" ~ "Skilled attendant at birth",
  MNH_coverage$INDICATOR_FK == "BC_FPSMM" ~ "Demand for family planning satisfied with modern methods",
  MNH_coverage$INDICATOR_FK == "CANUT_EIBF" ~ "Early initiation of breastfeeding",
  MNH_coverage$INDICATOR_FK == "CANUT_EBF" ~ "Exclusive breastfeeding (<6 months)",
  #  MNH_coverage$INDICATOR_FK=="MN_ARV_PMTCT"~"Treatment of pregnant women living with HIV",
  MNH_coverage$INDICATOR_FK == "MN_IRTSYR" ~ "Women with live births who recieved iron tablets/syrup at antenatal care",
  MNH_coverage$INDICATOR_FK == "WCAH_ANCSYP" ~ "Tested for syphilis at antenatal care",
  MNH_coverage$INDICATOR_FK == "WCAH_DTP3" ~ "DTP3 immuni-\nzation",
  MNH_coverage$INDICATOR_FK == "WCAH_MCV2" ~ "MCV2 immuni-\nzation",
  MNH_coverage$INDICATOR_FK == "PNC_NB" ~ "Postnatal visit for babies",
  MNH_coverage$INDICATOR_FK == "PNC_MOM" ~ "Postnatal visit for mothers"
)

MNH_coverage$continuum <- case_when(
  MNH_coverage$INDICATOR_FK == "AC_A4V" ~ "Antenatal",
  MNH_coverage$INDICATOR_FK == "AC_PAB" ~ "Antenatal",
  MNH_coverage$INDICATOR_FK == "BC_BASHP" ~ "Intrapartum",
  MNH_coverage$INDICATOR_FK == "BC_FPSMM" ~ "Pre- pregnancy",
  MNH_coverage$INDICATOR_FK == "CANUT_EIBF" ~ "Postnatal",
  MNH_coverage$INDICATOR_FK == "CANUT_EBF" ~ "Infancy",
  #  MNH_coverage$INDICATOR_FK=="MN_ARV_PMTCT"~"Antenatal",
  MNH_coverage$INDICATOR_FK == "MN_IRTSYR" ~ "Antenatal",
  MNH_coverage$INDICATOR_FK == "WCAH_ANCSYP" ~ "Antenatal",
  MNH_coverage$INDICATOR_FK == "WCAH_DTP3" ~ "Infancy",
  MNH_coverage$INDICATOR_FK == "WCAH_MCV2" ~ "Infancy",
  MNH_coverage$INDICATOR_FK == "PNC_NB" ~ "Postnatal",
  MNH_coverage$INDICATOR_FK == "PNC_MOM" ~ "Postnatal"
)

MNH_coverage$continuum <- factor(MNH_coverage$continuum, levels = c("Pre- pregnancy", "Antenatal", "Intrapartum", "Postnatal", "Infancy"))

MNH_coverage_ntl <- MNH_coverage %>%
  filter(is.na(MOTHEREDUCATION_FK) | MOTHEREDUCATION_FK == "All") %>%
  filter(is.na(RESIDENCEAREA_FK) | RESIDENCEAREA_FK == "ALL") %>%
  filter(is.na(SEX_FK) | SEX_FK == "BTSX") %>%
  filter(is.na(WEALTHQUINTILE_FK) | WEALTHQUINTILE_FK == "ALL") %>%
  filter(is.na(AGEGROUP_FK) | AGEGROUP_FK == "AGEALL") %>%
  filter(period == "2015-2019" | period == "2020-2024") %>%
  mutate(ind_country = paste0(INDICATOR_FK, COUNTRY_FK)) %>%
  filter(!is.na(continuum))

# how many duplicate estimates in a year
MNH_coverage_ntl <- MNH_coverage_ntl %>%
  group_by(COUNTRY_FK, INDICATOR_FK, YEAR_FK) %>%
  mutate(num = n())
table(MNH_coverage_ntl$num)

# Find countries with a data point in each time period
x <- MNH_coverage_ntl %>%
  mutate(one = 1) %>%
  group_by(ind_country, period) %>%
  summarise(sumone = sum(one)) %>%
  pivot_wider(names_from = period, values_from = sumone) %>%
  filter(!is.na(`2015-2019`) & !is.na(`2020-2024`))

MNH_coverage_ntl$bothPeriods[MNH_coverage_ntl$ind_country %in% x$ind_country] <- "both"

# country/area list from xmart: https://extranet.who.int/xmart4/REFMART/data/REF_COUNTRY
xmart_refCountry <- fromJSON("https://xmart-api-public.who.int/REFMART/REF_COUNTRY")
# INDICATOR_FK,YEAR_FK,ValueNumeric,COUNTRY_FK ValueLow ValueHigh ValueStdDev ValueStdErr Comments COUNTRY_FK__CODE DatasourceLong RESIDENCEAREA_FK__CODE SEX_FK WEALTHQUINTILE_FK

ref_country <- as.data.frame(xmart_refCountry$value)

# saveRDS(ref_country, "data/ref_country.rds")
# ref_country <- read_rds("data/ref_country.rds")

ref_country$region <- case_when(
  ref_country$GRP_WHO_REGION == "AFR" ~ "African Region",
  ref_country$GRP_WHO_REGION == "AMR" ~ "Region of the Americas",
  ref_country$GRP_WHO_REGION == "EMR" ~ "Eastern Mediterranean Region",
  ref_country$GRP_WHO_REGION == "EUR" ~ "European Region",
  ref_country$GRP_WHO_REGION == "SEAR" ~ "South-East Asia Region",
  ref_country$GRP_WHO_REGION == "WPR" ~ "Western Pacific Region"
)

MNH_coverage_ntl <- left_join(MNH_coverage_ntl, ref_country, by = c("COUNTRY_FK__CODE" = "CODE_ISO_3"))

MNH_coverage_ntl <- MNH_coverage_ntl %>% filter(WHO_LEGAL_STATUS == "M")

# remove multiple estimates from the same country in the same period
# find estimate closest to 2017 for 2010-2014 or most recent (if two equally close to 2012, take larger number)
MNH_coverage_ntl$diff <- NA
MNH_coverage_ntl$diff[MNH_coverage_ntl$period == "2015-2019"] <- abs(as.numeric(MNH_coverage_ntl$YEAR_FK[MNH_coverage_ntl$period == "2015-2019"]) - 2017)

mnc14 <- MNH_coverage_ntl %>%
  filter(period == "2015-2019") %>%
  group_by(ind_country) %>%
  filter(diff == min(diff, na.rm = T)) %>%
  filter(ValueNumeric == max(ValueNumeric)) %>%
  filter(row_number() == 1)

mnc19 <- MNH_coverage_ntl %>%
  filter(period == "2020-2024") %>%
  group_by(ind_country) %>%
  filter(YEAR_FK == max(YEAR_FK)) %>%
  filter(ValueNumeric == max(ValueNumeric)) %>%
  filter(row_number() == 1)

MNH_coverage_ntl_1419 <- as.data.frame(rbind(mnc14, mnc19))
rm(mnc14, mnc19)


medians_trend <- MNH_coverage_ntl_1419 %>%
  filter(bothPeriods == "both") %>%
  group_by(indicator, period, continuum) %>%
  summarise(medians = median(ValueNumeric, na.rm = T))

medians_recent <- MNH_coverage_ntl_1419 %>%
  filter(period == "2020-2024") %>%
  group_by(indicator, continuum) %>%
  summarise(medians = median(ValueNumeric, na.rm = T))

# Median trend bar plot

ggplot(medians_trend, aes(x = indicator, y = medians, fill = period)) +
  geom_col(position = position_dodge(width = 0.5)) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_fill_manual(values = c("#bdbdbd", "#009CDE")) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Median coverage (%)", fill = NULL) +
  ggforce::facet_row(~continuum, labeller = labeller(continuum = label_wrap_gen(8)), scales = "free", space = "free")

# ggsave("figures/MNHcoverage_trend_median2015-2024.png", width=9, height=5, units="in")

#anc only

ggplot(medians_trend %>% filter(continuum=="Antenatal"), aes(x = indicator, y = medians, fill = period)) +
  geom_col(position = position_dodge(width = 0.5)) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) +
  scale_fill_manual(values = c("#bdbdbd", "#009CDE")) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Median coverage (%)", fill = NULL) +
  ggforce::facet_row(~continuum, labeller = labeller(continuum = label_wrap_gen(8)), scales = "free", space = "free")

# ggsave("figures/MNHcoverage_Antenatal_trend_median2015-2024.png", width=9, height=5, units="in")



# recent coverage


ggplot(medians_recent, aes(x = indicator, y = medians)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(MNH_coverage_ntl %>% filter(period == "2020-2024") %>% group_by(ind_country) %>% filter(YEAR_FK == max(YEAR_FK)) %>% filter(ValueNumeric == max(ValueNumeric)) %>% filter(row_number() == 1), mapping = aes(x = indicator, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Median coverage (%), 2020-2024", fill = NULL) +
  ggforce::facet_row(~continuum, labeller = labeller(continuum = label_wrap_gen(8)), scales = "free", space = "free")

# ggsave("figures/MNHcoverage_recent_median2020-2024.png", width=9, height=5, units="in")


#antenatal only

ggplot(medians_recent %>% filter(continuum=="Antenatal"), aes(x = indicator, y = medians)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(MNH_coverage_ntl %>% filter(period == "2020-2024") %>% group_by(ind_country) %>% filter(YEAR_FK == max(YEAR_FK)) %>% filter(ValueNumeric == max(ValueNumeric)) %>% filter(row_number() == 1) %>% filter(continuum=="Antenatal"), mapping = aes(x = indicator, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20)) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Median coverage (%), 2020-2024", fill = NULL) +
  ggforce::facet_row(~continuum, labeller = labeller(continuum = label_wrap_gen(8)), scales = "free", space = "free")

# ggsave("figures/MNHcoverage_Antenatal_recent_median2020-2024.png", width=9, height=5, units="in")

# regional

medians_reg <- MNH_coverage_ntl_1419 %>%
  filter(INDICATOR_FK %in% c("AC_A4V", "BC_BASHP", "PNC_MOM", "PNC_NB", "CANUT_EIBF")) %>% 
  filter(period == "2020-2024") %>%
  group_by(indicator, region) %>%
  summarise(medians = median(ValueNumeric, na.rm = T))

ggplot(medians_reg, aes(x = indicator, y = medians)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(MNH_coverage_ntl %>% filter(INDICATOR_FK %in% c("AC_A4V", "BC_BASHP", "PNC_MOM", "PNC_NB", "CANUT_EIBF"))%>% filter(period == "2020-2024") %>% group_by(ind_country) %>% filter(YEAR_FK == max(YEAR_FK)) %>% filter(ValueNumeric == max(ValueNumeric)) %>% filter(row_number() == 1), mapping = aes(x = indicator, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  #scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, size = 10, vjust = 0.5, hjust = 1)) +
  labs(x = NULL, y = "Median coverage (%), 2020-2024", fill = NULL) +
  ggforce::facet_row(~region, labeller = labeller(region = label_wrap_gen(8)), scales = "free", space = "free")

# ggsave("figures/MNHcoverage_region_recent_medians2020-24.png", width=9, height=5, units="in")



## wealth

MNH_coverage_wealth <- MNH_coverage %>%
  filter(!is.na(WEALTHQUINTILE_FK)) %>%
  group_by(INDICATOR_FK, COUNTRY_FK) %>%
  filter(YEAR_FK == max(YEAR_FK)) %>%
  mutate(minVal = min(ValueNumeric), maxVal = max(ValueNumeric), disparity = maxVal - minVal, num = n(), country_yr = paste0(COUNTRY_FK, ", ", YEAR_FK)) %>%
  filter(num >= 5) %>%
  filter(YEAR_FK >= 2010)

MNH_coverage_wealth <- left_join(MNH_coverage_wealth, ref_country, by = c("COUNTRY_FK__CODE" = "CODE_ISO_3"))
MNH_coverage_wealth <- MNH_coverage_wealth %>% filter(WHO_LEGAL_STATUS == "M")

# PNC baby

ggplot(MNH_coverage_wealth %>% filter(INDICATOR_FK == "PNC_NB")) +
  geom_segment(aes(x = reorder(country_yr, disparity), xend = reorder(country_yr, disparity), y = minVal, yend = maxVal)) +
  geom_point(data = MNH_coverage_wealth %>% filter(INDICATOR_FK == "PNC_NB") %>% filter(WEALTHQUINTILE_FK != "ALL"), aes(x = country_yr, y = ValueNumeric, color = WEALTHQUINTILE_FK), size = 3) +
  geom_point(data = MNH_coverage_wealth %>% filter(INDICATOR_FK == "PNC_NB") %>% filter(WEALTHQUINTILE_FK == "ALL"), aes(x = country_yr, y = ValueNumeric, shape = WEALTHQUINTILE_FK)) +
  coord_flip() +
  scale_color_manual(name = "Wealth quintile", labels = c("Poorest", "Poorer", "Middle", "Richer", "Richest"), values = c("#a6bddb", "#74a9cf", "#3690c0", "#0570b0", "#034e7b"), breaks = c("WQ1", "WQ2", "WQ3", "WQ4", "WQ5")) +
  scale_shape_manual(name = NULL, labels = c("All"), values = c(8)) +
  theme_classic() +
  labs(y = "Coverage (%)", x = NULL)

summary(MNH_coverage_wealth$disparity[MNH_coverage_wealth$INDICATOR_FK == "PNC_NB"])

MNH_coverage_wealth$disparity_pncnb[MNH_coverage_wealth$disparity < 13.6] <- "Smaller inequalities"
MNH_coverage_wealth$disparity_pncnb[MNH_coverage_wealth$disparity >= 13.6] <- "Larger inequalities"

ggplot(MNH_coverage_wealth %>% filter(INDICATOR_FK == "PNC_NB")) +
  geom_segment(aes(x = reorder(country_yr, minVal), xend = reorder(country_yr, minVal), y = minVal, yend = maxVal)) +
  geom_point(data = MNH_coverage_wealth %>% filter(INDICATOR_FK == "PNC_NB") %>% filter(WEALTHQUINTILE_FK != "ALL"), aes(x = country_yr, y = ValueNumeric, color = WEALTHQUINTILE_FK), size = 3) +
  geom_point(data = MNH_coverage_wealth %>% filter(INDICATOR_FK == "PNC_NB") %>% filter(WEALTHQUINTILE_FK == "ALL"), aes(x = country_yr, y = ValueNumeric, shape = WEALTHQUINTILE_FK)) +
  coord_flip() +
  scale_color_manual(name = "Wealth quintile", labels = c("Poorest", "Poorer", "Middle", "Richer", "Richest"), values = c("#a6bddb", "#74a9cf", "#3690c0", "#0570b0", "#034e7b"), breaks = c("WQ1", "WQ2", "WQ3", "WQ4", "WQ5")) +
  scale_shape_manual(name = NULL, labels = c("All"), values = c(8)) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(y = "Coverage (%)", x = NULL) +
  facet_wrap(~disparity_pncnb, scales = "free_y")

# ggsave("figures/MNHcoverage_wealth_pncNB_2016-2022.png", width=9, height=5, units="in")

summary(MNH_coverage_wealth$disparity[MNH_coverage_wealth$INDICATOR_FK == "PNC_MOM"])

MNH_coverage_wealth$disparity_pncmom[MNH_coverage_wealth$disparity < 20.1] <- "Smaller inequalities"
MNH_coverage_wealth$disparity_pncmom[MNH_coverage_wealth$disparity >= 20.1] <- "Larger inequalities"

ggplot(MNH_coverage_wealth %>% filter(INDICATOR_FK == "PNC_MOM")) +
  geom_segment(aes(x = reorder(country_yr, minVal), xend = reorder(country_yr, minVal), y = minVal, yend = maxVal)) +
  geom_point(data = MNH_coverage_wealth %>% filter(INDICATOR_FK == "PNC_MOM") %>% filter(WEALTHQUINTILE_FK != "ALL"), aes(x = country_yr, y = ValueNumeric, color = WEALTHQUINTILE_FK), size = 3) +
  geom_point(data = MNH_coverage_wealth %>% filter(INDICATOR_FK == "PNC_MOM") %>% filter(WEALTHQUINTILE_FK == "ALL"), aes(x = country_yr, y = ValueNumeric, shape = WEALTHQUINTILE_FK)) +
  coord_flip() +
  scale_color_manual(name = "Wealth quintile", labels = c("Poorest", "Poorer", "Middle", "Richer", "Richest"), values = c("#a6bddb", "#74a9cf", "#3690c0", "#0570b0", "#034e7b"), breaks = c("WQ1", "WQ2", "WQ3", "WQ4", "WQ5")) +
  scale_shape_manual(name = NULL, labels = c("All"), values = c(8)) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(y = "Coverage (%)", x = NULL) +
  facet_wrap(~disparity_pncmom, scales = "free_y")

# ggsave("figures/MNHcoverage_wealth_pncMOM_2016-2022.png", width=9, height=5, units="in")


##### new attempt at inequities plots pnc

MNH_coverage_inequ <- MNH_coverage %>%
  pivot_longer(cols = c(WEALTHQUINTILE_FK, MOTHEREDUCATION_FK, RESIDENCEAREA_FK), names_to = "DimensionType") %>% # reshape so dimensions all in one column
  filter(!is.na(value)) %>%
  filter(str_to_lower(value) != "all") %>% # remove rows which aren't an equity dimension
  group_by(INDICATOR_FK, COUNTRY_FK, DimensionType) %>%
  filter(YEAR_FK == max(YEAR_FK)) %>% # most recent year for every indicator/country/dimension combo
  mutate(minVal = min(ValueNumeric), maxVal = max(ValueNumeric), disparity = maxVal - minVal, num = n(), country_yr = paste0(COUNTRY_FK, ", ", YEAR_FK)) %>% # caluclate disparities
  filter(YEAR_FK >= 2010) %>% # only keep data since 2010
  left_join(ref_country[, c("CODE_ISO_3", "WHO_LEGAL_STATUS", "NAME_SHORT_EN")], by = c("COUNTRY_FK__CODE" = "CODE_ISO_3")) %>% # get official name
  filter(WHO_LEGAL_STATUS == "M") %>% # make sure it's just member states
  #  group_by(INDICATOR_FK, DimensionType) %>%
  #  mutate(tercile=ntile(disparity,3)) %>% #calculate tercile for better plotting
  rename("dimension" = value) # %>%

MNH_coverage_inequ$dimension[MNH_coverage_inequ$dimension == "None"] <- "No education"
MNH_coverage_inequ$dimension[MNH_coverage_inequ$dimension == ""] <- "No education"
MNH_coverage_inequ$dimension[MNH_coverage_inequ$dimension == ""] <- "No education"

# tercile based on one value per country , make smaller df and then join
x <- MNH_coverage_inequ %>%
  group_by(COUNTRY_FK, DimensionType, INDICATOR_FK) %>%
  slice_head(n = 1) %>%
  group_by(INDICATOR_FK, DimensionType) %>%
  mutate(tercile = ntile(disparity, 3)) # %>% group_by(IndicatorCode, iso3) %>% mutate(tercile=round(mean(tercile),0))
table(x$tercile)

MNH_coverage_inequ <- left_join(MNH_coverage_inequ, x[, c("COUNTRY_FK", "INDICATOR_FK", "DimensionType", "tercile")], by = c("COUNTRY_FK", "INDICATOR_FK", "DimensionType"))
table(MNH_coverage_inequ$tercile)

interventions <- c("PNC_MOM", "PNC_NB")

disparity_labs <- c("1" = "Smallest inequalities", "2" = "Middle inequalities", "3" = "Largest inequalities")


for (i in 1:length(interventions)) {
  ggplot(MNH_coverage_inequ %>% filter(DimensionType == "WEALTHQUINTILE_FK") %>% filter(INDICATOR_FK == interventions[i])) +
    geom_segment(aes(x = reorder(NAME_SHORT_EN, minVal), xend = reorder(NAME_SHORT_EN, minVal), y = minVal, yend = maxVal)) +
    geom_point(data = MNH_coverage_inequ %>% filter(DimensionType == "WEALTHQUINTILE_FK") %>% filter(INDICATOR_FK == interventions[i]), aes(x = NAME_SHORT_EN, y = ValueNumeric, color = dimension), size = 3) +
    coord_flip() +
    scale_colour_manual(values = c("#7b3294", "#c2a5cf", "#e0e0e0", "#a6dba0", "#008837"), labels = c("Poorest", "Q2", "Q3", "Q4", "Wealthiest")) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(y = "Coverage (%)", x = NULL, colour = "Wealth quintile") +
    facet_wrap(~tercile, scales = "free_y", labeller = as_labeller(disparity_labs)) +
    guides(colour = guide_legend(nrow = 1))

  # ggsave(paste0("figures/inequalities_", interventions[i], "_decile_xmart.png"), width = 13, height = 7, units = "in")

  # education

  # no edu for PNC

  # residence

  ggplot(MNH_coverage_inequ %>% filter(DimensionType == "RESIDENCEAREA_FK") %>% filter(INDICATOR_FK == interventions[i])) +
    geom_segment(aes(x = reorder(NAME_SHORT_EN, minVal), xend = reorder(NAME_SHORT_EN, minVal), y = minVal, yend = maxVal)) +
    geom_point(data = MNH_coverage_inequ %>% filter(DimensionType == "RESIDENCEAREA_FK") %>% filter(INDICATOR_FK == interventions[i]), aes(x = NAME_SHORT_EN, y = ValueNumeric, color = dimension), size = 3) +
    coord_flip() +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
    scale_y_continuous(limits = c(0, 100)) +
    scale_colour_manual(labels = c("Rural", "Urban"), values = c("#33a02c", "#1f78b4")) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(y = "Coverage (%)", x = NULL, colour = "Place of residence") +
    facet_wrap(~tercile, scales = "free_y", labeller = as_labeller(disparity_labs)) +
    guides(colour = guide_legend(nrow = 1))

  # ggsave(paste0("figures/inequalities_", interventions[i], "_resid_xmart.png"), width = 13, height = 7, units = "in")
}

```

```{r mat-newb-coverage-old}

# maternal newborn coverage data from unicef portal

MN_coverage <- read_excel("data/external/Maternal-and-Newborn-Health-Coverage-Database-August-2021.xlsx", sheet = "Long Form")

# population data from WPP

wpp <- read_excel("data/external/WPP2019_POP_F01_1_TOTAL_POPULATION_BOTH_SEXES.xlsx", skip = 16) %>% filter(Type == "Country/Area")
wpp$iso3 <- countrycode(wpp$`Region, subregion, country or area *`, origin = "country.name", destination = "iso3c")
wpp$`Region, subregion, country or area *`[is.na(wpp$iso3)]

MN_coverage <- left_join(MN_coverage, wpp[, c("iso3", "2010", "2020")], by = c("ISO Code" = "iso3"))

# test can match UNICEF global estimate

ANC1 <- MN_coverage %>% filter(Indicator == "ANC1")

ANC1_recent <- ANC1 %>%
  group_by(`ISO Code`) %>%
  filter(`Latest Year` == max(`Latest Year`)) %>%
  filter(Level == "National") %>%
  filter(Value == max(Value)) %>%
  filter(`Latest Year` >= 2014)

ANC1_recent$covered <- (ANC1_recent$Value / 100) * as.numeric(ANC1_recent$`2020`)

sum(ANC1_recent$covered, na.rm = T) / sum(as.numeric(ANC1_recent$`2020`), na.rm = T)

# aggregates
# notes from unicef file:
# Global and Regional Aggregates (UNICEF Reporting Regions, Sub-Regions, Programme Regions and World Bank income groups 2020)
# For 2007-2013, global and regional aggregates are calculated using the data point closest to the mid-point (2010) for each country.
# For 2014-2020, global and regional aggregates are calculated using the most recent data point for each country.
# Global and regional aggregates are calculated using 2010 and 2020 population weights from WPP 2019 (United Nations, Department of Economic and Social Affairs, Population Division 2019)
# Note: Global and regional estimates are not shown where the population coverage is below 50%.

MN_coverage$period <- NA
MN_coverage$period[MN_coverage$`Latest Year` >= 2014] <- "2014-2020"
MN_coverage$period[MN_coverage$`Latest Year` <= 2013 & MN_coverage$`Latest Year` >= 2007] <- "2007-2013"
table(MN_coverage$period)

# exclude prior to 2007
MN_coverage0720 <- MN_coverage %>% filter(`Latest Year` > 2007)

# find estimate closest to 2010 for 2007-2013 or most recent
MN_coverage0720$diff <- NA
MN_coverage0720$diff[MN_coverage0720$period == "2007-2013"] <- abs(MN_coverage0720$`Latest Year`[MN_coverage0720$period == "2007-2013"] - 2010)

mnc07 <- MN_coverage0720 %>%
  filter(period == "2007-2013") %>%
  group_by(`ISO Code`, Level, Indicator) %>%
  filter(diff == min(diff, na.rm = T)) %>%
  filter(Value == max(Value)) %>%
  filter(row_number() == 1)
mnc07$covered[mnc07$Level == "National"] <- mnc07$Value[mnc07$Level == "National"] * as.numeric(mnc07$`2010`[mnc07$Level == "National"])

mnc20 <- MN_coverage0720 %>%
  filter(period == "2014-2020") %>%
  group_by(`ISO Code`, Level, Indicator) %>%
  filter(`Latest Year` == max(`Latest Year`)) %>%
  filter(Value == max(Value)) %>%
  filter(row_number() == 1)
mnc20$covered[mnc20$Level == "National"] <- mnc20$Value[mnc20$Level == "National"] * as.numeric(mnc20$`2020`[mnc20$Level == "National"])

MN_coverage0720 <- as.data.frame(rbind(mnc07, mnc20))
rm(mnc07, mnc20)
MN_coverage0720$population <- NA
MN_coverage0720$population[MN_coverage0720$period == "2007-2013"] <- as.numeric(MN_coverage0720$`2010`)[MN_coverage0720$period == "2007-2013"]
MN_coverage0720$population[MN_coverage0720$period == "2014-2020"] <- as.numeric(MN_coverage0720$`2020`)[MN_coverage0720$period == "2014-2020"]


# create pooled estimate for each indicator

MNcoverage_summary <- MN_coverage0720 %>%
  filter(Level == "National") %>%
  group_by(Indicator, period) %>%
  summarise(coverage = sum(covered, na.rm = T) / sum(population, na.rm = T))

ggplot(MNcoverage_summary, aes(x = Indicator, y = coverage, fill = period)) +
  geom_col(position = position_dodge(width = 0.5)) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Coverage (%)", fill = NULL)

```

```{r equity}

# carep - "Children aged < 5 years with pneumonia symptoms taken to a health facility (%)"
# ors - "Children aged < 5 years with diarrhoea receiving oral rehydration salts (%)"
# sba - "Births attended by skilled health personnel (in the two or three years preceding the survey) (%)"

# x <- fromJSON("https://ghoapi.azureedge.net/api?$filter=IndicatorCode%20in%20(%22sba%22,%22ors%22)")
# x2 <- as.data.frame(x$value)

sba <- fromJSON("https://ghoapi.azureedge.net/api/sba")
sba <- as.data.frame(sba$value)

ors <- fromJSON("https://ghoapi.azureedge.net/api/ors")
ors <- as.data.frame(ors$value)

carep <- fromJSON("https://ghoapi.azureedge.net/api/carep")
carep <- as.data.frame(carep$value)

gho <- rbind(sba, ors, carep)
gho$iso3 <- substr(gho$SpatialDim, 1, 3)
gho$Dim1Type[is.na(gho$Dim1Type) & gho$SpatialDimType == "DHSMICSGEOREGION"] <- "SUBNATIONAL"

gho <- gho %>%
  filter(TimeDim >= 2010) %>%
  group_by(iso3, IndicatorCode, Dim1Type) %>%
  filter(TimeDim == max(TimeDim)) %>%
  mutate(minVal = min(NumericValue, na.rm = T), maxVal = max(NumericValue, na.rm = T), disparity = maxVal - minVal) # %>% group_by(IndicatorCode, SpatialDimType) %>% mutate(tercile = ntile(disparity, 3)) %>% group_by(IndicatorCode, SpatialDimType, iso3) %>% mutate(tercile=round(mean(tercile),0))

# for subnational, need to get tercile based on one value per country due to differenting number of regions per country, make smaller df and then join
x <- gho %>%
  group_by(iso3, Dim1Type, IndicatorCode) %>%
  slice_head(n = 1) %>%
  group_by(IndicatorCode, Dim1Type) %>%
  mutate(tercile = ntile(disparity, 3)) # %>% group_by(IndicatorCode, iso3) %>% mutate(tercile=round(mean(tercile),0))
table(x$tercile)

gho <- left_join(gho, x[, c("iso3", "IndicatorCode", "Dim1Type", "tercile")], by = c("iso3", "IndicatorCode", "Dim1Type"))
table(gho$tercile)

# country/area list from xmart: https://extranet.who.int/xmart4/REFMART/data/REF_COUNTRY
xmart_refCountry <- fromJSON("https://xmart-api-public.who.int/REFMART/REF_COUNTRY")
# INDICATOR_FK,YEAR_FK,ValueNumeric,COUNTRY_FK ValueLow ValueHigh ValueStdDev ValueStdErr Comments COUNTRY_FK__CODE DatasourceLong RESIDENCEAREA_FK__CODE SEX_FK WEALTHQUINTILE_FK

ref_country <- as.data.frame(xmart_refCountry$value)
ref_country_members <- ref_country %>% filter(WHO_LEGAL_STATUS == "M")

# saveRDS(ref_country, "data/ref_country.rds")
# ref_country <- read_rds("data/ref_country.rds")

gho <- left_join(gho, ref_country_members, by = c("iso3" = "CODE_ISO_3")) 
gho <- gho %>% filter(!is.na(NumericValue))

interventions <- unique(gho$IndicatorCode)
disparity_labs <- c("1" = "Smallest inequalities", "2" = "Middle inequalities", "3" = "Largest inequalities")
### to loop ####

for (i in 1:length(interventions)) {

  # wealth

  ggplot(gho %>% filter(Dim1Type == "WEALTHDECILE") %>% filter(IndicatorCode == interventions[i]) %>% group_by(NAME_SHORT_EN) %>% mutate(n=n()) %>% filter(n>5)) +
    geom_segment(aes(x = reorder(NAME_SHORT_EN, minVal), xend = reorder(NAME_SHORT_EN, minVal), y = minVal, yend = maxVal)) +
    geom_point(data = gho %>% filter(Dim1Type == "WEALTHDECILE") %>% filter(IndicatorCode == interventions[i])  %>% group_by(NAME_SHORT_EN) %>% mutate(n=n()) %>% filter(n>5), aes(x = NAME_SHORT_EN, y = NumericValue, color = Dim1), size = 3) +
    coord_flip() +
    scale_colour_brewer(palette = "PRGn", labels = c("Poorest", "D2", "D3", "D4", "D5", "D6", "D7", "D8", "D9", "Wealthiest")) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
    scale_y_continuous(limits = c(0, 100)) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(y = "Coverage (%)", x = NULL, colour = "Wealth decile") +
    facet_wrap(~tercile, scales = "free_y", labeller = as_labeller(disparity_labs)) +
    guides(colour = guide_legend(nrow = 1))

  x <- length(unique(gho$iso3[gho$Dim1Type == "WEALTHDECILE" & gho$IndicatorCode == interventions[i]])) #### fix this to reflect those with >5 #### left off here ####

   # ggsave(paste0("figures/inequalities_", interventions[i],x,"_decile_gho.png"), width=13, height=7, units="in")

  # education

  ggplot(gho %>% filter(Dim1Type == "EDUCATIONLEVEL") %>% filter(IndicatorCode == interventions[i])) +
    geom_segment(aes(x = reorder(NAME_SHORT_EN, minVal), xend = reorder(NAME_SHORT_EN, minVal), y = minVal, yend = maxVal)) +
    geom_point(data = gho %>% filter(Dim1Type == "EDUCATIONLEVEL") %>% filter(IndicatorCode == interventions[i]), aes(x = NAME_SHORT_EN, y = NumericValue, color = Dim1), size = 3) +
    coord_flip() +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
    scale_y_continuous(limits = c(0, 100)) +
    scale_colour_manual(labels = c("No education", "Primary school", "Secondary school +"), values = c("#d95f02", "#7570b3", "#1b9e77")) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(y = "Coverage (%)", x = NULL, colour = "Mother's education") +
    facet_wrap(~tercile, scales = "free_y", labeller = as_labeller(disparity_labs)) +
    guides(colour = guide_legend(nrow = 1))

  x <- length(unique(gho$iso3[gho$Dim1Type == "EDUCATIONLEVEL" & gho$IndicatorCode == interventions[i]]))

   # ggsave(paste0("figures/inequalities_", interventions[i],x,"_edu_gho.png"), width=13, height=7, units="in")

  # residence

  ggplot(gho %>% filter(Dim1Type == "RESIDENCEAREATYPE") %>% filter(IndicatorCode == interventions[i])) +
    geom_segment(aes(x = reorder(NAME_SHORT_EN, minVal), xend = reorder(NAME_SHORT_EN, minVal), y = minVal, yend = maxVal)) +
    geom_point(data = gho %>% filter(Dim1Type == "RESIDENCEAREATYPE") %>% filter(IndicatorCode == interventions[i]), aes(x = NAME_SHORT_EN, y = NumericValue, color = Dim1), size = 3) +
    coord_flip() +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
    scale_y_continuous(limits = c(0, 100)) +
    scale_colour_manual(labels = c("Rural", "Urban"), values = c("#33a02c", "#1f78b4")) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(y = "Coverage (%)", x = NULL, colour = "Place of residence") +
    facet_wrap(~tercile, scales = "free_y", labeller = as_labeller(disparity_labs)) +
    guides(colour = guide_legend(nrow = 1))

  x <- length(unique(gho$iso3[gho$Dim1Type == "RESIDENCEAREATYPE" & gho$IndicatorCode == interventions[i]]))

   # ggsave(paste0("figures/inequalities_", interventions[i],x,"_resid_gho.png"), width=13, height=7, units="in")

  # Subnational region

  ggplot(gho %>% filter(Dim1Type == "SUBNATIONAL") %>% filter(IndicatorCode == interventions[i])) +
    geom_segment(aes(x = reorder(NAME_SHORT_EN, minVal), xend = reorder(NAME_SHORT_EN, minVal), y = minVal, yend = maxVal)) +
    geom_point(data = gho %>% filter(Dim1Type == "SUBNATIONAL") %>% filter(IndicatorCode == interventions[i]), aes(x = NAME_SHORT_EN, y = NumericValue), colour = "#8da0cb", alpha = .7, size = 3) +
    coord_flip() +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 25)) +
    scale_y_continuous(limits = c(0, 100)) +
    theme_classic() +
    theme(legend.position = "bottom") +
    labs(y = "Coverage (%)", x = NULL) +
    facet_wrap(~tercile, scales = "free_y", labeller = as_labeller(disparity_labs)) +
    guides(colour = guide_legend(nrow = 1))

  x <- length(unique(gho$iso3[gho$Dim1Type == "SUBNATIONAL" & gho$IndicatorCode == interventions[i]]))

   # ggsave(paste0("figures/inequalities_", interventions[i],x,"_subnatRegion_gho.png"), width=13, height=7, units="in")
}

```

```{r child cov}

xmart <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22TECI_ORS%22,%22TECI_ORSZINC%22,%22TECI_PNEUHCP%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")

child <- as.data.frame(xmart$value)

# country/area list from xmart: https://extranet.who.int/xmart4/REFMART/data/REF_COUNTRY
xmart_refCountry <- fromJSON("https://xmart-api-public.who.int/REFMART/REF_COUNTRY")
# INDICATOR_FK,YEAR_FK,ValueNumeric,COUNTRY_FK ValueLow ValueHigh ValueStdDev ValueStdErr Comments COUNTRY_FK__CODE DatasourceLong RESIDENCEAREA_FK__CODE SEX_FK WEALTHQUINTILE_FK

ref_country <- as.data.frame(xmart_refCountry$value)
ref_country_members <- ref_country %>% filter(WHO_LEGAL_STATUS == "M")

# saveRDS(ref_country, "data/ref_country.rds")
# ref_country <- read_rds("data/ref_country.rds")

ref_country$region <- case_when(
  ref_country$GRP_WHO_REGION == "AFR" ~ "African Region",
  ref_country$GRP_WHO_REGION == "AMR" ~ "Region of the Americas",
  ref_country$GRP_WHO_REGION == "SEAR" ~ "South-East Asian Region",
  ref_country$GRP_WHO_REGION == "EUR" ~ "European Region",
  ref_country$GRP_WHO_REGION == "EMR" ~ "Eastern Mediterranean Region",
  ref_country$GRP_WHO_REGION == "WPR" ~ "Western Pacific Region"
)

child <- left_join(child, ref_country, by = c("COUNTRY_FK__CODE" = "CODE_ISO_3"))

child <- child %>%
  filter(is.na(MOTHEREDUCATION_FK) | MOTHEREDUCATION_FK == "All") %>%
  filter(is.na(RESIDENCEAREA_FK) | RESIDENCEAREA_FK == "ALL") %>%
  filter(is.na(SEX_FK) | SEX_FK == "BTSX") %>%
  filter(is.na(WEALTHQUINTILE_FK) | WEALTHQUINTILE_FK == "ALL") %>%
  filter(is.na(AGEGROUP_FK) | AGEGROUP_FK == "AGEALL") %>%
  mutate(year = as.numeric(YEAR_FK)) %>%
  filter(year >= 2010) %>%
  group_by(COUNTRY_FK__CODE, INDICATOR_FK) %>%
  filter(year == max(year)) %>%
  group_by(region, INDICATOR_FK) %>%
  mutate(medians = median(ValueNumeric), indicator = case_when(INDICATOR_FK == "TECI_ORS" ~ "Diarrhoea - given ORS", INDICATOR_FK == "TECI_ORSZINC" ~ "Diarrhoea - given ORS and zinc", INDICATOR_FK == "TECI_PNEUHCP" ~ "Suspected pneumonia - taken to provider"))

ggplot(child %>% filter(INDICATOR_FK != "TECI_ORSZINC"), aes(x = region, y = medians)) +
  geom_col(position = position_dodge(width = 0.5), fill = "#009CDE") +
  geom_point(child %>% filter(INDICATOR_FK != "TECI_ORSZINC"), mapping = aes(x = region, y = ValueNumeric), position = "jitter", alpha = .5, colour = "#08519c") +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 8)) +
  theme_classic() +
  theme(text = element_text(size = 18)) +
  theme(legend.position = "bottom") +
  labs(x = NULL, y = "Median prevalence (%), 2010-2022", fill = NULL) +
  facet_wrap(~ str_wrap(indicator, 50))

# ggsave("figures/child_coverage_medians2010-22.png", width=13, height=7, units="in")

```

```{r aging}
# country/area list from xmart: https://extranet.who.int/xmart4/REFMART/data/REF_COUNTRY
xmart_refCountry <- fromJSON("https://xmart-api-public.who.int/REFMART/REF_COUNTRY")
# INDICATOR_FK,YEAR_FK,ValueNumeric,COUNTRY_FK ValueLow ValueHigh ValueStdDev ValueStdErr Comments COUNTRY_FK__CODE DatasourceLong RESIDENCEAREA_FK__CODE SEX_FK WEALTHQUINTILE_FK

ref_country <- as.data.frame(xmart_refCountry$value)
ref_country_members <- ref_country %>% filter(WHO_LEGAL_STATUS == "M")

# saveRDS(ref_country, "data/ref_country.rds")
# ref_country <- read_rds("data/ref_country.rds")

ref_country$region <- case_when(
  ref_country$GRP_WHO_REGION == "AFR" ~ "African Region",
  ref_country$GRP_WHO_REGION == "AMR" ~ "Region of the Americas",
  ref_country$GRP_WHO_REGION == "SEAR" ~ "South-East Asian Region",
  ref_country$GRP_WHO_REGION == "EUR" ~ "European Region",
  ref_country$GRP_WHO_REGION == "EMR" ~ "Eastern Mediterranean Region",
  ref_country$GRP_WHO_REGION == "WPR" ~ "Western Pacific Region"
)


# xmart1 <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AGE_OVER60PCT%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# 
# xmart2 <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AGE_OVER80PCT%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# 
# xmart3 <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AGE_LE60%22,%22AGE_HALE60%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# 
# ##
# xmart4 <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AGE_MORT_TOP10%22)%20and%20YEAR_FK%20in%20(%222019%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# 
# xmart5 <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AGE_YLD%22)%20and%20YEAR_FK%20in%20(%222019%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# ##
# 
# xmart6 <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AGE_OBESITY%22,%22AGE_INSUFACT%22,%22AGE_RESIDE%22,%22AGE_LABOUR%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# 
# xmart7 <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AGE_RESIDELTA%22,%22AGE_FALL%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# 
# xmart8 <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?$filter=INDICATOR_FK%20in%20(%22AGE_BACKPAIN%22,%22AGE_AGEIST%22,%22AGE_ABUSE%22)&$select=INDICATOR_FK,YEAR_FK,COUNTRY_FK,COUNTRY_FK__CODE,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# 
# aging <- rbind(as.data.frame(xmart1$value), as.data.frame(xmart2$value), as.data.frame(xmart3$value), as.data.frame(xmart4$value), as.data.frame(xmart5$value), as.data.frame(xmart6$value), as.data.frame(xmart7$value), as.data.frame(xmart8$value))
# 
# 
# 
# saveRDS(aging, "data/aging.rds")

aging <- readRDS("data/aging.rds")

aging <- left_join(aging, ref_country, by = c("COUNTRY_FK__CODE" = "CODE_ISO_3"))


# match latest for each sex to wpp pop data

# # 2019
# # both sexes
# wpp <- read_excel("data/external/WPP2019_POP_F01_1_TOTAL_POPULATION_BOTH_SEXES.xlsx", skip = 16) %>% filter(Type == "Country/Area")
# wpp$iso3 <- countrycode(wpp$`Region, subregion, country or area *`, origin = "country.name", destination = "iso3c")
# wpp$`Region, subregion, country or area *`[is.na(wpp$iso3)]
# wpp$iso3[wpp$`Region, subregion, country or area *` == "Channel Islands"] <- "CHI"
# 
# aging <- left_join(aging, wpp[, c("iso3", "2019")], by = c("COUNTRY_FK__CODE" = "iso3")) %>% rename("btsx_2019" = `2019`)
# 
# # male
# wppm <- read_excel("data/external/WPP2019_POP_F01_2_TOTAL_POPULATION_MALE.xlsx", skip = 16) %>% filter(Type == "Country/Area")
# wppm$iso3 <- countrycode(wppm$`Region, subregion, country or area *`, origin = "country.name", destination = "iso3c")
# wppm$`Region, subregion, country or area *`[is.na(wppm$iso3)]
# wppm$iso3[wppm$`Region, subregion, country or area *` == "Channel Islands"] <- "CHI"
# 
# aging <- left_join(aging, wppm[, c("iso3", "2019")], by = c("COUNTRY_FK__CODE" = "iso3")) %>% rename("male_2019" = `2019`)
# 
# # female
# wppf <- read_excel("data/external/WPP2019_POP_F01_3_TOTAL_POPULATION_FEMALE.xlsx", skip = 16) %>% filter(Type == "Country/Area")
# wppf$iso3 <- countrycode(wppf$`Region, subregion, country or area *`, origin = "country.name", destination = "iso3c")
# wppf$`Region, subregion, country or area *`[is.na(wppf$iso3)]
# wppf$iso3[wppf$`Region, subregion, country or area *` == "Channel Islands"] <- "CHI"
# 
# aging <- left_join(aging, wppf[, c("iso3", "2019")], by = c("COUNTRY_FK__CODE" = "iso3")) %>% rename("female_2019" = `2019`)

# 2024
# https://population.un.org/wpp/Download/Standard/MostUsed/ - compact file 
# https://population.un.org/wpp/assets/Excel%20Files/1_Indicator%20(Standard)/EXCEL_FILES/1_General/WPP2024_GEN_F01_DEMOGRAPHIC_INDICATORS_COMPACT.xlsx

wpp <- read_excel("data/external/WPP2024_GEN_F01_DEMOGRAPHIC_INDICATORS_COMPACT.xlsx", skip = 16) %>% filter(Type == "Country/Area" & Year==2023)
wpp$iso3 <- countrycode(wpp$`Region, subregion, country or area *`, origin = "country.name", destination = "iso3c")
table(wpp$`Region, subregion, country or area *`[is.na(wpp$iso3)])
wpp$iso3[wpp$`Region, subregion, country or area *`=="Türkiye"] <- "TUR"

aging <- left_join(aging, wpp[, c("iso3", "Total Population, as of 1 July (thousands)", "Female Population, as of 1 July (thousands)", "Male Population, as of 1 July (thousands)")], by = c("COUNTRY_FK__CODE" = "iso3")) %>% rename("btsx_2023" = `Total Population, as of 1 July (thousands)`, "male_2023" = `Male Population, as of 1 July (thousands)`, "female_2023" = `Female Population, as of 1 July (thousands)`)


## map - percent of persons 60+


AGE_OVER60PCT <- aging %>%
  filter(INDICATOR_FK == "AGE_OVER60PCT") %>%
  filter(YEAR_FK <= 2023) %>%
  filter(SEX_FK == "BTSX") %>%
  group_by(COUNTRY_FK__CODE) %>%
  filter(YEAR_FK == max(YEAR_FK)) %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M")

AGE_OVER60PCT20302050 <- aging %>%
  filter(INDICATOR_FK == "AGE_OVER60PCT") %>%
  filter(YEAR_FK == 2023 | YEAR_FK == 2030 | YEAR_FK == 2050) %>%
  filter(SEX_FK == "BTSX") %>%
  group_by(COUNTRY_FK__CODE) %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  dplyr::select(COUNTRY_FK__CODE, ValueNumeric, YEAR_FK) %>%
  pivot_wider(id_cols = COUNTRY_FK__CODE, names_from = YEAR_FK, values_from = ValueNumeric, names_prefix = "y")

# write.csv(AGE_OVER60PCT, "ArcGIS/AGE_OVER60PCT.csv")
# write.csv(AGE_OVER60PCT20302050, "ArcGIS/AGE_OVER60PCT20302050.csv", row.names = F)

#### new who map package

library(devtools)
devtools::install_github("whocov/whomapper", 
                          force = TRUE, 
                          dependencies = TRUE)

library(whomapper)

# read shp files using prepackaged files
sfs <- pull_sfs()

AGE_OVER60PCT_map <- left_join(
  sfs$adm0,
  AGE_OVER60PCT %>% select(COUNTRY_FK__CODE,ValueNumeric),
  by = c("iso_3_code" = "COUNTRY_FK__CODE")
) 

ggplot() +
  geom_sf_who_poly(data = AGE_OVER60PCT_map %>% mutate("Percentage"=case_when(ValueNumeric<=10 ~ "<=10", ValueNumeric>10&ValueNumeric<=15~"11-15",  ValueNumeric>15&ValueNumeric<=20~"16-20",  ValueNumeric>20&ValueNumeric<=25~"21-25",  ValueNumeric>25~">25"), "Percentage"=factor(Percentage, levels=c("<=10", "11-15", "16-20", "21-25", ">25"))), aes(fill = Percentage)) +
  scale_fill_brewer(palette = "YlGnBu")+
  labs(title ="Percentage of total population\naged 60 years or over, 2023") +
  who_map_pipeline() 

# ggsave("figures/age_over60pct_map.png", width=8, height=6, unit="in")

AGE_OVER60PCT20302050_map <- left_join(
  sfs$adm0,
  AGE_OVER60PCT20302050 %>% select(COUNTRY_FK__CODE,y2030, y2050),
  by = c("iso_3_code" = "COUNTRY_FK__CODE")
) 

ggplot() +
  geom_sf_who_poly(data = AGE_OVER60PCT20302050_map %>% mutate("Percentage"=case_when(y2030<=10 ~ "<=10", y2030>10&y2030<=15~"11-15",  y2030>15&y2030<=20~"16-20",  y2030>20&y2030<=25~"21-25",  y2030>25~">25"), "Percentage"=factor(Percentage, levels=c("<=10", "11-15", "16-20", "21-25", ">25"))), aes(fill = Percentage)) +
  scale_fill_brewer(palette = "YlGnBu")+
  labs(title ="Percentage of total population\naged 60 years or over, 2030") +
  who_map_pipeline() 

# ggsave("figures/age_over60pct_map_2030.png", width=8, height=6, unit="in")

ggplot() +
  geom_sf_who_poly(data = AGE_OVER60PCT20302050_map %>% mutate("Percentage"=case_when(y2050<=10 ~ "<=10", y2050>10&y2050<=15~"11-15",  y2050>15&y2050<=20~"16-20",  y2050>20&y2050<=25~"21-25",  y2050>25~">25"), "Percentage"=factor(Percentage, levels=c("<=10", "11-15", "16-20", "21-25", ">25"))), aes(fill = Percentage)) +
  scale_fill_brewer(palette = "YlGnBu")+
  labs(title ="Percentage of total population\naged 60 years or over, 2050") +
  who_map_pipeline() 

# ggsave("figures/age_over60pct_map-2050.png", width=8, height=6, unit="in")

## trend in 60+ pct of pop

AGE_OVER60PCT <- aging %>%
  filter(INDICATOR_FK == "AGE_OVER60PCT") %>%
  filter(YEAR_FK <= 2023) %>%
  filter(SEX_FK == "BTSX") %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  group_by(region) %>%
  mutate(highlight = max(ValueNumeric) == ValueNumeric) %>%
  group_by(COUNTRY_FK) %>%
  mutate(highlight2 = ifelse(TRUE %in% highlight, TRUE, highlight))

ggplot(data = AGE_OVER60PCT, aes(x = as.numeric(YEAR_FK), y = ValueNumeric)) +
  geom_line(aes(y = ValueNumeric, group = COUNTRY_FK, colour = highlight2), size = 1) +
  geom_line(AGE_OVER60PCT %>% filter(highlight2 == T), mapping = aes(x = as.numeric(YEAR_FK), y = ValueNumeric), colour = "#009E73", size = 1.2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  labs(x = NULL, y = "Percentage of total population aged 60 years or over", fill = NULL, colour = NULL) +
  facet_wrap(~region) +
  guides(colour = F) +
  geom_text(AGE_OVER60PCT %>% filter(highlight == T), mapping = aes(label = str_wrap(COUNTRY_FK, 10), y = ValueNumeric + 1, x = 2025)) +
  scale_x_continuous(limits = c(1950, 2035), expand = c(0, 0), breaks = c(1950, 1965, 1980, 1995, 2010, 2022)) +
  scale_color_manual(values = c("#bdbdbd", "#009E73"))

# ggsave("figures/age60plspct_trends_region.png", width=13, height=7, units="in")

# trends 2000-2050

highlt <- unique(AGE_OVER60PCT$COUNTRY_FK__CODE[AGE_OVER60PCT$highlight == T])

AGE_OVER60PCT_2050 <- aging %>%
  filter(INDICATOR_FK == "AGE_OVER60PCT") %>%
  filter(YEAR_FK <= 2050 & YEAR_FK >= 2023) %>%
  filter(SEX_FK == "BTSX") %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  group_by(region) %>%
  group_by(COUNTRY_FK)
AGE_OVER60PCT_2050$highlight2 <- F
AGE_OVER60PCT_2050$highlight2[AGE_OVER60PCT_2050$COUNTRY_FK__CODE %in% highlt] <- T

ggplot() +
  geom_line(data = AGE_OVER60PCT %>% filter(YEAR_FK >= 2000), aes(x = as.numeric(YEAR_FK), y = ValueNumeric, group = COUNTRY_FK, colour = highlight2), size = 1) +
  geom_line(AGE_OVER60PCT %>% filter(YEAR_FK >= 2000) %>% filter(highlight2 == T), mapping = aes(x = as.numeric(YEAR_FK), y = ValueNumeric), colour = "#009E73", size = 1.2) +
  geom_line(data = AGE_OVER60PCT_2050, aes(x = as.numeric(YEAR_FK), y = ValueNumeric, group = COUNTRY_FK, colour = highlight2), size = 1, linetype = "dashed") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  labs(x = NULL, y = "Percentage of total population aged 60 years or over", fill = NULL, colour = NULL) +
  facet_wrap(~region) +
  guides(colour = F) +
  geom_text(AGE_OVER60PCT_2050 %>% filter(highlight2 == T & YEAR_FK == max(YEAR_FK)), mapping = aes(label = str_wrap(NAME_SHORT_EN, 10), y = ValueNumeric, x = 2055)) +
  scale_x_continuous(limits = c(2000, 2065), expand = c(0, 0), breaks = c(2000, 2010, 2020, 2030, 2040, 2050)) +
  scale_color_manual(values = c("#bdbdbd", "#009E73"))

# ggsave("figures/age60plspct_trends2050_region.png", width=13, height=7, units="in")

# extra labels

ggplot() +
  geom_line(data = AGE_OVER60PCT %>% filter(YEAR_FK >= 2000), aes(x = as.numeric(YEAR_FK), y = ValueNumeric, group = COUNTRY_FK, colour = highlight2), size = 1) +
  geom_line(AGE_OVER60PCT %>% filter(YEAR_FK >= 2000) %>% filter(highlight2 == T), mapping = aes(x = as.numeric(YEAR_FK), y = ValueNumeric), colour = "#009E73", size = 1.2) +
  geom_line(data = AGE_OVER60PCT_2050, aes(x = as.numeric(YEAR_FK), y = ValueNumeric, group = COUNTRY_FK, colour = highlight2), size = 1, linetype = "dashed") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  labs(x = NULL, y = "Percentage of total population aged 60 years or over", fill = NULL, colour = NULL) +
  facet_wrap(~region) +
  guides(colour = F) +
  geom_text(AGE_OVER60PCT_2050 %>% filter(highlight2 == T & YEAR_FK == max(YEAR_FK)), mapping = aes(label = str_wrap(COUNTRY_FK, 10), y = ValueNumeric, x = 2055)) +
  geom_text(AGE_OVER60PCT_2050 %>% filter(GRP_WHO_REGION == "AMR" & YEAR_FK == max(YEAR_FK) & ValueNumeric > 32), mapping = aes(label = str_wrap(COUNTRY_FK, 10), y = ValueNumeric, x = 2055), size = 3.5) +
  scale_x_continuous(limits = c(2000, 2065), expand = c(0, 0), breaks = c(2000, 2010, 2019, 2030, 2040, 2050)) +
  scale_color_manual(values = c("#bdbdbd", "#009E73"))

# ggsave("figures/age60plspct_trends2050_region_labels.png", width=13, height=7, units="in")


# percent over 60  estimates by sex/region

AGE_OVER60PCT <- aging %>%
  filter(INDICATOR_FK == "AGE_OVER60PCT") %>%
  filter(YEAR_FK == 2023) %>%
  filter(SEX_FK != "BTSX") %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M")
AGE_OVER60PCT$pop_60pls[AGE_OVER60PCT$SEX_FK == "MLE"] <- AGE_OVER60PCT$ValueNumeric[AGE_OVER60PCT$SEX_FK == "MLE"] / 100 * as.numeric(AGE_OVER60PCT$male_2023[AGE_OVER60PCT$SEX_FK == "MLE"])
AGE_OVER60PCT$pop_60pls[AGE_OVER60PCT$SEX_FK == "FMLE"] <- AGE_OVER60PCT$ValueNumeric[AGE_OVER60PCT$SEX_FK == "FMLE"] / 100 * as.numeric(AGE_OVER60PCT$female_2023[AGE_OVER60PCT$SEX_FK == "FMLE"])

AGE_OVER60PCT_regional <- AGE_OVER60PCT %>%
  group_by(region, SEX_FK) %>%
  summarise(pop_60pls = sum(pop_60pls), female_2023 = sum(as.numeric(female_2023)), male_2023 = sum(as.numeric(male_2023)))
AGE_OVER60PCT_regional$pct_60pls[AGE_OVER60PCT_regional$SEX_FK == "MLE"] <- AGE_OVER60PCT_regional$pop_60pls[AGE_OVER60PCT_regional$SEX_FK == "MLE"] / as.numeric(AGE_OVER60PCT_regional$male_2023[AGE_OVER60PCT_regional$SEX_FK == "MLE"]) * 100
AGE_OVER60PCT_regional$pct_60pls[AGE_OVER60PCT_regional$SEX_FK == "FMLE"] <- AGE_OVER60PCT_regional$pop_60pls[AGE_OVER60PCT_regional$SEX_FK == "FMLE"] / as.numeric(AGE_OVER60PCT_regional$female_2023[AGE_OVER60PCT_regional$SEX_FK == "FMLE"]) * 100


ggplot(AGE_OVER60PCT_regional, aes(x = reorder(str_wrap(region, 15), pct_60pls), y = pct_60pls, fill = SEX_FK)) +
  geom_bar(
    stat = "identity", alpha = 0.5,
    width = 0.8,
    position = position_dodge2(width = 0.8)
  ) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(labels = c("Female", "Male"), values = c("#CC79A7", "#0072B2"), name = NULL) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 30)) +
  labs(x = NULL, y = "Percentage of population aged 60 years or over")

# ggsave("figures/age60plspct_sex_region.png", width=13, height=7, units="in")

# percent over 60  estimates by sex/income
AGE_OVER60PCT_income <- AGE_OVER60PCT %>%
  filter(!is.na(GRP_WB_INCOME)) %>%
  group_by(GRP_WB_INCOME, SEX_FK) %>%
  summarise(pop_60pls = sum(pop_60pls), female_2023 = sum(as.numeric(female_2023)), male_2023 = sum(as.numeric(male_2023)))
AGE_OVER60PCT_income$pct_60pls[AGE_OVER60PCT_income$SEX_FK == "MLE"] <- AGE_OVER60PCT_income$pop_60pls[AGE_OVER60PCT_income$SEX_FK == "MLE"] / as.numeric(AGE_OVER60PCT_income$male_2023[AGE_OVER60PCT_income$SEX_FK == "MLE"]) * 100
AGE_OVER60PCT_income$pct_60pls[AGE_OVER60PCT_income$SEX_FK == "FMLE"] <- AGE_OVER60PCT_income$pop_60pls[AGE_OVER60PCT_income$SEX_FK == "FMLE"] / as.numeric(AGE_OVER60PCT_income$female_2023[AGE_OVER60PCT_income$SEX_FK == "FMLE"]) * 100


ggplot(AGE_OVER60PCT_income, aes(x = reorder(str_wrap(GRP_WB_INCOME, 15), pct_60pls), y = pct_60pls, fill = SEX_FK)) +
  geom_bar(
    stat = "identity", alpha = 0.5,
    width = 0.8,
    position = position_dodge2(width = 0.8)
  ) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_x_discrete(labels = c("LIC" = "Low-Income", "LMC" = "Lower-Middle", "UMC" = "Upper-Middle", "HIC" = "High-Income")) +
  scale_fill_manual(labels = c("Female", "Male"), values = c("#CC79A7", "#0072B2"), name = NULL) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 30)) +
  labs(x = NULL, y = "Percentage of population aged 60 years or over")

# ggsave("figures/age60plspct_sex_income.png", width=13, height=7, units="in")

# percent over 80  estimates by sex/region

AGE_OVER80PCT <- aging %>%
  filter(INDICATOR_FK == "AGE_OVER80PCT") %>%
  filter(YEAR_FK == 2023) %>%
  filter(SEX_FK != "BTSX") %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M")
AGE_OVER80PCT$pop_80pls[AGE_OVER80PCT$SEX_FK == "MLE"] <- AGE_OVER80PCT$ValueNumeric[AGE_OVER80PCT$SEX_FK == "MLE"] / 100 * as.numeric(AGE_OVER80PCT$male_2023[AGE_OVER80PCT$SEX_FK == "MLE"])
AGE_OVER80PCT$pop_80pls[AGE_OVER80PCT$SEX_FK == "FMLE"] <- AGE_OVER80PCT$ValueNumeric[AGE_OVER80PCT$SEX_FK == "FMLE"] / 100 * as.numeric(AGE_OVER80PCT$female_2023[AGE_OVER80PCT$SEX_FK == "FMLE"])

AGE_OVER80PCT_regional <- AGE_OVER80PCT %>%
  group_by(region, SEX_FK) %>%
  summarise(pop_80pls = sum(pop_80pls), female_2023 = sum(as.numeric(female_2023)), male_2023 = sum(as.numeric(male_2023)))
AGE_OVER80PCT_regional$pct_80pls[AGE_OVER80PCT_regional$SEX_FK == "MLE"] <- AGE_OVER80PCT_regional$pop_80pls[AGE_OVER80PCT_regional$SEX_FK == "MLE"] / as.numeric(AGE_OVER80PCT_regional$male_2023[AGE_OVER80PCT_regional$SEX_FK == "MLE"]) * 100
AGE_OVER80PCT_regional$pct_80pls[AGE_OVER80PCT_regional$SEX_FK == "FMLE"] <- AGE_OVER80PCT_regional$pop_80pls[AGE_OVER80PCT_regional$SEX_FK == "FMLE"] / as.numeric(AGE_OVER80PCT_regional$female_2023[AGE_OVER80PCT_regional$SEX_FK == "FMLE"]) * 100


ggplot(AGE_OVER80PCT_regional, aes(x = reorder(str_wrap(region, 15), pct_80pls), y = pct_80pls, fill = SEX_FK)) +
  geom_bar(
    stat = "identity", alpha = 0.5,
    width = 0.8,
    position = position_dodge2(width = 0.8)
  ) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(labels = c("Female", "Male"), values = c("#CC79A7", "#0072B2"), name = NULL) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 30)) +
  labs(x = NULL, y = "Percentage of population aged 80 years or over")

# ggsave("figures/age80plspct_sex_region.png", width=13, height=7, units="in")

# percent over 80  estimates by sex/income
AGE_OVER80PCT_income <- AGE_OVER80PCT %>%
  filter(!is.na(GRP_WB_INCOME)) %>%
  group_by(GRP_WB_INCOME, SEX_FK) %>%
  summarise(pop_80pls = sum(pop_80pls), female_2023 = sum(as.numeric(female_2023)), male_2023 = sum(as.numeric(male_2023)))
AGE_OVER80PCT_income$pct_80pls[AGE_OVER80PCT_income$SEX_FK == "MLE"] <- AGE_OVER80PCT_income$pop_80pls[AGE_OVER80PCT_income$SEX_FK == "MLE"] / as.numeric(AGE_OVER80PCT_income$male_2023[AGE_OVER80PCT_income$SEX_FK == "MLE"]) * 100
AGE_OVER80PCT_income$pct_80pls[AGE_OVER80PCT_income$SEX_FK == "FMLE"] <- AGE_OVER80PCT_income$pop_80pls[AGE_OVER80PCT_income$SEX_FK == "FMLE"] / as.numeric(AGE_OVER80PCT_income$female_2023[AGE_OVER80PCT_income$SEX_FK == "FMLE"]) * 100


ggplot(AGE_OVER80PCT_income, aes(x = reorder(str_wrap(GRP_WB_INCOME, 15), pct_80pls), y = pct_80pls, fill = SEX_FK)) +
  geom_bar(
    stat = "identity", alpha = 0.5,
    width = 0.8,
    position = position_dodge2(width = 0.8)
  ) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_x_discrete(labels = c("LIC" = "Low-Income", "LMC" = "Lower-Middle", "UMC" = "Upper-Middle", "HIC" = "High-Income")) +
  scale_fill_manual(labels = c("Female", "Male"), values = c("#CC79A7", "#0072B2"), name = NULL) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 30)) +
  labs(x = NULL, y = "Percentage of population aged 80 years or over")

# ggsave("figures/age80plspct_sex_income.png", width=13, height=7, units="in")


## Health life expectancy at 60 - map

AGE_HALE60 <- aging %>%
  filter(INDICATOR_FK == "AGE_HALE60") %>%
  filter(YEAR_FK <= 2023) %>%
  filter(SEX_FK == "BTSX") %>%
  group_by(COUNTRY_FK__CODE) %>%
  filter(YEAR_FK == max(YEAR_FK)) %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M")

# write.csv(AGE_HALE60, "ArcGIS/AGE_HALE60.csv")

## Health life expectancy at 60 - bar

AGE_HALE60 <- AGE_HALE60 %>% arrange(region, ValueNumeric, region)
AGE_HALE60$id <- seq(1, nrow(AGE_HALE60))
AGE_HALE60 <- AGE_HALE60 %>%
  group_by(region) %>%
  mutate(facet = max(ValueNumeric), region = fct_reorder(region, facet))

# Get the name and the y position of each label
label_data <- AGE_HALE60
number_of_bar <- nrow(label_data)
angle <- 90 - 360 * (label_data$id - 0.5) / number_of_bar # I subtract 0.5 because the letter must have the angle of the center of the bars. Not extreme right(1) or extreme left (0)
label_data$hjust <- ifelse(angle < -90, 1, 0)
label_data$angle <- ifelse(angle < -90, angle + 180, angle)


ggplot(AGE_HALE60, aes(x = as.factor(id), y = ValueNumeric, fill = region)) + # Note that id is a factor. If x is numeric, there is some space between the first bar
  geom_bar(aes(x = as.factor(id), y = ValueNumeric, fill = region), stat = "identity", alpha = 0.5) +
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00")) +
  ylim(-30, 120) +
  theme_minimal() +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = unit(rep(-6, 4), "cm")
  ) +
  coord_polar() +
  geom_text(data = label_data, aes(x = id, y = ValueNumeric + 2, label = NAME_SHORT_EN, hjust = hjust), color = "black", fontface = "bold", alpha = 0.6, size = 2.5, angle = label_data$angle, inherit.aes = FALSE)


ggplot(AGE_HALE60, aes(x = reorder(NAME_SHORT_EN, id), y = ValueNumeric, fill = region)) +
  geom_bar(aes(y = ValueNumeric, fill = region),
    stat = "identity", alpha = 0.5,
    width = 0.8,
    position = position_dodge2(width = 0.8)
  ) +
  coord_flip() +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00")) +
  facet_grid(region ~ ., scales = "free_y", space = "free") +
  labs(y = NULL, x = "Years of healthy life expectancy at age 60") +
  guides(fill = F)

ggplot(AGE_HALE60, aes(x = reorder(NAME_SHORT_EN, id), y = ValueNumeric, fill = region)) +
  geom_bar(aes(y = ValueNumeric, fill = region), stat = "identity", alpha = 0.5) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 7)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00")) +
  facet_grid(. ~ str_wrap(region, 15), scales = "free", space = "free") +
  labs(x = NULL, y = "Years of healthy life expectancy at age 60") +
  guides(fill = F)

# ggsave("figures/aging_hale_country.png", width=16, height=7, units="in")

ggplot(AGE_HALE60, aes(x = reorder(NAME_SHORT_EN, ValueNumeric), y = ValueNumeric, fill = region)) +
  geom_bar(aes(y = ValueNumeric, fill = region), stat = "identity") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 7), legend.position = "top") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00")) +
  # facet_grid(. ~ str_wrap(region,15), scales = "free", space="free")+
  labs(x = NULL, y = "Years of healthy life expectancy at age 60", fill = "Region")

ggsave("figures/aging_hale_countryv2.png", width=16, height=7, units="in")

# health life expectancy and life expectancy at 60 - dots by sex/region

AGE_HA_LE60 <- aging %>%
  filter(INDICATOR_FK == "AGE_HALE60" | INDICATOR_FK == "AGE_LE60") %>%
  filter(YEAR_FK == 2021) %>%
  filter(SEX_FK != "BTSX") %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  mutate(
    sex = case_when(SEX_FK == "MLE" ~ "Male", SEX_FK == "FMLE" ~ "Female"),
    sex.reg = paste0(region, ", ", sex),
    indicator = case_when(INDICATOR_FK == "AGE_HALE60" ~ "Healthy life expectancy at 60", INDICATOR_FK == "AGE_LE60" ~ "Life expectancy at 60"),
    ind.sex = paste0(indicator, "\n", sex),
    income = case_when(GRP_WB_INCOME == "LIC" ~ "Low-Income", GRP_WB_INCOME == "LMC" ~ "Lower-Middle", GRP_WB_INCOME == "UMC" ~ "Upper-Middle", GRP_WB_INCOME == "HIC" ~ "High-Income"),
    income = factor(income, levels = c("Low-Income", "Lower-Middle", "Upper-Middle", "High-Income"))
  )

ggplot(AGE_HA_LE60, aes(y = ValueNumeric, x = ind.sex, colour = indicator)) +
  geom_point(size = 3, alpha = .4) +
  theme_classic() +
  theme(legend.position = "top", axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.1), text = element_text(size = 18)) +
  scale_colour_manual(values = c("#0072B2", "#E69F00"), name = NULL) +
  scale_x_discrete(breaks = AGE_HA_LE60$ind.sex, labels = AGE_HA_LE60$sex) +
  facet_nested(. ~ str_wrap(region, 20)) +
  labs(y = "Years", x = NULL) +
  guides(colour = guide_legend(override.aes = list(alpha = 1)))

# add median lines?

# ggsave("figures/aging_ha_le_region_sex.png", width=16, height=7, units="in")

# health life expectancy and life expectancy at 60 - dots by sex/incomegrp

ggplot(AGE_HA_LE60 %>% filter(!is.na(GRP_WB_INCOME)), aes(y = ValueNumeric, x = ind.sex, colour = indicator)) +
  geom_point(size = 3, alpha = .4) +
  theme_classic() +
  theme(legend.position = "top", axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.1), text = element_text(size = 18)) +
  scale_colour_manual(values = c("#0072B2", "#E69F00"), name = NULL) +
  scale_x_discrete(breaks = AGE_HA_LE60$ind.sex, labels = AGE_HA_LE60$sex) +
  facet_nested(. ~ income) +
  labs(y = "Years", x = NULL) +
  guides(colour = guide_legend(override.aes = list(alpha = 1)))

# add median lines?

# ggsave("figures/aging_ha_le_income_sex.png", width=16, height=7, units="in")

## risk and social ##


# BMI

age_obesity_85pls_fmle <- aging %>%
  filter(INDICATOR_FK == "AGE_OBESITY") %>%
  filter(AGEGROUP_FK == "AGE85Y-PLUS") %>%
  filter(SEX_FK == "FMLE") %>%
  filter(YEAR_FK == "2016") %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  rename("female_bmi" = ValueNumeric)

age_obesity_85pls_mle <- aging %>%
  filter(INDICATOR_FK == "AGE_OBESITY") %>%
  filter(AGEGROUP_FK == "AGE85Y-PLUS") %>%
  filter(SEX_FK == "MLE") %>%
  filter(YEAR_FK == "2016") %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  rename("male_bmi" = ValueNumeric)

age_obesity <- full_join(age_obesity_85pls_fmle[, c("COUNTRY_FK__CODE", "female_bmi")], age_obesity_85pls_mle[, c("COUNTRY_FK__CODE", "male_bmi")], by = c("COUNTRY_FK__CODE"))

# write.csv(age_obesity, "ArcGIS/age_obesity_2016.csv")


# insufficient activity

age_insufact <- aging %>% filter(INDICATOR_FK == "AGE_INSUFACT")

ggplot(age_insufact %>% filter(!is.na(region)), aes(y = ValueNumeric, x = SEX_FK, colour = SEX_FK)) +
  geom_point(size = 3, alpha = .4) +
  theme_classic() +
  theme(legend.position = NULL, axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.1), text = element_text(size = 18)) +
  scale_colour_manual(labels = c("Female", "Male"), values = c("#CC79A7", "#0072B2")) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(breaks = c("FMLE", "MLE"), labels = c("Female", "Male")) +
  facet_nested(. ~ str_wrap(region, 20)) +
  labs(y = "Percent", x = NULL) +
  guides(colour = F)

# ggsave("figures/age_insufact70pls_sex_region.png", width=13, height=7, units="in")


# household living arrangements

age_reside <- aging %>%
  filter(INDICATOR_FK == "AGE_RESIDE") %>%
  mutate(year = as.numeric(YEAR_FK)) %>%
  filter(year >= 2010) %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  filter(SEX_FK=="BTSX") %>% 
 # mutate(n = (ValueNumeric / 100) * as.numeric(btsx_2019)) %>%
  mutate(living_arragements = factor(LivingArrangements_FK, levels = c("WITH_SPOUSE", "WITH_CHILD", "OTHER", "ALONE"), labels = c("With spouse", "With child", "Other", "Alone")))

alone <- age_reside %>%  group_by(COUNTRY_FK) %>% filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>% filter(as.numeric(YEAR_FK) >= 2010) %>% filter(living_arragements == "Alone") %>% group_by(COUNTRY_FK) %>% summarise(alone=mean(ValueNumeric))

# est 2010-2016 pop 2019 -

ggplot(age_reside %>% group_by(COUNTRY_FK) %>% filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>% filter(as.numeric(YEAR_FK) >= 2010) %>% group_by(COUNTRY_FK) %>% mutate(alone = NA, alone = ValueNumeric[living_arragements == "Alone"]) %>% group_by(region) %>% mutate(meanalone = mean(ValueNumeric[living_arragements == "Alone"])), aes(x = reorder(NAME_SHORT_EN, alone), y = ValueNumeric, fill = living_arragements)) +
  geom_bar(aes(y = ValueNumeric, fill = living_arragements), stat = "identity") +
  theme_classic() +
  theme(text = element_text(size = 16), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 10), legend.position = "top") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#0072B2", "#56B4E9", "#F0E442", "#D55E00"), name = "Living arrangements") +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 10), meanalone), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent")

# ggsave("figures/age_reside_2010-19_country.png", width=14, height=7, units="in")

ggplot(age_reside %>% group_by(COUNTRY_FK) %>% filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>% filter(as.numeric(YEAR_FK) >= 2010) %>% group_by(COUNTRY_FK) %>% mutate(alone = ValueNumeric[living_arragements == "Alone"]) %>% group_by(region) %>% mutate(meanalone = mean(ValueNumeric[living_arragements == "Alone"])) %>% filter(GRP_WHO_REGION == "SEAR" | GRP_WHO_REGION == "EMR" | GRP_WHO_REGION == "AFR" | GRP_WHO_REGION == "WPR"), aes(x = reorder(str_wrap(NAME_SHORT_EN, 30), alone), y = ValueNumeric, fill = living_arragements)) +
  geom_bar(aes(y = ValueNumeric, fill = living_arragements), stat = "identity") +
  theme_classic() +
  theme(text = element_text(size = 16), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 12, lineheight = .6), legend.position = "top") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#0072B2", "#56B4E9", "#F0E442", "#D55E00"), name = "Living arrangements") +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 10), meanalone), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent")

# ggsave("figures/age_reside_2010-19_country_sear-emr-afr-wpr.png", width=14, height=7, units="in")


ggplot(age_reside %>% group_by(COUNTRY_FK) %>% filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>% filter(as.numeric(YEAR_FK) >= 2010) %>% group_by(COUNTRY_FK) %>% mutate(alone = ValueNumeric[living_arragements == "Alone"]) %>% group_by(region) %>% mutate(meanalone = mean(ValueNumeric[living_arragements == "Alone"])) %>% filter(GRP_WHO_REGION == "AMR" | GRP_WHO_REGION == "EUR"), aes(x = reorder(str_wrap(NAME_SHORT_EN, 30), alone), y = ValueNumeric, fill = living_arragements)) +
  geom_bar(aes(y = ValueNumeric, fill = living_arragements), stat = "identity") +
  theme_classic() +
  theme(text = element_text(size = 16), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 12, lineheight = .6), legend.position = "top") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("#0072B2", "#56B4E9", "#F0E442", "#D55E00"), name = "Living arrangements") +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 10), meanalone), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent")

#ggsave("figures/age_reside_2010-19_country_amr-eur.png", width = 14, height = 7, units = "in")


# labour

age_labour <- aging %>%
  filter(INDICATOR_FK == "AGE_LABOUR") %>%
  group_by(COUNTRY_FK__CODE) %>%
  mutate(year = as.numeric(YEAR_FK)) %>%
  filter(year == max(year)) %>%
  filter(year >= 2015) %>%
  filter(SEX_FK != "BTSX") %>%
  filter(WHO_LEGAL_STATUS == "M")

ggplot(age_labour %>% filter(!is.na(region)), aes(y = ValueNumeric, x = SEX_FK, colour = SEX_FK)) +
  geom_point(size = 3, alpha = .4) +
  theme_classic() +
  theme(legend.position = NULL, axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.1), text = element_text(size = 18)) +
  scale_colour_manual(labels = c("Female", "Male"), values = c("#CC79A7", "#0072B2")) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  scale_x_discrete(breaks = c("FMLE", "MLE"), labels = c("Female", "Male")) +
  facet_nested(. ~ str_wrap(region, 20)) +
  labs(y = "Percent", x = NULL) +
  guides(colour = F)

# ggsave("figures/age_labour65pls_2015-23_sex_region.png", width=13, height=7, units="in")


## care arrangement and common conditions ##

# age_residelta

age_residelta <- aging %>%
  filter(INDICATOR_FK == "AGE_RESIDELTA") %>%
  filter(AGEGROUP_FK == "AGE80Y-PLUS") %>%
  filter(SEX_FK == "BTSX") %>%
  filter(ResideLTA_FK == "INSTITUTION") %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M")

ggplot(age_residelta %>% group_by(COUNTRY_FK) %>% filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>% filter(as.numeric(YEAR_FK) >= 2010), aes(x = reorder(NAME_SHORT_EN, ValueNumeric), y = ValueNumeric, fill = region)) +
  geom_bar(aes(y = ValueNumeric, fill = region), stat = "identity") +
  theme_classic() +
  theme(text = element_text(size = 18), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5), legend.position = "bottom") +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100)) +
  scale_fill_manual(values = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00"), name = "Region") +
  #  facet_grid(. ~ str_wrap(region,15), scales = "free", space="free")+
  labs(x = NULL, y = "Percent over  receiving long-term\ncare at residential facilities")

# ggsave("figures/age_longtermcarefac_2010-22.png", width=13, height=7, units="in")

age_residelta_h <- aging %>%
  filter(INDICATOR_FK == "AGE_RESIDELTA") %>%
  filter(AGEGROUP_FK == "AGE80Y-PLUS") %>%
  filter(SEX_FK == "BTSX") %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  group_by(COUNTRY_FK) %>%
  filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>%
  filter(as.numeric(YEAR_FK) >= 2010) %>%
  group_by(COUNTRY_FK) %>%
  mutate(sum = sum(ValueNumeric))

ggplot(age_residelta_h, aes(x = reorder(NAME_SHORT_EN, sum), y = ValueNumeric, fill = ResideLTA_FK)) +
  geom_bar(aes(y = ValueNumeric, fill = ResideLTA_FK), stat = "identity") +
  theme_classic() +
  theme(text = element_text(size = 18), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100)) +
  scale_fill_manual(values = c("#0072B2", "#56B4E9"), name = NULL, labels = c("Home", "Institution")) +
  #  facet_grid(. ~ str_wrap(region,15), scales = "free", space="free")+
  labs(x = NULL, y = "Percent over 80 receiving long-term care")

# ggsave("figures/age_longtermcarefac_home_2010-22.png", width=13, height=7, units="in")

age_residelta_h <- aging %>%
  filter(INDICATOR_FK == "AGE_RESIDELTA") %>%
  filter(SEX_FK == "BTSX") %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  group_by(COUNTRY_FK) %>%
  filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>%
  filter(as.numeric(YEAR_FK) >= 2010) %>%
  group_by(COUNTRY_FK) %>%
  mutate(sum = sum(ValueNumeric))

ggplot(age_residelta_h, aes(x = reorder(NAME_SHORT_EN, sum), y = ValueNumeric, fill = ResideLTA_FK)) +
  geom_bar(aes(y = ValueNumeric, fill = ResideLTA_FK), stat = "identity") +
  theme_classic() +
  theme(text = element_text(size = 18), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100)) +
  scale_fill_manual(values = c("#0072B2", "#56B4E9"), name = NULL, labels = c("Home", "Institution")) +
  #  facet_grid(. ~ str_wrap(region,15), scales = "free", space="free")+
  labs(x = NULL, y = "Percent receiving long-term care") +
  facet_grid(~AGEGROUP_FK, scales = "free", labeller = as_labeller(c("AGE65Y-PLUS" = "65 years plus", "AGE80Y-PLUS" = "80 years plus")))

# ggsave("figures/age_longtermcarefac_home_2010-21-ages65and80.png", width=13, height=7, units="in")

# falls

age_fall <- aging %>%
  filter(INDICATOR_FK == "AGE_FALL") %>%
  filter(SEX_FK == "BTSX") %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  group_by(COUNTRY_FK) %>%
  filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>%
  group_by(region) %>%
  mutate(meanf = mean(ValueNumeric))

ggplot(age_fall %>% filter(!is.na(region)), aes(y = ValueNumeric, x = AGEGROUP_FK)) +
  geom_point(size = 3, alpha = .4, position = "jitter", colour = "#081d58") +
  theme_classic() +
  theme(legend.position = NULL, axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.1), text = element_text(size = 18)) +
  #  scale_colour_manual(values=c('#c7e9b4','#7fcdbb','#41b6c4','#1d91c0','#225ea8','#253494','#081d58', '#000000'))+
  scale_x_discrete(labels = c("60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95+")) +
  facet_nested(. ~ reorder(str_wrap(region, 20), meanf)) +
  labs(y = "Incidence per 100,000 population", x = "Age") +
  guides(colour = F)

# ggsave("figures/age_fall_2019_region.png", width=13, height=7, units="in")

# back pain

age_backpain <- aging %>%
  filter(INDICATOR_FK == "AGE_BACKPAIN") %>%
  filter(SEX_FK == "BTSX") %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  group_by(COUNTRY_FK) %>%
  filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>%
  group_by(region) %>%
  mutate(meanf = mean(ValueNumeric))

ggplot(age_backpain %>% filter(!is.na(region)), aes(y = ValueNumeric, x = AGEGROUP_FK)) +
  geom_point(size = 3, alpha = .4, position = "jitter", colour = "#081d58") +
  theme_classic() +
  theme(legend.position = NULL, axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.1), text = element_text(size = 18)) +
  #  scale_colour_manual(values=c('#c7e9b4','#7fcdbb','#41b6c4','#1d91c0','#225ea8','#253494','#081d58', '#000000'))+
  scale_x_discrete(labels = c("60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95+")) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  facet_nested(. ~ reorder(str_wrap(region, 20), meanf)) +
  labs(y = "Percent", x = "Age") +
  guides(colour = F)

# ggsave("figures/age_backpain_2019_region.png", width=13, height=7, units="in")

ggplot(age_backpain %>% filter(!is.na(region)), aes(y = ValueNumeric, x = AGEGROUP_FK)) +
  geom_point(size = 3, alpha = .4, colour = "#081d58") +
  geom_errorbar(aes(ymin = ValueLow, ymax = ValueHigh), alpha = .4, colour = "#081d58") +
  theme_classic() +
  theme(legend.position = NULL, axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.1), text = element_text(size = 18)) +
  #  scale_colour_manual(values=c('#c7e9b4','#7fcdbb','#41b6c4','#1d91c0','#225ea8','#253494','#081d58', '#000000'))+
  scale_x_discrete(labels = c("60-64", "65-69", "70-74", "75-79", "80-84", "85-89", "90-94", "95+")) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  facet_nested(. ~ reorder(str_wrap(region, 20), meanf)) +
  labs(y = "Percent", x = "Age") +
  guides(colour = F)

# ageism

ageism <- aging %>%
  filter(INDICATOR_FK == "AGE_AGEIST") %>%
  filter(SEX_FK == "BTSX") %>%
  filter(AGEGROUP_FK == "AGEALL") %>%
  dplyr::select(where(~ !all(is.na(.x)))) %>%
  filter(WHO_LEGAL_STATUS == "M") %>%
  group_by(COUNTRY_FK) %>%
  filter(as.numeric(YEAR_FK) == max(as.numeric(YEAR_FK))) %>%
  filter(as.numeric(YEAR_FK) >= 2010) %>%
  group_by(COUNTRY_FK) %>%
  mutate(low = max(ValueNumeric[SEVERITY_FK == "LOW"]), severity = factor(SEVERITY_FK, levels = c("HIGH", "MODERATE", "LOW"))) %>%
  group_by(region) %>%
  mutate(low_m = mean(low))

ggplot(ageism, aes(x = reorder(NAME_SHORT_EN, low), y = ValueNumeric, fill = severity)) +
  geom_bar(aes(y = ValueNumeric, fill = severity), stat = "identity") +
  theme_classic() +
  theme(text = element_text(size = 17), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5), strip.text = element_text(size = 10)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100.1)) +
  scale_fill_manual(breaks = c("HIGH", "MODERATE", "LOW"), values = c("#D55E00", "#E69F00", "#009E73"), name = NULL, labels = c("High", "Moderate", "Low")) +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 15), low_m), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent of ageist attitudes in\npopulation 20 years and older")

# ggsave("figures/age_ageism_2014_region.png", width=13, height=7, units="in")

# abuse

age_abuse <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA_AGGREGATED?$filter=INDICATOR_FK%20in%20(%22AGE_ABUSE%22)%20and%20SEX_FK%20in%20(%22BTSX%22)&$select=INDICATOR_FK,GLOBAL_FK,REGION_FK,SDGRegion_FK,WORLDBANKINCOMEGROUP_FK,YEAR_FK,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")

age_abuse <- as.data.frame(age_abuse$value)

# saveRDS(age_abuse, "data/age_abuse.rds")

ggplot(age_abuse %>% filter(REGION_FK != "GLOBAL"), aes(x = reorder(REGION_FK, ValueNumeric), y = ValueNumeric)) +
  geom_bar(aes(y = ValueNumeric), stat = "identity", fill = "#081d58") +
  theme_classic() +
  theme(text = element_text(size = 18)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100.1)) +
  scale_x_discrete(labels = c("EUR" = "European Region", "AMR" = "Region of\nthe Americas", "SEAR" = "South-East\nAsian Region", "EMR" = "Eastern\nMediterranean Region", "WPR" = "Western\nPacific Region")) +
  scale_fill_manual(breaks = c("HIGH", "MODERATE", "LOW"), values = c("#D55E00", "#E69F00", "#009E73"), name = NULL, labels = c("High", "Moderate", "Low")) +
  labs(x = NULL, y = "Proportion of older people who\nexperienced any type of abuse")

# ggsave("figures/age_abuse_2015_region.png", width=13, height=7, units="in")

```

```{r age-living-arrangments}
# data from undesa: https://www.un.org/development/desa/pd/sites/www.un.org.development.desa.pd/files/undesa_pd_2022_living-arrangements-older-persons.xlsx (resaved as csv because dates)

LAageing <- read_csv("data/external/undesa_pd_2022_living-arrangements-older-persons.csv",skip = 4) %>%
  dplyr::select("Country or area", "ISO Code", "Data source category", "Reference date (dd/mm/yyyy)", "Age range", "Sex", "One person", "Couple only", "Couple with children", "Single parent with children", "Extended family", "Non-relatives", "Unknown") %>%
  mutate_at(c("One person", "Couple only", "Couple with children", "Single parent with children", "Extended family", "Non-relatives", "Unknown"), as.numeric) %>%
  rowwise() %>%
  mutate(tot = sum(c_across(c(`One person`, `Couple only`, `Couple with children`, `Single parent with children`, `Extended family`, `Non-relatives`, `Unknown`)), na.rm = T)) %>%
  ungroup() %>%
  filter(tot != 0) %>%
  filter(`Age range` != "65 or over") %>%
  filter(Sex == "Both sexes") %>%
  mutate(`Reference date (dd/mm/yyyy)`= dmy(`Reference date (dd/mm/yyyy)`)) %>% 
  filter(`Reference date (dd/mm/yyyy)` >= as.Date("2010-01-01")) %>%
  group_by(`ISO Code`, `Age range`) %>%
  filter(`Reference date (dd/mm/yyyy)` == max(`Reference date (dd/mm/yyyy)`)) %>%
  mutate(source=case_when(`Data source category`=="DHS" ~ 1, `Data source category`=="IPUMS" ~ 2, `Data source category`=="DYB" ~ 3, `Data source category`=="LFS" ~ 4)) %>% 
  group_by(`ISO Code`, `Age range`) %>%
  #filter(tot == max(tot))
  filter(source == min(source))
  
LAageing$Unknown[is.na(LAageing$Unknown) | LAageing$Unknown == 0] <- 100 - LAageing$tot[is.na(LAageing$Unknown) | LAageing$Unknown == 0]

# country code package not recognizing Türkiye
LAageing$`Country or area`[LAageing$`Country or area`=="Türkiye"] <- "Turkey"

LAageing_long <- LAageing %>%
  pivot_longer(cols = c("One person", "Couple only", "Couple with children", "Single parent with children", "Extended family", "Non-relatives", "Unknown"), names_to = "arrangements") %>%
  mutate(arrangements = factor(arrangements, levels = c("Unknown", "Non-relatives", "Extended family", "Single parent with children", "Couple with children", "Couple only", "One person"))) %>%
  mutate(CODE_ISO_3 = countrycode(`Country or area`, origin = "country.name", destination = "iso3c")) %>%
  left_join(ref_country[, c("CODE_ISO_3", "WHO_LEGAL_STATUS", "NAME_SHORT_EN", "region", "GRP_WHO_REGION")], by = "CODE_ISO_3") %>%
  filter(WHO_LEGAL_STATUS == "M")

alone <- LAageing_long %>% 
  filter(arrangements == "One person") %>% 
  mutate(alone=value)

meanalone <-alone %>% 
  group_by(`Age range`, region) %>% 
  summarise(meanalone=mean(alone))
  
LAageing_long <- LAageing_long %>% left_join(alone %>% select(`Country or area`, alone), by=c("Country or area", "Age range")) %>% left_join(meanalone, by=c("Age range", "region"))


ggplot(
  LAageing_long %>%
    filter(`Age range` == "60 or over")
  , aes(x = reorder(NAME_SHORT_EN, alone), y = value, fill = arragements, colour = arrangements)) +
  geom_bar(aes(y = value, fill = arrangements), stat = "identity", size = .1) +
  theme_classic() +
  theme(text = element_text(size = 16), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 10)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("white", "#0072B2", "#56B4E9", "#009E73", "#CC79A7", "#E69F00", "#D55E00"), name = "Living arrangements") +
  scale_colour_manual(values = c("#bdbdbd", NA, NA, NA, NA, NA, NA), name = "Living arrangements") +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 10), meanalone), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent")

# ggsave("figures/age_reside60_2010-21_country_undesa_full.png", width=14, height=7, units="in")


ggplot(LAageing_long %>% filter(`Age range` == "60 or over") %>% filter(GRP_WHO_REGION == "SEAR" | GRP_WHO_REGION == "EMR" | GRP_WHO_REGION == "AFR" | GRP_WHO_REGION == "WPR"), aes(x = reorder(str_wrap(NAME_SHORT_EN, 30), alone), y = value, fill = arragements, colour = arrangements)) +
  geom_bar(aes(y = value, fill = arrangements), stat = "identity", size = .1) +
  theme_classic() +
  theme(text = element_text(size = 16), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 10, lineheight = .6)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("white", "#0072B2", "#56B4E9", "#009E73", "#CC79A7", "#E69F00", "#D55E00"), name = "Living arrangements") +
  scale_colour_manual(values = c("#bdbdbd", NA, NA, NA, NA, NA, NA), name = "Living arrangements") +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 10), meanalone), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent")

# ggsave("figures/age_reside60_2010-21_country_undesa_sear_emr_afr_wpr.png", width=14, height=7, units="in")

ggplot(LAageing_long %>% filter(`Age range` == "60 or over") %>% filter(GRP_WHO_REGION == "AMR" | GRP_WHO_REGION == "EUR"), aes(x = reorder(str_wrap(NAME_SHORT_EN, 40), alone), y = value, fill = arragements, colour = arrangements)) +
  geom_bar(aes(y = value, fill = arrangements), stat = "identity", size = .1) +
  theme_classic() +
  theme(text = element_text(size = 16), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 10, lineheight = .6)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("white", "#0072B2", "#56B4E9", "#009E73", "#CC79A7", "#E69F00", "#D55E00"), name = "Living arrangements") +
  scale_colour_manual(values = c("#bdbdbd", NA, NA, NA, NA, NA, NA), name = "Living arrangements") +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 10), meanalone), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent")

#ggsave("figures/age_reside60_2010-21_country_undesa_amr_eur.png", width = 14, height = 7, units = "in")



### 80 plus


##

ggplot(LAageing_long %>% filter(`Age range` == "80 or over") , aes(x = reorder(NAME_SHORT_EN, alone), y = value, fill = arragements, colour = arrangements)) +
  geom_bar(aes(y = value, fill = arrangements), stat = "identity", size = .1) +
  theme_classic() +
  theme(text = element_text(size = 16), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 10)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("white", "#0072B2", "#56B4E9", "#009E73", "#CC79A7", "#E69F00", "#D55E00"), name = "Living arrangements") +
  scale_colour_manual(values = c("#bdbdbd", NA, NA, NA, NA, NA, NA), name = "Living arrangements") +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 10), meanalone), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent")

# ggsave("figures/age_reside80_2010-21_country_undesa_full.png", width=14, height=7, units="in")


ggplot(LAageing_long %>% filter(`Age range` == "80 or over")  %>% filter(GRP_WHO_REGION == "SEAR" | GRP_WHO_REGION == "EMR" | GRP_WHO_REGION == "AFR" | GRP_WHO_REGION == "WPR"), aes(x = reorder(NAME_SHORT_EN, alone), y = value, fill = arragements, colour = arrangements)) +
  geom_bar(aes(y = value, fill = arrangements), stat = "identity", size = .1) +
  theme_classic() +
  theme(text = element_text(size = 16), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 10)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("white", "#0072B2", "#56B4E9", "#009E73", "#CC79A7", "#E69F00", "#D55E00"), name = "Living arrangements") +
  scale_colour_manual(values = c("#bdbdbd", NA, NA, NA, NA, NA, NA), name = "Living arrangements") +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 10), meanalone), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent")

# ggsave("figures/age_reside80_2010-21_country_undesa_sear_emr_afr_wpr.png", width=14, height=7, units="in")

ggplot(LAageing_long %>% filter(`Age range` == "80 or over") %>% filter(GRP_WHO_REGION == "AMR" | GRP_WHO_REGION == "EUR"), aes(x = reorder(str_wrap(NAME_SHORT_EN, 40), alone), y = value, fill = arragements, colour = arrangements)) +
  geom_bar(aes(y = value, fill = arrangements), stat = "identity", size = .1) +
  theme_classic() +
  theme(text = element_text(size = 16), axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5, size = 10, lineheight = .6)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = c("white", "#0072B2", "#56B4E9", "#009E73", "#CC79A7", "#E69F00", "#D55E00"), name = "Living arrangements") +
  scale_colour_manual(values = c("#bdbdbd", NA, NA, NA, NA, NA, NA), name = "Living arrangements") +
  facet_grid(. ~ reorder(str_wrap(GRP_WHO_REGION, 10), meanalone), scales = "free", space = "free") +
  labs(x = NULL, y = "Percent")

# ggsave("figures/age_reside80_2010-21_country_undesa_amr_eur.png", width=14, height=7, units="in")

```

```{r aging_cod}
## cause of death ####

#original version truncates from 288420 obs (that I could see in firefox, etc.) to 120000 obs for reasons I could not understand
# xmart_mort <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA_AGGREGATED?$filter=INDICATOR_FK%20in%20(%22AGE_MORT_TOP20%22)%20and%20SEX_FK%20in%20(%22BTSX%22)&$select=INDICATOR_FK,GLOBAL_FK,REGION_FK,SDGRegion_FK,WORLDBANKINCOMEGROUP_FK,YEAR_FK,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")


#new version with AGE60Y-PLUS added to filter to return only 25498 obs
# xmart_mort <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA_AGGREGATED?%24filter=AGEGROUP_FK%20in%20(%22AGE60Y-PLUS%22)%20and%20INDICATOR_FK%20in%20(%22AGE_MORT_TOP20%22)%20and%20SEX_FK%20in%20(%22BTSX%22)&%24select=INDICATOR_FK,GLOBAL_FK,REGION_FK,SDGRegion_FK,WORLDBANKINCOMEGROUP_FK,YEAR_FK,ValueString,ValueNumeric,ValueLow,ValueHigh,ValueStdDev,ValueStdErr,Comments,EffectiveDate,EndDate,Status,AGEGROUP_FK,AGEGROUP_FK__CODE,Answer_FK,CauseGHE_FK,CauseGHE_FK__CODE,CauseGHEChild_FK,CauseGHEChild_FK__CODE,CauseENVCAUSE_FK,CauseENVCAUSE_FK__CODE,DatasourceLong,DatasourceShort,ImpSan_FK,ImpWater_FK,LivingArrangements_FK,MEASDEF_FK,MOTHEREDUCATION_FK,ProficiencyLevel_FK,ResideLTA_FK,RESIDENCEAREA_FK,SABDefinition_FK,SEVERITY_FK,SEVERITYHEARING_FK,SEVERITYVISION_FK,SEX_FK,WEALTHQUINTILE_FK")
# 
# age_mort <- as.data.frame(xmart_mort$value)
# 
# saveRDS(age_mort, "data/age_mort.rds")
age_mort <- readRDS("data/age_mort.rds")

# xmart_cod_ref <- fromJSON("https://xmart-api-public.who.int/MNCAH/REF_CauseGHE")
# 
# cod_ref <- as.data.frame(xmart_cod_ref$value)
# saveRDS(cod_ref, "data/cod_ref.rds")
cod_ref <- readRDS("data/cod_ref.rds")

cod_ref$cause_group[str_detect(cod_ref$DESCRIPTION, "I.")] <- "Communicable, maternal, perinatal and nutritional conditions"
cod_ref$cause_group[str_detect(cod_ref$DESCRIPTION, "II.")] <- "Noncommunicable diseases"
cod_ref$cause_group[str_detect(cod_ref$DESCRIPTION, "III.")] <- "Injuries"


# age_mort <- left_join(age_mort, cod_ref[, c("cause_group", "TITLE")], by = c("CauseGHE_FK" = "TITLE"))
age_mort <- left_join(age_mort, cod_ref[, c("cause_group", "CODE", "TITLE")], by = c("CauseGHE_FK" = "CODE"))

devtools::install_github("davidsjoberg/ggbump")
library(ggbump)

age_mort_tops <- age_mort %>%
  filter(AGEGROUP_FK == "AGE60Y-PLUS") %>%
  filter(REGION_FK == "GLOBAL") %>%
  filter(!is.na(TITLE)) %>%
  filter(SEX_FK == "BTSX") %>%
  filter(MEASDEF_FK == "RANK") %>%
  mutate(year = as.numeric(YEAR_FK)) %>%
  ungroup() %>%
  group_by(TITLE) %>%
  mutate(any_top10 = any(ValueNumeric <= 10)) %>%
  ungroup() %>%
  mutate(ValueNumeric = if_else(ValueNumeric > 10, 11, ValueNumeric)) %>%
  filter(any_top10 == T) %>%
  group_by(TITLE) %>%
  mutate(
    first_top = min(year[ValueNumeric <= 10]),
    last_top = max(year[ValueNumeric <= 10]),
    d_first_top = if_else(year == first_top, 1, 0)
  ) %>%
  ungroup() %>%
  arrange(TITLE, year) %>%
  group_by(TITLE) %>%
  mutate(lag_zero = if_else(lag(ValueNumeric) %in% c(11, NA) & ValueNumeric <= 10, 1, 0, 0)) %>%
  ungroup() %>%
  mutate(group = cumsum(lag_zero)) %>%
  dplyr::select(TITLE, year, ValueNumeric, first_top, last_top, d_first_top, group, cause_group)

ggplot(age_mort_tops, aes(x = year, y = ValueNumeric, color = TITLE, group = TITLE)) +
  geom_bump(smooth = 15, size = 2, alpha = 0.2) +
  scale_y_reverse() +
  geom_bump(
    data = age_mort_tops %>% filter(ValueNumeric <= 10),
    aes(year, ValueNumeric, group = group, color = TITLE),
    smooth = 15, size = 2, inherit.aes = F
  ) +
  geom_point(
    data = age_mort_tops %>% filter(d_first_top == 1),
    aes(x = year - .2),
    size = 5
  ) +
  geom_segment(
    data = age_mort_tops %>% filter(ValueNumeric <= 10),
    aes(x = year - .2, xend = year + .2, y = ValueNumeric, yend = ValueNumeric),
    size = 2,
    lineend = "round"
  ) +
  scale_x_continuous(limits = c(1999, 2022), breaks = c(2000, 2005, 2010, 2015, 2019)) +
  geom_text(
    data = age_mort_tops %>% filter(d_first_top == 1) %>% filter(year == 2000),
    aes(label = TITLE, x = year - .2),
    color = "black",
    nudge_y = .4,
    nudge_x = -.05,
    size = 3.5,
    fontface = 2,
    hjust = 0
  ) +
  geom_text(
    data = age_mort_tops %>% filter(d_first_top == 1) %>% filter(year != 2000),
    aes(label = TITLE, x = year - .2),
    color = "black",
    nudge_y = -.3,
    nudge_x = -.05,
    size = 3.5,
    fontface = 2,
    hjust = 0
  ) +
  geom_text(
    data = age_mort_tops %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(label = TITLE),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 3.5,
    fontface = 2
  ) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    plot.title = element_text(hjust = .5, color = "black"),
    plot.caption = element_text(hjust = 1, color = "black", size = 8),
    plot.subtitle = element_text(hjust = .5, color = "black", size = 10),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_text(face = 2, color = "black"),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  ) +
  geom_point(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  )

# ggsave("figures/aging_cod60_global_ranks.png", width=16, height=7, units="in")

# only 2000 and 2021
ggplot(age_mort_tops, aes(x = year, y = ValueNumeric, color = TITLE, group = TITLE)) +
  geom_bump(smooth = 15, size = 2, alpha = 0.2) +
  scale_y_reverse(expand = c(0, 0.11)) +
  geom_bump(
    data = age_mort_tops %>% filter(ValueNumeric <= 10),
    aes(year, ValueNumeric, group = group, color = TITLE),
    smooth = 15, size = 2, inherit.aes = F
  ) +
  geom_point(
    data = age_mort_tops %>% filter(d_first_top == 1),
    aes(x = year - .2),
    size = 5
  ) +
  geom_segment(
    data = age_mort_tops %>% filter(ValueNumeric <= 10),
    aes(x = year - .2, xend = year + .2, y = ValueNumeric, yend = ValueNumeric),
    size = 2,
    lineend = "round"
  ) +
  scale_x_continuous(limits = c(1999, 2025), breaks = c(2000, 2010, 2021)) +
  geom_text(
    data = age_mort_tops %>% filter(d_first_top == 1) %>% filter(year == 2000),
    aes(label = TITLE, x = year - .2),
    color = "black",
    nudge_y = .4,
    nudge_x = -.05,
    size = 5,
    hjust = 0
  ) +
  geom_text(
    data = age_mort_tops %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(label = str_wrap(TITLE, 25)),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 5
  ) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title = element_blank(),
    axis.text.x = element_text(face = 2, color = "black"),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  ) +
  geom_point(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  )

# ggsave("figures/aging_cod60_global_ranks_00-19.png", width=9.5, height=7, units="in")

ggplot(age_mort_tops %>% filter(year == 2000 | year == 2021 | (year == 2001 & ValueNumeric == 11)), aes(x = year, y = ValueNumeric, color = TITLE)) +
  geom_point(age_mort_tops %>% filter(year == 2000 | year == 2021) %>% filter(ValueNumeric < 11), mapping = aes(size = 7)) +
  geom_text(
    data = age_mort_tops %>% filter(year == min(year)) %>% filter(ValueNumeric < 11),
    aes(x = year - .1, label = str_wrap(TITLE, 25)), size = 5,
    color = "black",
    # nudge_y = .4,
    nudge_x = -1,
    hjust = 1, lineheight = .6
  ) +
  geom_text(
    data = age_mort_tops %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(x = year + .1, label = str_wrap(TITLE, 25)),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 5, lineheight = .6
  ) +
  geom_bump(size = 2, smooth = 4) +
#  scale_x_continuous(limits = c(1993, 2027), breaks = c(2000, 2021)) +
  scale_x_continuous(limits = c(1994, 2025), breaks = c(2000, 2021)) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(), axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title = element_blank(), panel.grid = element_blank(),
    axis.line = element_blank(),
    axis.text.x = element_text(face = 2, color = "black")
  ) +
  labs(
    y = "RANK",
    x = NULL
  ) +
  scale_y_reverse(limits = c(11.1, 0)) +
  geom_rect(mapping = aes(xmin = 2000, xmax = 2021, ymax = 10.5, ymin = 11.1), fill = "white", alpha = 0.05, colour = NA) +
  geom_point(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  )

# ggsave("figures/aging_cod60_global_ranks_00-19simplified.png", width=11.7, height=7, units="in")


## regional

age_mort_tops_r <- age_mort %>%
  filter(AGEGROUP_FK == "AGE60Y-PLUS") %>%
  filter(!is.na(TITLE)) %>%
  filter(SEX_FK == "BTSX") %>%
  filter(!is.na(REGION_FK), REGION_FK != "GLOBAL") %>%
  filter(MEASDEF_FK == "RANK") %>%
  mutate(year = as.numeric(YEAR_FK)) %>%
  group_by(TITLE, REGION_FK) %>%
  mutate(any_top10 = any(ValueNumeric <= 10)) %>%
  ungroup() %>%
  mutate(ValueNumeric = if_else(ValueNumeric > 10, 11, ValueNumeric)) %>%
  filter(any_top10 == T) %>%
  group_by(TITLE, REGION_FK) %>%
  mutate(
    first_top = min(year[ValueNumeric <= 10]),
    last_top = max(year[ValueNumeric <= 10]),
    d_first_top = if_else(year == first_top, 1, 0)
  ) %>%
  ungroup() %>%
  arrange(REGION_FK, TITLE, year) %>%
  group_by(REGION_FK, TITLE) %>%
  mutate(lag_zero = if_else(lag(ValueNumeric) %in% c(11, NA) & ValueNumeric <= 10, 1, 0, 0)) %>%
  ungroup() %>%
  mutate(group = cumsum(lag_zero)) %>%
  dplyr::select(TITLE, REGION_FK, year, ValueNumeric, first_top, last_top, d_first_top, group, cause_group)


ggplot(age_mort_tops_r, aes(x = year, y = ValueNumeric, color = cause_group, group = TITLE)) +
  geom_bump(smooth = 15, size = 2, alpha = 0.2) +
  scale_y_reverse() +
  geom_bump(
    data = age_mort_tops_r, # %>% filter(ValueNumeric <= 10),
    aes(year, ValueNumeric, group = TITLE, color = cause_group),
    smooth = 15, size = 2, inherit.aes = F
  ) +
  geom_point(
    data = age_mort_tops_r %>% filter(d_first_top == 1),
    aes(x = year - .2),
    size = 5
  ) +
  geom_segment(
    data = age_mort_tops_r %>% filter(ValueNumeric <= 10),
    aes(x = year - .2, xend = year + .2, y = ValueNumeric, yend = ValueNumeric),
    size = 2,
    lineend = "round"
  ) +
  scale_colour_manual(values = c("#009E73", "#D55E00", "grey"), name = NULL) +
  scale_x_continuous(limits = c(1999, 2022), breaks = c(2000, 2005, 2010, 2015, 2021)) +
  geom_text(
    data = age_mort_tops_r %>% filter(d_first_top == 1),
    aes(label = TITLE, x = year - .2),
    color = "black",
    nudge_y = .43,
    nudge_x = -.05,
    size = 3.5,
    fontface = 2,
    hjust = 0
  ) +
  geom_text(
    data = age_mort_tops_r %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(label = TITLE),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 3.5,
    fontface = 2
  ) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    plot.title = element_text(hjust = .5, color = "black"),
    plot.caption = element_text(hjust = 1, color = "black", size = 8),
    plot.subtitle = element_text(hjust = .5, color = "black", size = 10),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_text(face = 2, color = "black"),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  ) +
  geom_point(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  ) +
  facet_wrap(~REGION_FK)


## income

bump_plot <- function(data, grouping) {
  gg_list <- list()

  for (i in 1:length(unique(data[[grouping]]))) {
    igrouping <- unique(data[[grouping]][!is.na(data[[grouping]])])
    data <- data[data[[grouping]] == igrouping[1], ]
    data <- data %>%
      filter(AGEGROUP_FK == "AGE60Y-PLUS") %>%
      filter(!is.na(TITLE)) %>%
      filter(SEX_FK == "BTSX") %>%
      filter(MEASDEF_FK == "RANK") %>%
      mutate(year = as.numeric(YEAR_FK)) %>%
      group_by(TITLE) %>%
      mutate(any_top10 = any(ValueNumeric <= 10)) %>%
      ungroup() %>%
      mutate(ValueNumeric = if_else(ValueNumeric > 10, 11, ValueNumeric)) %>%
      filter(any_top10 == T) %>%
      group_by(TITLE) %>%
      mutate(
        first_top = min(year[ValueNumeric <= 10]),
        last_top = max(year[ValueNumeric <= 10]),
        d_first_top = if_else(year == first_top, 1, 0)
      ) %>%
      ungroup() %>%
      # problem here ####
      arrange(TITLE, year) %>%
      group_by(TITLE) %>%
      mutate(lag_zero = if_else(lag(ValueNumeric) %in% c(11, NA) & ValueNumeric <= 10, 1, 0, 0)) %>%
      ungroup() %>%
      mutate(group = cumsum(lag_zero)) # %>%
    # dplyr::select(TITLE, grouping, year, ValueNumeric, first_top, last_top, d_first_top, group, cause_group, lag_zero)


    gg_list[[i]] <- ggplot(data, aes(x = year, y = ValueNumeric, color = cause_group, group = TITLE)) +
      geom_bump(smooth = 15, size = 2, alpha = 0.2) +
      scale_y_reverse() +
      geom_bump(
        data = data %>% filter(ValueNumeric <= 10),
        aes(year, ValueNumeric,
          group = group,
          color = cause_group
        ),
        smooth = 15, size = 2, inherit.aes = F
      ) +
      geom_point(
        data = data %>% filter(d_first_top == 1),
        aes(x = year - .2),
        size = 5
      ) +
      geom_segment(
        data = data %>% filter(ValueNumeric <= 10),
        aes(x = year - .2, xend = year + .2, y = ValueNumeric, yend = ValueNumeric),
        size = 2,
        lineend = "round"
      ) +
      scale_colour_manual(values = c("#009E73", "#D55E00", "grey"), name = NULL) +
      scale_x_continuous(limits = c(1999, 2022.5), breaks = c(2000, 2005, 2010, 2015, 2021)) +
      geom_text(
        data = data %>% filter(d_first_top == 1) %>% filter(year == 2000),
        aes(label = TITLE, x = year - .2),
        color = "black",
        nudge_y = .4,
        nudge_x = -.05,
        size = 3.5,
        fontface = 2,
        hjust = 0
      ) +
      geom_text(
        data = data %>% filter(d_first_top == 1) %>% filter(year != 2000),
        aes(label = TITLE, x = year - .2),
        color = "black",
        nudge_y = -.3,
        nudge_x = -.05,
        size = 3.5,
        fontface = 2,
        hjust = 0
      ) +
      geom_text(
        data = data %>% filter(year == max(year)) %>% filter(ValueNumeric < 11), aes(label = str_wrap(TITLE, 20)),
        color = "black",
        nudge_x = .31,
        hjust = 0,
        size = 3.5,
        fontface = 2,
        lineheight = .6
      ) +
      cowplot::theme_minimal_hgrid(font_size = 14) +
      theme(
        legend.position = "bottom",
        panel.grid = element_blank(),
        plot.title = element_text(hjust = .5, color = "black"),
        plot.caption = element_text(hjust = 1, color = "black", size = 8),
        plot.subtitle = element_text(hjust = .5, color = "black", size = 10),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(face = 2, color = "black"),
        panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white")
      ) +
      geom_point(
        data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
        inherit.aes = F,
        color = "black",
        size = 10,
        pch = 21
      ) +
      geom_text(
        data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
        inherit.aes = F,
        color = "black"
      )
  }

  gg_list
}

x <- bump_plot(data = age_mort, grouping = "WORLDBANKINCOMEGROUP_FK")

age_mort_tops_i <- age_mort %>%
  filter(AGEGROUP_FK == "AGE60Y-PLUS") %>%
  filter(!is.na(TITLE)) %>%
  filter(SEX_FK == "BTSX") %>%
  filter(!is.na(WORLDBANKINCOMEGROUP_FK), WORLDBANKINCOMEGROUP_FK != "WB_WORLD_INCOME") %>%
  mutate(income = case_when(WORLDBANKINCOMEGROUP_FK == "WB_LI" ~ "Low-income", WORLDBANKINCOMEGROUP_FK == "WB_LMI" ~ "Lower-middle", WORLDBANKINCOMEGROUP_FK == "WB_UMI" ~ "Upper-middle", WORLDBANKINCOMEGROUP_FK == "WB_HI" ~ "High-income"), income = factor(income, levels = c("Low-income", "Lower-middle", "Upper-middle", "High-income"))) %>%
  filter(MEASDEF_FK == "RANK") %>%
  mutate(year = as.numeric(YEAR_FK)) %>%
  group_by(TITLE, WORLDBANKINCOMEGROUP_FK) %>%
  mutate(any_top10 = any(ValueNumeric <= 10)) %>%
  ungroup() %>%
  mutate(ValueNumeric = if_else(ValueNumeric > 10, 11, ValueNumeric)) %>%
  filter(any_top10 == T) %>%
  group_by(TITLE, WORLDBANKINCOMEGROUP_FK) %>%
  mutate(
    first_top = min(year[ValueNumeric <= 10]),
    last_top = max(year[ValueNumeric <= 10]),
    d_first_top = if_else(year == first_top, 1, 0)
  ) %>%
  ungroup() %>%
  # problem here ####
  arrange(WORLDBANKINCOMEGROUP_FK, TITLE, year) %>%
  group_by(TITLE, WORLDBANKINCOMEGROUP_FK) %>%
  mutate(lag_zero = if_else(lag(ValueNumeric) %in% c(11, NA) & ValueNumeric <= 10, 1, 0, 0)) %>%
  ungroup() %>%
  group_by(income) %>%
  mutate(group = cumsum(lag_zero)) %>%
  dplyr::select(TITLE, income, year, ValueNumeric, first_top, last_top, d_first_top, group, cause_group, lag_zero)


ggplot(age_mort_tops_i, aes(x = year, y = ValueNumeric, color = cause_group, group = TITLE)) +
  geom_bump(smooth = 15, size = 2, alpha = 0.2) +
  scale_y_reverse() +
  geom_bump(
    data = age_mort_tops_i, # %>% filter(ValueNumeric <= 10),
    aes(year, ValueNumeric,
      group = TITLE,
      color = cause_group
    ),
    smooth = 15, size = 2, inherit.aes = F
  ) +
  geom_point(
    data = age_mort_tops_i %>% filter(d_first_top == 1),
    aes(x = year - .2),
    size = 5
  ) +
  geom_segment(
    data = age_mort_tops_i %>% filter(ValueNumeric <= 10),
    aes(x = year - .2, xend = year + .2, y = ValueNumeric, yend = ValueNumeric),
    size = 2,
    lineend = "round"
  ) +
  scale_colour_manual(values = c("#009E73", "#D55E00", "grey"), name = NULL) +
  scale_x_continuous(limits = c(1999, 2022.5), breaks = c(2000, 2005, 2010, 2015, 2021)) +
  geom_text(
    data = age_mort_tops_i %>% filter(d_first_top == 1) %>% filter(year == 2000),
    aes(label = TITLE, x = year),
    color = "black",
    nudge_y = .4,
    nudge_x = -.05,
    size = 3,
    hjust = 0
  ) +
  geom_text(
    data = age_mort_tops_i %>% filter(d_first_top == 1) %>% filter(year != 2000),
    aes(label = TITLE, x = year),
    color = "black",
    nudge_y = -.3,
    nudge_x = -.05,
    size = 3,
    hjust = 0
  ) +
  geom_text(
    data = age_mort_tops_i %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(label = str_wrap(TITLE, 20)),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 3,
    lineheight = .6
  ) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "bottom",
    panel.grid = element_blank(),
    plot.title = element_text(hjust = .5, color = "black"),
    plot.caption = element_text(hjust = 1, color = "black", size = 8),
    plot.subtitle = element_text(hjust = .5, color = "black", size = 10),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_text(face = 2, color = "black"),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  ) +
  geom_point(
    data = tibble(x = 1999.2, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 7,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.2, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  ) +
  facet_wrap(~income)

# ggsave("figures/aging_cod60_income_ranks.png", width=16, height=8, units="in")

# simplified

ggplot(age_mort_tops_i %>% filter(year == 2000 | year == 2021), aes(x = year, y = ValueNumeric, color = cause_group, group = TITLE)) +
  geom_point(age_mort_tops_i %>% filter(year == 2000 | year == 2021) %>% filter(ValueNumeric < 11), mapping = aes(size = 7, colour = cause_group)) +
  geom_bump(size = 2, smooth = 4) +
  scale_x_continuous(limits = c(1993, 2025), breaks = c(2000, 2021)) +
  scale_colour_manual(values = c("#009E73", "#D55E00", "grey"), name = NULL) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(), axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title = element_blank(), panel.grid = element_blank(),
    axis.line = element_blank(),
    axis.text.x = element_text(face = 2, color = "black")
  ) +
  labs(
    y = "RANK",
    x = NULL
  ) +
  scale_y_reverse(limits = c(11.1, 0), expand = c(0, 0)) +
  geom_rect(mapping = aes(xmin = 2000, xmax = 2021, ymax = 10.5, ymin = 11.1), fill = "white", alpha = 0.05, colour = NA) +
  geom_point(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  ) +
  facet_wrap(~income) +
  geom_text(
    data = age_mort_tops_i %>% filter(year == min(year)) %>% filter(ValueNumeric < 11),
    aes(x = year - .1, label = str_wrap(TITLE, 20)), size = 5,
    color = "black",
    # nudge_y = -.4,
    nudge_x = -1.5,
    hjust = 1,
    lineheight = .6
  ) +
  geom_text(
    data = age_mort_tops_i %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(x = year + .1, label = str_wrap(TITLE, 20)),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 5, lineheight = .6
  )

# ggsave("figures/aging_cod60_income_ranks_simplified.png", width=15, height=8, units="in")

age_mort_tops_ix <- age_mort_tops_i %>% filter(year == 2000 | year == 2021)
age_mort_tops_ix$year[age_mort_tops_ix$year == 2021] <- 2001

ggplot(age_mort_tops_ix %>% filter(year == 2000 | year == 2001) %>% group_by(income, TITLE) %>% mutate(eleven = sum(ValueNumeric)) %>% filter(eleven != 22), aes(x = year, y = ValueNumeric, color = cause_group, group = TITLE)) +
  geom_point(age_mort_tops_ix %>% filter(year == 2000 | year == 2001) %>% filter(ValueNumeric < 11), mapping = aes(size = 7, colour = cause_group, shape = cause_group)) +
  geom_bump(size = 2, smooth = 4) +
  scale_x_continuous(limits = c(1998.9, 2002.1), breaks = c(2000, 2001), labels = c("2000", "2021")) +
  scale_colour_manual(values = c("#1b9e77", "#7570b3", "grey"), name = NULL) +
  scale_shape_manual(values = c(16, 15)) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(), axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title = element_blank(), panel.grid = element_blank(),
    axis.line = element_blank(),
    axis.text.x = element_text(face = 2, color = "black")
  ) +
  labs(
    y = "RANK",
    x = NULL
  ) +
  scale_y_reverse(limits = c(11.1, 0), expand = c(0, 0)) +
  geom_rect(mapping = aes(xmin = 2000, xmax = 2001, ymax = 10.5, ymin = 11.1), fill = "white", alpha = 0.05, colour = NA) +
  geom_point(
    data = tibble(x = 1999.9, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.9, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  ) +
  facet_wrap(~income) +
  geom_text(
    data = age_mort_tops_ix %>% filter(year == min(year)) %>% filter(ValueNumeric < 11),
    aes(x = year - .1, label = str_wrap(TITLE, 20)), size = 5,
    color = "black",
    # nudge_y = -.4,
    nudge_x = -.1,
    hjust = 1,
    lineheight = .6
  ) +
  geom_text(
    data = age_mort_tops_ix %>% filter(year == 2001) %>% filter(ValueNumeric < 11),
    aes(x = year + .1, label = str_wrap(TITLE, 20)),
    color = "black",
    # nudge_x = .31,
    hjust = 0,
    size = 5, lineheight = .6
  )

# ggsave("figures/aging_cod60_income_ranks_simplified_narrow.png", width=15, height=8, units="in")

#####

age_mort_tops <- age_mort %>%
  filter(AGEGROUP_FK == "AGE60Y-PLUS") %>%
  filter(REGION_FK == "GLOBAL") %>%
  filter(!is.na(TITLE)) %>%
  filter(SEX_FK == "BTSX") %>%
  filter(MEASDEF_FK == "DEATH_RATE") %>%
  mutate(year = as.numeric(YEAR_FK)) %>%
  group_by(year) %>%
  arrange(-ValueNumeric) %>%
  mutate(top10 = ifelse(row_number() <= 10, "top10", 0))

top10causes <- age_mort_tops$TITLE[age_mort_tops$top10 == "top10" & (age_mort_tops$year == 2000 | age_mort_tops$year == 2021)]

age_mort_tops <- age_mort_tops %>% filter(TITLE %in% top10causes)

ggplot(age_mort_tops %>% mutate(causename.group = reorder_within(TITLE, ValueNumeric, cause_group))) +
  geom_line(aes(x = as.numeric(year), y = ValueNumeric, group = causename.group, colour = as.character(cause_group)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c("Communicable, maternal, perinatal and nutritional conditions", "Injuries", "Noncommunicable diseases")) +
  scale_x_continuous(limits = c(2000, 2029), breaks = c(2000, 2005, 2010, 2015, 2021)) +
  # scale_y_continuous(limits=c(0,25))+
  geom_text_repel(data = age_mort_tops %>% filter(year == "2021"), aes(label = TITLE, y = ValueNumeric), x = 2021, show.legend = F, nudge_x = 3, nudge_y = 4, size = 4, hjust = 0) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL)

# ggsave("figures/aging_cod60_global_rate.png", width=16, height=8, units="in")


```

```{r age_yld}
xmart_yld <- fromJSON("https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA_AGGREGATED?$filter=INDICATOR_FK%20in%20(%22AGE_YLD%22)%20and%20SEX_FK%20in%20(%22BTSX%22)")

#29260 obs in xmart now

age_yld <- as.data.frame(xmart_yld$value)

saveRDS(age_yld, "data/age_yld.rds")
age_yld <- readRDS("data/age_yld.rds")

# cod_ref <- as.data.frame(xmart_cod_ref$value)
# saveRDS(cod_ref, "data/cod_ref.rds")
cod_ref <- readRDS("data/cod_ref.rds")

cod_ref$cause_group[str_detect(cod_ref$DESCRIPTION, "I.")] <- "Communicable, maternal, perinatal and nutritional conditions"
cod_ref$cause_group[str_detect(cod_ref$DESCRIPTION, "II.")] <- "Noncommunicable diseases"
cod_ref$cause_group[str_detect(cod_ref$DESCRIPTION, "III.")] <- "Injuries"


# age_yld <- left_join(age_yld, cod_ref[, c("cause_group", "TITLE")], by = c("CauseGHE_FK" = "TITLE"))
age_yld <- left_join(age_yld, cod_ref[, c("cause_group", "CODE", "TITLE")], by = c("CauseGHE_FK" = "CODE"))

# devtools::install_github("davidsjoberg/ggbump")
library(ggbump)

age_yld_tops <- age_yld %>%
  filter(AGEGROUP_FK == "AGE60Y-PLUS") %>%
  filter(REGION_FK == "GLOBAL") %>%
  filter(!is.na(TITLE)) %>%
  filter(SEX_FK == "BTSX") %>%
  filter(MEASDEF_FK == "RANK") %>%
  mutate(year = as.numeric(YEAR_FK)) %>%
  ungroup() %>%
  group_by(TITLE) %>%
  mutate(any_top10 = any(ValueNumeric <= 10)) %>%
  ungroup() %>%
  mutate(ValueNumeric = if_else(ValueNumeric > 10, 11, ValueNumeric)) %>%
  filter(any_top10 == T) %>%
  group_by(TITLE) %>%
  mutate(
    first_top = min(year[ValueNumeric <= 10]),
    last_top = max(year[ValueNumeric <= 10]),
    d_first_top = if_else(year == first_top, 1, 0)
  ) %>%
  ungroup() %>%
  arrange(TITLE, year) %>%
  group_by(TITLE) %>%
  mutate(lag_zero = if_else(lag(ValueNumeric) %in% c(11, NA) & ValueNumeric <= 10, 1, 0, 0)) %>%
  ungroup() %>%
  mutate(group = cumsum(lag_zero)) %>%
  dplyr::select(TITLE, year, ValueNumeric, first_top, last_top, d_first_top, group, cause_group)

ggplot(age_yld_tops, aes(x = year, y = ValueNumeric, color = TITLE, group = TITLE)) +
  geom_bump(smooth = 15, size = 2, alpha = 0.2) +
  scale_y_reverse() +
  geom_bump(
    data = age_yld_tops %>% filter(ValueNumeric <= 10),
    aes(year, ValueNumeric, group = group, color = TITLE),
    smooth = 15, size = 2, inherit.aes = F
  ) +
  geom_point(
    data = age_yld_tops %>% filter(d_first_top == 1),
    aes(x = year - .2),
    size = 5
  ) +
  geom_segment(
    data = age_yld_tops %>% filter(ValueNumeric <= 10),
    aes(x = year - .2, xend = year + .2, y = ValueNumeric, yend = ValueNumeric),
    size = 2,
    lineend = "round"
  ) +
  scale_colour_viridis_d() +
  scale_x_continuous(limits = c(1999, 2022), breaks = c(2000, 2005, 2010, 2015, 2021)) +
  geom_text(
    data = age_yld_tops %>% filter(d_first_top == 1) %>% filter(year == 2000),
    aes(label = TITLE, x = year - .2),
    color = "black",
    nudge_y = .4,
    nudge_x = -.05,
    size = 3.5,
    fontface = 2,
    hjust = 0
  ) +
  geom_text(
    data = age_yld_tops %>% filter(d_first_top == 1) %>% filter(year != 2000),
    aes(label = TITLE, x = year - .2),
    color = "black",
    nudge_y = -.3,
    nudge_x = -.05,
    size = 3.5,
    fontface = 2,
    hjust = 0
  ) +
  geom_text(
    data = age_yld_tops %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(label = TITLE),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 3.5,
    fontface = 2
  ) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "none",
    panel.grid = element_blank(),
    plot.title = element_text(hjust = .5, color = "black"),
    plot.caption = element_text(hjust = 1, color = "black", size = 8),
    plot.subtitle = element_text(hjust = .5, color = "black", size = 10),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.text.x = element_text(face = 2, color = "black"),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  ) +
  geom_point(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  )

# ggsave("figures/aging_yld_global_ranks.png", width=16, height=7, units="in")

ggplot(age_yld_tops %>% filter(year == 2000 | year == 2021 | (year == 2001 & ValueNumeric == 11)), aes(x = year, y = ValueNumeric, colour = TITLE)) +
  geom_point(age_yld_tops %>% filter(year == 2000 | year == 2021) %>% filter(ValueNumeric < 11), mapping = aes(size = 7)) +
  geom_text(
    data = age_yld_tops %>% filter(year == min(year)) %>% filter(ValueNumeric < 11),
    aes(x = year - .1, label = str_wrap(TITLE, 25)), size = 5,
    color = "black",
    # nudge_y = .4,
    nudge_x = -1,
    hjust = 1, lineheight = .6
  ) +
  geom_text(
    data = age_yld_tops %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(x = year + .1, label = str_wrap(TITLE, 25)),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 5, lineheight = .6
  ) +
  geom_bump(size = 2, smooth = 4) +
#  scale_x_continuous(limits = c(1994, 2027), breaks = c(2000, 2021)) +
  scale_x_continuous(limits = c(1994, 2025), breaks = c(2000, 2021)) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(), axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title = element_blank(), panel.grid = element_blank(),
    axis.line = element_blank(),
    axis.text.x = element_text(face = 2, color = "black")
  ) +
  labs(
    y = "RANK",
    x = NULL
  ) +
  scale_y_reverse(limits = c(11.1, 0)) +
  geom_rect(mapping = aes(xmin = 2000, xmax = 2021, ymax = 10.5, ymin = 11.1), fill = "white", alpha = 0.05, colour = NA) +
  geom_point(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  )

# ggsave("figures/aging_yld_global_ranks_simplified.png", width=12.4, height=7, units="in")

ggplot(age_yld_tops %>% filter(year == 2000 | year == 2021 | (year == 2001 & ValueNumeric == 11)), aes(x = year, y = ValueNumeric, group = TITLE, colour = cause_group)) +
  geom_point(age_yld_tops %>% filter(year == 2000 | year == 2021) %>% filter(ValueNumeric < 11), mapping = aes(size = 7, shape = cause_group)) +
  geom_text(
    data = age_yld_tops %>% filter(year == min(year)) %>% filter(ValueNumeric < 11),
    aes(x = year - .1, label = str_wrap(TITLE, 25)), size = 5,
    color = "black",
    # nudge_y = .4,
    nudge_x = -1,
    hjust = 1, lineheight = .6
  ) +
  geom_text(
    data = age_yld_tops %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(x = year + .1, label = str_wrap(TITLE, 25)),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 5, lineheight = .6
  ) +
  geom_bump(size = 2, smooth = 4) +
  scale_colour_manual(values = c("#d95f02", "#7570b3", "grey"), name = NULL) +
  scale_shape_manual(values = c(17, 15)) +
  scale_x_continuous(limits = c(1994, 2025), breaks = c(2000, 2021)) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "none",
    panel.grid.major = element_blank(), axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title = element_blank(), panel.grid = element_blank(),
    axis.line = element_blank(),
    axis.text.x = element_text(face = 2, color = "black")
  ) +
  labs(
    y = "RANK",
    x = NULL
  ) +
  scale_y_reverse(limits = c(11.1, 0)) +
  geom_rect(mapping = aes(xmin = 2000, xmax = 2021, ymax = 10.5, ymin = 11.1), fill = "white", alpha = 0.05, colour = NA) +
  geom_point(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  )
# ggsave("figures/aging_yld_global_ranks_simplified_grouped.png", width=12.4, height=7, units="in")



## region

age_yld_tops_r <- age_yld %>%
  filter(AGEGROUP_FK == "AGE60Y-PLUS") %>%
  filter(!is.na(TITLE)) %>%
  filter(SEX_FK == "BTSX") %>%
  filter(!is.na(REGION_FK), REGION_FK != "GLOBAL") %>%
  filter(MEASDEF_FK == "RANK") %>%
  mutate(year = as.numeric(YEAR_FK)) %>%
  group_by(TITLE, REGION_FK) %>%
  mutate(any_top10 = any(ValueNumeric <= 10)) %>%
  ungroup() %>%
  mutate(ValueNumeric = if_else(ValueNumeric > 10, 11, ValueNumeric)) %>%
  filter(any_top10 == T) %>%
  group_by(TITLE, REGION_FK) %>%
  mutate(
    first_top = min(year[ValueNumeric <= 10]),
    last_top = max(year[ValueNumeric <= 10]),
    d_first_top = if_else(year == first_top, 1, 0)
  ) %>%
  ungroup() %>%
  arrange(REGION_FK, TITLE, year) %>%
  group_by(REGION_FK, TITLE) %>%
  mutate(lag_zero = if_else(lag(ValueNumeric) %in% c(11, NA) & ValueNumeric <= 10, 1, 0, 0)) %>%
  ungroup() %>%
  mutate(group = cumsum(lag_zero)) %>%
  dplyr::select(TITLE, REGION_FK, year, ValueNumeric, first_top, last_top, d_first_top, group, cause_group)


ggplot(age_yld_tops_r, aes(x = year, y = ValueNumeric, color = cause_group, group = TITLE)) +
  geom_bump(smooth = 15, size = 2, alpha = 0.2) +
  scale_y_reverse() +
  geom_bump(
    data = age_yld_tops_r, # %>% filter(ValueNumeric <= 10),
    aes(year, ValueNumeric, group = TITLE, color = cause_group),
    smooth = 15, size = 2, inherit.aes = F
  ) +
  geom_point(
    data = age_yld_tops_r %>% filter(d_first_top == 1),
    aes(x = year - .2),
    size = 5
  ) +
  geom_segment(
    data = age_yld_tops_r %>% filter(ValueNumeric <= 10),
    aes(x = year - .2, xend = year + .2, y = ValueNumeric, yend = ValueNumeric),
    size = 2,
    lineend = "round"
  ) +
  scale_colour_manual(values = c("#009E73", "#D55E00", "#CC79A7"), name = NULL) +
  scale_x_continuous(limits = c(1999, 2022), breaks = c(2000, 2005, 2010, 2015, 2021)) +
  geom_text(
    data = age_yld_tops_r %>% filter(d_first_top == 1),
    aes(label = TITLE, x = year - .2),
    color = "black",
    nudge_y = .43,
    nudge_x = -.05,
    size = 3.5,
    fontface = 2,
    hjust = 0
  ) +
  geom_text(
    data = age_yld_tops_r %>% filter(year == max(year)) %>% filter(ValueNumeric < 11),
    aes(label = TITLE),
    color = "black",
    nudge_x = .31,
    hjust = 0,
    size = 3.5,
    fontface = 2
  ) +
  cowplot::theme_minimal_hgrid(font_size = 14) +
  theme(
    legend.position = "bottom",
    panel.grid = element_blank(),
    plot.title = element_text(hjust = .5, color = "black"),
    plot.caption = element_text(hjust = 1, color = "black", size = 8),
    plot.subtitle = element_text(hjust = .5, color = "black", size = 10),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    axis.text.y = element_blank(),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_text(face = 2, color = "black"),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white")
  ) +
  geom_point(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y),
    inherit.aes = F,
    color = "black",
    size = 10,
    pch = 21
  ) +
  geom_text(
    data = tibble(x = 1999.5, y = 1:10), aes(x = x, y = y, label = y),
    inherit.aes = F,
    color = "black"
  ) +
  facet_wrap(~REGION_FK)

```

```{r unigme_childmort21}

# fig 1 from 2023 unigme report (pg 12) https://childmortality.org/wp-content/uploads/2024/03/UNIGME-2023-Child-Mortality-Report.pdf  (Page 15 in PDF)

fig2 <- as.data.frame(cbind(age = c("Neonatal (0-27 days)", "Children aged 1-11 months", "Children aged 1-4 years", "Children aged 5-9 years", "Young adolescents aged 10-14 years", "Older adolescents aged 15-49 years", "Youth aged 20-24 years", "Under five", "Children and youth aged 5-24"), category = c(1, 1, 1, 1, 1, 1, 1, 2, 2), mortrate = c(17, 11, 9, 3, 3, 4, 6, 37, 16), deaths = c(2.3, 1.4, 1.2, 0.5, 0.3, 0.6, 0.7, 4.9, 2.1), percentage = c(33, 20, 17, 7, 5, 8, 11, 70, 30), order = c(1, 2, 3, 4, 5, 6, 7, 8, 9), u5 = c(1, 1, 1, 2, 2, 2, 2, 1, 2), percentageU5 = c(33/70*100, 20/70*100, 17/70*100, NA, NA, NA, NA, 100, NA)))

fig2$mortrate <- as.numeric(fig2$mortrate)
fig2$deaths <- as.numeric(fig2$deaths)
fig2$percentage <- as.numeric(fig2$percentage)
fig2$order <- as.numeric(fig2$order)
fig2$age <- factor(fig2$age, levels = c("Neonatal (0-27 days)", "Children aged 1-11 months", "Children aged 1-4 years", "Children aged 5-9 years", "Young adolescents aged 10-14 years", "Older adolescents aged 15-49 years", "Youth aged 20-24 years", "Under five", "Children and youth aged 5-24"))


## under five

ggplot(data = fig2 %>% filter(u5 == 1)) +
  geom_col(aes(x = order, y = mortrate, fill = age), width = .8) +
  theme_classic() +
  theme(legend.position = "none", strip.text = element_blank(), panel.border = element_rect(colour = "black", fill = NA), text = element_text(size = 15)) +
  scale_fill_manual(values = c("#C7A2A4", "#E8D1D1", "#C7D3E5", "#92ACD9")) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 40)) +
  geom_text(aes(x = order, y = mortrate, label = mortrate), nudge_y = 1, fontface = "bold", colour = "#525252", size = 5) +
  scale_x_continuous(breaks = fig2$order, labels = str_wrap(fig2$age, 10)) +
  facet_grid(~category, scales = "free", space = "free") +
  labs(y = "Deaths per 1,000", x = NULL)

# ggsave("figures/deathsper1000_igme2023est_0to5.png", width=8, height=7, units="in")

ggplot(data = fig2 %>% filter(u5 == 1) %>% group_by(category) %>% mutate(pos = cumsum(percentage) - (0.5 * percentage)), aes(x = category, y = percentage)) +
  geom_bar(aes(fill = age), stat = "identity", position = position_stack(reverse = TRUE), width = .4) +
  theme_classic() +
  theme(legend.position = "none", strip.text = element_blank(), panel.border = element_rect(colour = "black", fill = NA), text = element_text(size = 14), axis.text = element_blank(), axis.ticks = element_blank()) +
  scale_fill_manual(values = c("#C7A2A4", "#E8D1D1", "#C7D3E5", "#92ACD9")) +
  scale_y_continuous(expand = c(0, 0)) +
  geom_text(aes(label = str_wrap(age, 15), x = category, y = pos), lineheight = .8, vjust = -.5, size = 5) +
  geom_text(aes(label = paste0(deaths, " (", round(as.numeric(percentageU5),0), "%)"), x = category, y = pos), vjust = 1, fontface = "bold", size = 5.5) +
  labs(x = NULL, y = NULL)

# ggsave("figures/percentagedeaths_igme2023est_0to5.png", width=9, height=7, units="in")

```
 
```{r updated-adol-mort}

# data downloaded from mca portal 

#adol cod - https://platform.who.int/data/maternal-newborn-child-adolescent-ageing/indicator-explorer-new/mca/adolescent-mortality-ranking---top-5-causes-(country)
# AD_MORT_TOP5
# https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?%24filter=INDICATOR_FK%20in%20(%22AD_MORT_TOP5%22)


# adol mort - https://platform.who.int/data/maternal-newborn-child-adolescent-ageing/indicator-explorer-new/mca/all-cause-mortality-rate-for-adolescents-aged-10-19-years
# AD_MORT_ALL - 11286
# https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA_AGGREGATED?%24filter=INDICATOR_FK%20in%20(%22AD_MORT_ALL%22)
# https://xmart-api-public.who.int/MNCAH/MCA_FACT_DATA?%24filter=INDICATOR_FK%20in%20(%22AD_MORT_ALL%22)

adol_mort <- read_excel("data/adol-mort.xlsx", 
    sheet = "Data")

adol_mort_global <- read_excel("data/adol-mort-global.xlsx", 
    sheet = "Data")

# global values only up to 2019, same as previous... 
rm(adol_mort_global)

adol_mort_region <- read_excel("data/adol-mort-region.xlsx", 
    sheet = "Data")

adol_mort_income <- read_excel("data/adol-mort-income.xlsx", 
    sheet = "Data")

adol_cod <- read_excel("data/adol-cod.xlsx", 
    sheet = "Data")

adol_cod_region <- read_excel("data/adol-cod-region.xlsx", 
    sheet = "Data") |> rename("region"= `WHO region`, "age"= `Age group`, "sex"= Sex) |> filter(Measure == "Death Rate (per 100,000)") |> filter(age!="10-19")

# old data to get cause groups

# pqCause_specific_ranking_AllYears <- open_dataset("C:/Users/kpeve/OneDrive - London School of Hygiene and Tropical Medicine/My OneDrive Documents/WHO/Previous contract work/Slideset/data/raw/Cause_specific_ranking_AllYears.parquet")
pqCause_specific_ranking_AllYears <- open_dataset("data/raw/Cause_specific_ranking_AllYears.parquet")

# Causes <- pqCause_specific_ranking_AllYears %>%
#   filter(year == 2019) %>%
#   filter(age == 10 | age == 15) %>%
#   collect()

Causes <- pqCause_specific_ranking_AllYears %>%
  filter(year == 2021) %>%
  filter(age == "Y10T14" | age == "Y15T19" | age == "Y10T19") %>%
  collect()

Causes <- unique(Causes[, c("causename", "causegroup")])

adol_cod_region <- adol_cod_region |> left_join(Causes, by=c("Cause"="causename"))
adol_cod_region$causegroup[adol_cod_region$Cause=="COVID-19"] <- 1 

adol_cod_income <- read_excel("data/adol-cod-income.xlsx", 
    sheet = "Data") |> rename("region"= `WHO region`, "age"= `Age group`, "sex"= Sex, "income"= `World bank income group`) |> filter(Measure == "Death Rate (per 100,000)") |> filter(age!="10-19")
adol_cod_income <- adol_cod_income |> left_join(Causes, by=c("Cause"="causename"))
# adol_cod_income$causegroup[adol_cod_income$Cause=="COVID-19"] <- 1 


# region as colour

ggplot(adol_mort_region %>% filter(`WHO region`!="Global") |>  mutate(year=as.numeric(Year)) |> filter(!is.na(`Datasource short`)) |>  filter(`Age group`!="10-19") |>  filter(Measure == "Death Rate (per 100,000)") %>% filter(Sex != "Both sexes") %>% mutate(age.region = reorder_within(`WHO region`, year, `Age group`, sep = ", ")) %>% mutate(label = if_else(year == max(year), as.character(`WHO region`), NA_character_)), aes(x = year, y = `Value Numeric`, fill = age.region)) +
  geom_line(aes(y = `Value Numeric`, colour = `WHO region`), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2021), limits = c(2000, 2030)) +
  scale_y_continuous(breaks = seq(from = 0, to = 300, by = 25), limits = c(0, 300), expand = c(0, 0)) +
  scale_color_viridis_d() +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "Deaths per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 2, direction = "y", hjust = "left", size = 5.5) +
  facet_nested(rows = vars(`Age group`), cols = vars(Sex))

# ggsave("figures/mortrate_trends_regional_2024.png", width=19, height=8, unit="in")



# cause of death region

# regional

causeSpec_deaths_region_males10.14 <-  ggplot(adol_cod_region |> filter(Year==2021) |> filter(Measure=="Death Rate (per 100,000)") %>% filter(region != "Global") %>% filter(sex == "Male") %>% filter(age == "10-14") %>% group_by(age, region) %>% slice_max(order_by = (`Value Numeric`), n = 5), aes(y = reorder_within(Cause, `Value Numeric`, region), x = `Value Numeric`, fill=factor(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 75), breaks = seq(from = 0, to = 75, by = 10)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_region_males15.19 <-  ggplot(adol_cod_region |> filter(Year==2021) |> filter(Measure=="Death Rate (per 100,000)") %>% filter(region != "Global") |> filter(sex == "Male") %>% filter(age == "15-19") %>% group_by(age, region) %>% slice_max(order_by = (`Value Numeric`), n = 5), aes(y = reorder_within(Cause, `Value Numeric`, region), x = `Value Numeric`, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 75), breaks = seq(from = 0, to = 75, by = 10)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_region_males10.14 + causeSpec_deaths_region_males15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causedeaths_males-10-19_regional2021.png", width=15, height=10, unit="in")



causeSpec_deaths_region_females10.14 <-  ggplot(adol_cod_region |> filter(Year==2021) |> filter(Measure=="Death Rate (per 100,000)") %>% filter(region != "Global") %>% filter(sex == "Female") %>% filter(age == "10-14") %>% group_by(age, region) %>% slice_max(order_by = (`Value Numeric`), n = 5), aes(y = reorder_within(Cause, `Value Numeric`, region), x = `Value Numeric`, fill=factor(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 75), breaks = seq(from = 0, to = 75, by = 10)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_region_females15.19 <-  ggplot(adol_cod_region |> filter(Year==2021) |> filter(Measure=="Death Rate (per 100,000)") %>% filter(region != "Global") |> filter(sex == "Female") %>% filter(age == "15-19") %>% group_by(age, region) %>% slice_max(order_by = (`Value Numeric`), n = 5), aes(y = reorder_within(Cause, `Value Numeric`, region), x = `Value Numeric`, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 75), breaks = seq(from = 0, to = 75, by = 10)) +
  scale_y_reordered() +
  facet_grid(region ~ age, scales = "free", labeller = labeller(region = label_wrap_gen(8))) +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_region_females10.14 + causeSpec_deaths_region_females15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causedeaths_females-10-19_regional2021.png", width=15, height=10, unit="in")


##

# 10-14y males

Cause_specific_2000.2019_10.14ym_top5 <- adol_cod_region %>%
  filter(age == "10-14") %>%
  filter(region != "Global") %>%
  filter(sex == "Male") %>%
  filter(Measure=="Death Rate (per 100,000)") |> 
  group_by(Year, region) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(Cause, region))

top5causes <- Cause_specific_2000.2019_10.14ym_top5$causeRegion[Cause_specific_2000.2019_10.14ym_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14ym_top5$Year == 2000 | Cause_specific_2000.2019_10.14ym_top5$Year == 2021)]

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.14ym_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14ym_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup), Year=as.numeric(Year)) %>% mutate(label = if_else(Year == 2021, as.character(Cause), NA_character_))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2010, 2032), breaks = c(2010, 2015, 2021), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 180)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = `Value Numeric`, x = Year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2010.2021_10.14ym_top5_regional.png", width=16, height=9, unit="in")


# 15-19y males

Cause_specific_2000.2019_15.19ym_top5 <- adol_cod_region %>%
  filter(age == "15-19") %>%
  filter(region != "Global") %>%
  filter(sex == "Male") %>%
  filter(Measure=="Death Rate (per 100,000)") |> 
  group_by(Year, region) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(Cause, region))

top5causes <- Cause_specific_2000.2019_15.19ym_top5$causeRegion[Cause_specific_2000.2019_15.19ym_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19ym_top5$Year == 2000 | Cause_specific_2000.2019_15.19ym_top5$Year == 2021)]

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_15.19ym_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19ym_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup), Year=as.numeric(Year)) %>% mutate(label = if_else(Year == 2021, as.character(Cause), NA_character_))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2010, 2032), breaks = c(2010, 2015, 2021), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 180)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = `Value Numeric`, x = Year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2010.2021_15.19ym_top5_regional.png", width=16, height=9, unit="in")

# 10-14y females

Cause_specific_2000.2019_10.14yf_top5 <- adol_cod_region %>%
  filter(age == "10-14") %>%
  filter(region != "Global") %>%
  filter(sex == "Female") %>%
  filter(Measure=="Death Rate (per 100,000)") |> 
  group_by(Year, region) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(Cause, region))

top5causes <- Cause_specific_2000.2019_10.14yf_top5$causeRegion[Cause_specific_2000.2019_10.14yf_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14yf_top5$Year == 2000 | Cause_specific_2000.2019_10.14yf_top5$Year == 2021)]

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.14yf_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14yf_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup), Year=as.numeric(Year)) %>% mutate(label = if_else(Year == 2021, as.character(Cause), NA_character_))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2010, 2032), breaks = c(2010, 2015, 2021), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 180)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = `Value Numeric`, x = Year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2010.2021_10.14yf_top5_regional.png", width=16, height=9, unit="in")


# 15-19y females

Cause_specific_2000.2019_15.19yf_top5 <- adol_cod_region %>%
  filter(age == "15-19") %>%
  filter(region != "Global") %>%
  filter(sex == "Female") %>%
  filter(Measure=="Death Rate (per 100,000)") |> 
  group_by(Year, region) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeRegion = paste0(Cause, region))

top5causes <- Cause_specific_2000.2019_15.19yf_top5$causeRegion[Cause_specific_2000.2019_15.19yf_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19yf_top5$Year == 2000 | Cause_specific_2000.2019_15.19yf_top5$Year == 2021)]

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_15.19yf_top5 %>% filter(causeRegion %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19yf_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup), Year=as.numeric(Year)) %>% mutate(label = if_else(Year == 2021, as.character(Cause), NA_character_))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2010, 2032), breaks = c(2010, 2015, 2021), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 180)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = `Value Numeric`, x = Year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~region, labeller = labeller(region = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2010.2021_15.19yf_top5_regional.png", width=16, height=9, unit="in")



# cause of death income

# income

causeSpec_deaths_income_males10.14 <-  ggplot(adol_cod_income |> filter(Year==2021) |> filter(Measure=="Death Rate (per 100,000)") %>% filter(income != "Global") %>% filter(sex == "Male") %>% filter(age == "10-14") %>% group_by(age, income) %>% slice_max(order_by = (`Value Numeric`), n = 5), aes(x = reorder_within(str_wrap(Cause, 25), `Value Numeric`, income), y = `Value Numeric`, fill=factor(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100), breaks = seq(from = 0, to = 100, by = 20)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_income_males15.19 <-  
ggplot(adol_cod_income |> filter(Year==2021) |> filter(Measure=="Death Rate (per 100,000)") %>% filter(income != "Global") |> filter(sex == "Male") %>% filter(age == "15-19") %>% group_by(age, income) %>% slice_max(order_by = (`Value Numeric`), n = 5), aes(x = reorder_within(str_wrap(Cause, 25), `Value Numeric`, income), y = `Value Numeric`, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100), breaks = seq(from = 0, to = 100, by = 20)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_income_males10.14 / causeSpec_deaths_income_males15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causedeaths_males-10-19_income2021r.png", width=15, height=10, unit="in")



causeSpec_deaths_income_females10.14 <-  ggplot(adol_cod_income |> filter(Year==2021) |> filter(Measure=="Death Rate (per 100,000)") %>% filter(income != "Global") %>% filter(sex == "Female") %>% filter(age == "10-14") %>% group_by(age, income) %>% slice_max(order_by = (`Value Numeric`), n = 5), aes(x = reorder_within(str_wrap(Cause, 25), `Value Numeric`, income), y = `Value Numeric`, fill=factor(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100), breaks = seq(from = 0, to = 100, by = 20)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_income_females15.19 <-  ggplot(adol_cod_income |> filter(Year==2021) |> filter(Measure=="Death Rate (per 100,000)") %>% filter(income != "Global") |> filter(sex == "Female") %>% filter(age == "15-19") %>% group_by(age, income) %>% slice_max(order_by = (`Value Numeric`), n = 5), aes(x = reorder_within(str_wrap(Cause, 25), `Value Numeric`, income), y = `Value Numeric`, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18), axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, lineheight = .6)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_y_continuous(expand = c(0, 0), limits = c(0, 100), breaks = seq(from = 0, to = 100, by = 20)) +
  scale_x_reordered() +
  facet_grid(age ~ income, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_deaths_income_females10.14 / causeSpec_deaths_income_females15.19 + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causedeaths_females-10-19_income2021r.png", width=15, height=10, unit="in")


##

# 10-14y males

Cause_specific_2000.2019_10.14ym_top5 <- adol_cod_income %>%
  filter(age == "10-14") %>%
  filter(income != "Global") %>%
  filter(sex == "Male") %>%
  filter(Measure=="Death Rate (per 100,000)") |> 
  group_by(Year, income) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(Cause, income))

top5causes <- Cause_specific_2000.2019_10.14ym_top5$causeincome[Cause_specific_2000.2019_10.14ym_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14ym_top5$Year == 2000 | Cause_specific_2000.2019_10.14ym_top5$Year == 2021)]

Cause_specific_2000.2019_10.14ym_top5 <- Cause_specific_2000.2019_10.14ym_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14ym_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup), Year=as.numeric(Year)) %>% mutate(label = if_else(Year == 2021, as.character(Cause), NA_character_))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2010, 2032), breaks = c(2010, 2015, 2021), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 180)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = `Value Numeric`, x = Year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2010.2021_10.14ym_top5_income.png", width=16, height=9, unit="in")


# 15-19y males

Cause_specific_2000.2019_15.19ym_top5 <- adol_cod_income %>%
  filter(age == "15-19") %>%
  filter(income != "Global") %>%
  filter(sex == "Male") %>%
  filter(Measure=="Death Rate (per 100,000)") |> 
  group_by(Year, income) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(Cause, income))

top5causes <- Cause_specific_2000.2019_15.19ym_top5$causeincome[Cause_specific_2000.2019_15.19ym_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19ym_top5$Year == 2000 | Cause_specific_2000.2019_15.19ym_top5$Year == 2021)]

Cause_specific_2000.2019_15.19ym_top5 <- Cause_specific_2000.2019_15.19ym_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19ym_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup), Year=as.numeric(Year)) %>% mutate(label = if_else(Year == 2021, as.character(Cause), NA_character_))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2010, 2032), breaks = c(2010, 2015, 2021), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 180)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = `Value Numeric`, x = Year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2010.2021_15.19ym_top5_income.png", width=16, height=9, unit="in")

# 10-14y females

Cause_specific_2000.2019_10.14yf_top5 <- adol_cod_income %>%
  filter(age == "10-14") %>%
  filter(income != "Global") %>%
  filter(sex == "Female") %>%
  filter(Measure=="Death Rate (per 100,000)") |> 
  group_by(Year, income) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(Cause, income))

top5causes <- Cause_specific_2000.2019_10.14yf_top5$causeincome[Cause_specific_2000.2019_10.14yf_top5$top5 == "top5" & (Cause_specific_2000.2019_10.14yf_top5$Year == 2000 | Cause_specific_2000.2019_10.14yf_top5$Year == 2021)]

Cause_specific_2000.2019_10.14yf_top5 <- Cause_specific_2000.2019_10.14yf_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_10.14yf_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup), Year=as.numeric(Year)) %>% mutate(label = if_else(Year == 2021, as.character(Cause), NA_character_))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2010, 2032), breaks = c(2010, 2015, 2021), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 180)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = `Value Numeric`, x = Year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2010.2021_10.14yf_top5_income.png", width=16, height=9, unit="in")


# 15-19y females

Cause_specific_2000.2019_15.19yf_top5 <- adol_cod_income %>%
  filter(age == "15-19") %>%
  filter(income != "Global") %>%
  filter(sex == "Female") %>%
  filter(Measure=="Death Rate (per 100,000)") |> 
  group_by(Year, income) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0)) %>%
  mutate(causeincome = paste0(Cause, income))

top5causes <- Cause_specific_2000.2019_15.19yf_top5$causeincome[Cause_specific_2000.2019_15.19yf_top5$top5 == "top5" & (Cause_specific_2000.2019_15.19yf_top5$Year == 2000 | Cause_specific_2000.2019_15.19yf_top5$Year == 2021)]

Cause_specific_2000.2019_15.19yf_top5 <- Cause_specific_2000.2019_15.19yf_top5 %>% filter(causeincome %in% top5causes)

ggplot(Cause_specific_2000.2019_15.19yf_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup), Year=as.numeric(Year)) %>% mutate(label = if_else(Year == 2021, as.character(Cause), NA_character_))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2010, 2032), breaks = c(2010, 2015, 2021), expand = c(0, 0)) +
  scale_y_continuous(limits = c(0, 180)) +
  geom_text_repel(aes(label = str_wrap(label, 20), y = `Value Numeric`, x = Year), show.legend = F, nudge_x = 3, direction = "y", hjust = 0, size = 4.5, lineheight = .6) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL) +
  facet_wrap(~income, labeller = labeller(income = label_wrap_gen(30)))

# ggsave("figures/Cause_specific_2010.2021_15.19yf_top5_income.png", width=16, height=9, unit="in")


###

# global 

# rates

ggplot(adol_mort_region |> filter(!is.na(`Datasource short`)) %>% mutate(Year = as.numeric(Year)) |> filter(`WHO region`=="Global") %>% filter(`Age group` == "10-14" | `Age group` == "15-19") %>% filter(Measure == "Death Rate (per 100,000)") %>% filter(Sex != "Both sexes") %>% mutate(sex.age = reorder_within(Sex, Year, `Age group`, sep = ", ")) %>% mutate(label = if_else(Year == max(Year), as.character(sex.age), NA_character_)), aes(x = Year, y = `Value Numeric`, fill = sex.age)) +
  geom_line(aes(y = `Value Numeric`, colour = sex.age), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2021), limits = c(2000, 2026)) +
  scale_y_continuous(breaks = seq(from = 0, to = 160, by = 25), limits = c(0, 160), expand = c(0, 0)) +
  scale_colour_manual(values = c("#fdae61", "#d7191c", "#abd9e9", "#2c7bb6")) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 18)) +
  labs(x = NULL, y = "Deaths per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 3, size = 5.5)

# ggsave("figures/mortRates_10-19_2021_global.png", width=10, height=6, unit="in")


# top 5 cause for 2021 for age and sex, by rate per 100000 pop

Cause_specific_2021_rates <- adol_cod_region %>%
  filter(age != "10-19") %>%
  filter(region == "Global") %>%
  filter(sex != "Both sexes") %>%
  filter(Measure=="Death Rate (per 100,000)") |> 
  filter(Year==2021)

causeSpec_rates_global_males <-  ggplot(Cause_specific_2021_rates %>% filter(sex == "Male") %>% group_by(age) %>% slice_max(order_by = `Value Numeric`, n = 5), aes(y = reorder_within(Cause, `Value Numeric`, age), x = `Value Numeric`, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 20), breaks = seq(from = 0, to = 20, by = 5)) +
  scale_y_reordered() +
  facet_grid(age ~ sex, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_rates_global_females <- ggplot(Cause_specific_2021_rates %>% filter(sex == "Female") %>% group_by(age) %>% slice_max(order_by = `Value Numeric`, n = 5), aes(y = reorder_within(Cause, `Value Numeric`, age), x = `Value Numeric`, fill = as.character(causegroup))) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_fill_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(expand = c(0, 0), limits = c(0, 20), breaks = seq(from = 0, to = 20, by = 5)) +
  scale_y_reordered() +
  facet_grid(age ~ sex, scales = "free") +
  labs(x = "Deaths per 100,000 population", y = NULL, fill = NULL)

causeSpec_rates_global_males + causeSpec_rates_global_females + plot_layout(guides = "collect") & theme(legend.position = "bottom")

# ggsave("figures/causeSpec-rates-10-19_global2021.png", width=10, height=6, unit="in")

## trends in causes global

# 10-14y males

Cause_specific_2000.2021_10.14ym_top5 <- adol_cod_region %>%
  mutate("year"=as.numeric(Year)) |> 
  filter(Measure=="Death Rate (per 100,000)") |> 
  filter(!is.na(`Datasource short`)) |> 
  filter(age == "10-14") %>%
  filter(region == "Global") %>%
  filter(sex == "Male") %>%
  group_by(year) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0))

top5causes <- Cause_specific_2000.2021_10.14ym_top5$Cause[Cause_specific_2000.2021_10.14ym_top5$top5 == "top5" & (Cause_specific_2000.2021_10.14ym_top5$year == 2007 | Cause_specific_2000.2021_10.14ym_top5$year == 2021)]

Cause_specific_2000.2021_10.14ym_top5 <- Cause_specific_2000.2021_10.14ym_top5 %>% filter(Cause %in% top5causes)

ggplot(Cause_specific_2000.2021_10.14ym_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2007, 2028), breaks = c(2007, 2015, 2021)) +
  scale_y_continuous(limits = c(0, 25)) +
  geom_text_repel(data = Cause_specific_2000.2021_10.14ym_top5 %>% filter(Year == "2021"), aes(label = Cause, y = `Value Numeric`), x = 2021, show.legend = F, fontface = "bold", nudge_x = 5, size = 3, min.segment.length =.2, direction="y", hjust=-0.5, vjust=.5 ) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specific_2007.2021_10.14ym_top5.png", width=9, height=5, unit="in")

# 15-19y males

Cause_specific_2000.2021_15.19ym_top5 <- adol_cod_region %>%
  mutate("year"=as.numeric(Year)) |> 
  filter(Measure=="Death Rate (per 100,000)") |> 
  filter(!is.na(`Datasource short`)) |> 
  filter(age == "15-19") %>%
  filter(region == "Global") %>%
  filter(sex == "Male") %>%
  group_by(year) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0))

top5causes <- Cause_specific_2000.2021_15.19ym_top5$Cause[Cause_specific_2000.2021_15.19ym_top5$top5 == "top5" & (Cause_specific_2000.2021_15.19ym_top5$year == 2007 | Cause_specific_2000.2021_15.19ym_top5$year == 2021)]

Cause_specific_2000.2021_15.19ym_top5 <- Cause_specific_2000.2021_15.19ym_top5 %>% filter(Cause %in% top5causes)

ggplot(Cause_specific_2000.2021_15.19ym_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2007, 2028), breaks = c(2007, 2015, 2021)) +
  scale_y_continuous(limits = c(0, 25)) +
  geom_text_repel(data = Cause_specific_2000.2021_15.19ym_top5 %>% filter(Year == "2021"), aes(label = Cause, y = `Value Numeric`), x = 2021, show.legend = F, fontface = "bold", nudge_x = 5, size = 3, min.segment.length =.2, direction="y", hjust=-0.5, vjust=.5 ) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specific_2007.2021_15.19ym_top5.png", width=9, height=5, unit="in")


# 10-14y Females

Cause_specific_2000.2021_10.14yf_top5 <- adol_cod_region %>%
  mutate("year"=as.numeric(Year)) |> 
  filter(Measure=="Death Rate (per 100,000)") |> 
  filter(!is.na(`Datasource short`)) |> 
  filter(age == "10-14") %>%
  filter(region == "Global") %>%
  filter(sex == "Female") %>%
  group_by(year) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0))

top5causes <- Cause_specific_2000.2021_10.14yf_top5$Cause[Cause_specific_2000.2021_10.14yf_top5$top5 == "top5" & (Cause_specific_2000.2021_10.14yf_top5$year == 2007 | Cause_specific_2000.2021_10.14yf_top5$year == 2021)]

Cause_specific_2000.2021_10.14yf_top5 <- Cause_specific_2000.2021_10.14yf_top5 %>% filter(Cause %in% top5causes)

ggplot(Cause_specific_2000.2021_10.14yf_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2007, 2028), breaks = c(2007, 2015, 2021)) +
  scale_y_continuous(limits = c(0, 25)) +
  geom_text_repel(data = Cause_specific_2000.2021_10.14yf_top5 %>% filter(Year == "2021"), aes(label = Cause, y = `Value Numeric`), x = 2021, show.legend = F, fontface = "bold", nudge_x = 5, size = 3, min.segment.length =.2, direction="y", hjust=-0.5, vjust=.5 ) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specific_2007.2021_10.14yf_top5.png", width=9, height=5, unit="in")

# 15-19y Females

Cause_specific_2000.2021_15.19yf_top5 <- adol_cod_region %>%
  mutate("year"=as.numeric(Year)) |> 
  filter(Measure=="Death Rate (per 100,000)") |> 
  filter(!is.na(`Datasource short`)) |> 
  filter(age == "15-19") %>%
  filter(region == "Global") %>%
  filter(sex == "Female") %>%
  group_by(year) %>%
  arrange(-`Value Numeric`) %>%
  mutate(top5 = ifelse((row_number() <= 5), "top5", 0))

top5causes <- Cause_specific_2000.2021_15.19yf_top5$Cause[Cause_specific_2000.2021_15.19yf_top5$top5 == "top5" & (Cause_specific_2000.2021_15.19yf_top5$year == 2007 | Cause_specific_2000.2021_15.19yf_top5$year == 2021)]

Cause_specific_2000.2021_15.19yf_top5 <- Cause_specific_2000.2021_15.19yf_top5 %>% filter(Cause %in% top5causes)

ggplot(Cause_specific_2000.2021_15.19yf_top5 %>% mutate(causename.group = reorder_within(Cause, `Value Numeric`, causegroup))) +
  geom_line(aes(x = as.numeric(Year), y = `Value Numeric`, group = causename.group, colour = as.character(causegroup)), size = 2) +
  theme_classic() +
  theme(legend.position = "bottom", text = element_text(size = 16)) +
  scale_colour_manual(values = c("#1b9e77", "#d95f02", "#7570b3"), labels = c("Communicable, maternal, perinatal,\nnutritional conditions", "Injuries", "NCDs"), breaks = c(1, 3, 2)) +
  scale_x_continuous(limits = c(2007, 2028), breaks = c(2007, 2015, 2021)) +
  scale_y_continuous(limits = c(0, 25)) +
  geom_text_repel(data = Cause_specific_2000.2021_15.19yf_top5 %>% filter(Year == "2021"), aes(label = Cause, y = `Value Numeric`), x = 2021, show.legend = F, fontface = "bold", nudge_x = 5, size = 3, min.segment.length =.2, direction="y", hjust=-0.5, vjust=.5 ) +
  labs(y = "Deaths per 100,000 population", x = NULL, fill = NULL, colour = NULL)

# ggsave("figures/Cause_specific_2007.2021_15.19yf_top5.png", width=9, height=5, unit="in")


# income as colour

ggplot(adol_mort_income |> mutate(Year=as.numeric(Year), "income"=`World bank income group`, "age"=`Age group`) |> filter(!is.na(`Datasource short`)) |> filter(Measure=="Death Rate (per 100,000)")  %>% filter(!is.na(income)) |> filter(income!="Global") %>% filter(age == "10-14" | age == "15-19") %>% filter(Sex != "Both sexes") %>% mutate(age.income = reorder_within(income, Year, age, sep = ", ")) %>% mutate(label = if_else(Year == max(Year), as.character(income), NA_character_)), aes(x = Year, y = `Value Numeric`, fill = age.income)) +
  geom_line(aes(y = `Value Numeric`, colour = income), size = 2) +
  scale_x_continuous(breaks = c(2000, 2005, 2010, 2015, 2021), limits = c(2000, 2030)) +
  scale_y_continuous(breaks = seq(from = 0, to = 350, by = 50), limits = c(0, 350), expand = c(0, 0)) +
  scale_color_viridis_d(option = "cividis") +
  theme_classic() +
  theme(legend.position = "none", text = element_text(size = 18)) +
  labs(x = NULL, y = "Deaths per 100,000 population", fill = NULL, colour = NULL) +
  geom_text_repel(aes(label = label), nudge_x = 2, direction = "y", hjust = "left", size = 5.5)+
  facet_nested(rows = vars(age), cols = vars(Sex))

# ggsave("figures/mortrate_trends_income21.png", width=19, height=8, unit="in")

```
